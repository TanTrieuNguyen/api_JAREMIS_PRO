<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JAREMIS - AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --sidebar-width: 260px;
            --bg-color: #0d1117;
            --sidebar-bg: #161b22;
            --chat-bg: #010409;
            --input-bg: #161b22;
            --bot-bubble-bg: #161b22;
            --user-bubble-bg: #003666;
            --text-color: #c9d1d9;
            --text-secondary-color: #8b949e;
            --border-color: #30363d;
            --accent-color: #2f81f7;
            --error-color: #f85149;
            --success-color: #238636;
            --who-bg: #212013;
            --mic-red: #ff4d4d;

            --auth-offset-top: 12px;
            --auth-offset-height: 48px; /* chiều cao ước lượng vùng auth (để chừa khoảng trống) */
            --mobile-header-height: 56px; /* chiều cao header mobile (nếu hiện) */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Hide mobile-only toggles on desktop */
        .mobile-header { display: none; }
        #history-drawer-toggle { display: none; }

        .chat-container { display: flex; width: 100%; height: 100%; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 200px;
            max-width: 500px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 16px;
            transition: width 0.1s ease-out;
            flex-shrink: 0;
        }
        .resizer { width: 5px; cursor: col-resize; background-color: transparent; flex-shrink: 0; position: relative; z-index: 10; }
        .resizer:hover { background-color: var(--accent-color); }

        .sidebar-header {
          display:flex;
          flex-direction:column;
          align-items:stretch;
          gap:8px;
          margin-bottom:12px;
        }

        .new-chat-btn {
            display:flex; align-items:center; gap:8px; width:100%; padding:10px; background:transparent; color:var(--text-color);
            border:1px solid var(--border-color); border-radius:6px; font-size:14px; cursor:pointer;
        }
        .new-chat-btn:hover { background-color:#2c313a; }

        .history { flex-grow:1; overflow-y:auto; margin-top:10px; }
        .history h3 { font-size:12px; color:var(--text-secondary-color); margin-bottom:8px; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; }
        .history ul { list-style:none; padding:0; display:flex; flex-direction:column; gap:6px; }
        .history li { padding:8px; border-radius:6px; cursor:pointer; color:var(--text-color); background:transparent; border:1px solid transparent; font-size:13px; }
        .history li:hover { background:#111720; border-color:var(--border-color); }
        .sidebar-footer { font-size:12px; color:var(--text-secondary-color); text-align:center; margin-top:10px; }

        /* Chat area */
        .chat-area {
            position: relative; /* Đảm bảo lớp nền phủ đúng */
            flex-grow:1; display:flex; flex-direction:column; background-color:var(--chat-bg); border-left:1px solid var(--border-color); /* position:relative; */
        }
        .chat-messages {
          flex-grow:1;
          padding:24px;
          overflow-y:auto;
          display:flex;
          flex-direction:column;
          gap:20px;
          background: transparent;          /* đảm bảo không che nền */
          scrollbar-color: var(--accent-color) transparent; /* Firefox */
          scrollbar-width: thin;
        }

        /* Scrollbar WebKit (Chrome / Edge) */
        .chat-messages::-webkit-scrollbar {
          width: 10px;
        }
        .chat-messages::-webkit-scrollbar-track {
          background: transparent;          /* trong suốt để lộ nền & canvas tuyết */
        }
        .chat-messages::-webkit-scrollbar-thumb {
          background: linear-gradient(180deg, rgba(47,129,247,0.55), rgba(47,129,247,0.25));
          border-radius: 20px;
          border: 2px solid rgba(0,0,0,0);  /* tạo khoảng cách thị giác */
          min-height: 40px;
          transition: background .25s;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(180deg, rgba(47,129,247,0.85), rgba(47,129,247,0.45));
        }
        .chat-messages::-webkit-scrollbar-corner {
          background: transparent;
        }
        /* (Tuỳ chọn) Ẩn hẳn khi không hover:
        .chat-messages::-webkit-scrollbar { width: 0; }
        */

        .chat-bubble { max-width:80%; padding:16px; border-radius:12px; line-height:1.6; word-wrap:break-word; }
        .bot-bubble { background-color:var(--bot-bubble-bg); align-self:flex-start; border:1px solid var(--border-color); }
        .user-bubble { background-color:var(--user-bubble-bg); align-self:flex-end; color:#fff; }

        .user-bubble-content p { margin-bottom:12px; }
        .user-images-preview { display:flex; gap:10px; flex-wrap:wrap; }
        .user-images-preview img { width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid var(--border-color); }

        .chat-input-area { padding:16px 24px; border-top:1px solid var(--border-color); display:flex; flex-direction:column; gap:8px; }
        .input-wrapper { position:relative; display:flex; align-items:center; background-color:var(--input-bg); border:1px solid var(--border-color); border-radius:8px; padding:8px; gap:8px; }

        #chat-input { flex-grow:1; background:transparent; border:none; color:var(--text-color); font-size:16px; padding:8px; resize:none; max-height:200px; overflow-y:auto; }
        #chat-input:focus { outline:none; }

        .input-actions { display:flex; align-items:center; gap:8px; }
        .action-btn {
            background:none; border:none; color:var(--text-secondary-color); font-size:20px; cursor:pointer; width:40px; height:40px; border-radius:6px;
            display:flex; align-items:center; justify-content:center;
        }
        .action-btn:hover { background-color:#2c313a; color:var(--text-color); }
        #send-btn { background-color:var(--accent-color); color:white; border-radius:6px; width:44px; height:40px; display:flex; align-items:center; justify-content:center; }
        #send-btn:disabled { background-color:#30363d; cursor:not-allowed; }

        #image-preview-container { display:flex; gap:10px; margin-top:10px; padding:0 8px; }
        .preview-item { position:relative; }
        .preview-item img { width:60px; height:60px; object-fit:cover; border-radius:6px; }
        .remove-btn { position:absolute; top:-5px; right:-5px; background:var(--error-color); color:white; border:none; width:20px; height:20px; border-radius:50%; cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center; }

        /* Analysis steps */
        .analysis-steps { display:flex; flex-direction:column; gap:12px; }
        .step-item { display:flex; align-items:center; gap:12px; font-size:14px; transition:color 0.3s ease; }
        .step-item .icon { width:20px; text-align:center; }
        .step-item.pending { color:var(--text-secondary-color); }
        .step-item.active { color:var(--text-color); font-weight:600; }
        .step-item.completed { color:var(--success-color); }
        .fa-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }

        /* Result */
        .error-message { color:var(--error-color); }
        .confidence-meter { background:#2c313a; border-radius:20px; height:24px; margin:16px 0; overflow:hidden; position:relative; }
        .confidence-bar { background:var(--success-color); height:100%; display:flex; align-items:center; padding-left:12px; color:white; font-weight:bold; font-size:12px; transition: width 0.5s ease; }

        .disease-list { margin:20px 0; display:flex; flex-direction:column; gap:15px; }
        .disease-item { border-left:3px solid var(--accent-color); padding-left:15px; }
        .probability-bar { height:8px; background:#30363d; border-radius:10px; overflow:hidden; margin-top:8px; }
        .probability-fill { height:100%; background:var(--accent-color); transition:width 0.5s ease; }

        .diagnosis-details h2, .diagnosis-details h3 { border-bottom:1px solid var(--border-color); padding-bottom:8px; margin:20px 0 10px 0; font-size:1.1em; }
        .references-section { margin-top:25px; padding:15px; background:rgba(47,129,247,0.1); border-radius:8px; }
        .reference-item { margin-top:10px; }
        .reference-item a { color:var(--accent-color); text-decoration:none; }
        .reference-item a:hover { text-decoration:underline; }
        .reference-source { font-size:0.8em; color:var(--text-secondary-color); margin-top:4px; }

        .warning { margin-top:20px; padding:12px; background:var(--who-bg); border-left:4px solid #f1e05a; color:#d4c873; font-size:14px; border-radius:4px; }
        .warning strong { color:#f1e05a; }

        /* Think button style */
        #think-btn { background:none; border:1px solid var(--border-color); border-radius:6px; padding:6px 8px; color:var(--text-secondary-color); cursor:pointer; width:auto; height:40px; display:flex; align-items:center; justify-content:center; }
        #think-btn.active { background: linear-gradient(90deg, rgba(47,129,247,0.12), rgba(47,129,247,0.06)); color:var(--text-color); border-color: rgba(47,129,247,0.6); }
        #model-status { font-size:12px; color:var(--text-secondary-color); margin-left:8px; align-self:center; }

        /* Mic button style */
        #mic-btn { background:none; border:1px solid var(--border-color); border-radius:6px; padding:6px 8px; color:var(--text-secondary-color); cursor:pointer; width:auto; height:40px; display:flex; align-items:center; justify-content:center; }
        #mic-btn.recording { background: rgba(255,77,77,0.12); color: var(--text-color); border-color: rgba(255,77,77,0.5); box-shadow: 0 0 8px rgba(255,77,77,0.12); }
        #mic-indicator {
            width:8px; height:8px; border-radius:50%; background:var(--mic-red); margin-left:6px; display:inline-block; opacity:0;
            box-shadow: 0 0 6px rgba(255,77,77,0.8);
            animation: pulse 1.2s infinite;
        }
        #mic-btn.recording #mic-indicator { opacity:1; }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        /* Auth UI (top-right) */
        .auth-controls {
            position: fixed !important;
            top: var(--auth-offset-top) !important;
            right: 18px !important;
            bottom: auto !important;
            display: flex;
            gap: 8px;
            align-items: center;
            z-index: 120; /* cao hơn header & bong bóng */
            flex-direction: row !important;
        }
        @media (max-width:600px) {
            .auth-controls { right: 10px; }
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal {
            background: #0b1116;
            border: 1px solid var(--border-color);
            padding: 18px;
            border-radius: 10px;
            width: 360px;
            max-width: 92%;
            color: var(--text-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .modal h3 { margin-bottom: 10px; font-size: 18px; }
        .tabs { display:flex; gap:8px; margin-bottom:12px; }
        .tab { padding:8px 12px; border-radius:6px; cursor:pointer; background:transparent; color:var(--text-secondary-color); border:1px solid transparent; }
        .tab.active { background: rgba(47,129,247,0.12); color:var(--text-color); border-color: rgba(47,129,247,0.2); }
        .form-row { margin-bottom:10px; display:flex; flex-direction:column; gap:6px; }
        .form-row input { background: #071018; border: 1px solid var(--border-color); color: var(--text-color); padding:8px 10px; border-radius:6px; }
        .form-actions { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; }
        .btn-primary { background: var(--accent-color); color: #fff; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
        .btn-ghost { background:transparent; color:var(--text-secondary-color); border:1px solid var(--border-color); padding:8px 10px; border-radius:6px; cursor:pointer; }

        .small-muted { font-size:12px; color:var(--text-secondary-color); margin-top:8px; }

        /* Base (desktop) – giữ hàng ngang cho tool buttons */
        .tool-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toggle-tools-btn {
            display: none; /* Chỉ hiện trên mobile */
        }

        /* Auth buttons styling */
        .auth-controls .auth-btn {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            line-height: 1.2;
            backdrop-filter: blur(4px);
            transition: background .18s, border-color .18s, color .18s;
        }
        .auth-controls .auth-btn:hover {
            background: rgba(47,129,247,0.16);
            border-color: var(--accent-color);
            color: #fff;
        }
        .auth-controls .auth-btn:active {
            background: rgba(47,129,247,0.28);
        }

        /* small responsive */
        @media (max-width: 900px) {
            .sidebar { display:none; }
            .resizer { display:none; }
            .auth-controls { right: 8px; top: 8px; }
        }

        /* Mobile-specific overrides */
        @media (max-width: 600px) {
            /* layout becomes column for small screens */
            .chat-container { flex-direction:column; }
            .mobile-header { display:flex; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid var(--border-color); background:var(--chat-bg); position:sticky; top:0; z-index:70; }
            .mobile-header .title { color:var(--text-color); font-weight:600; font-size:16px; flex:1; text-align:center; }
            .hamburger { background:transparent; border:1px solid var(--border-color); color:var(--text-secondary-color); width:44px; height:44px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; }
            /* Sidebar becomes overlay (hidden by default) */
            .sidebar { display:flex; position:fixed; top:0; left:0; bottom:0; width:78%; max-width:360px; transform:translateX(-120%); transition: transform 0.22s ease; z-index:80; box-shadow:6px 0 30px rgba(0,0,0,0.6); }
            .sidebar.mobile-open { transform:translateX(0); }
            .sidebar-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:75; display:none; }
            .sidebar-backdrop.show { display:block; }
            /* hide resizer (not needed) */
            .resizer { display:none; }
            /* Chat area sizing */
            .chat-area { flex:1 1 auto; min-height: calc(100vh - 56px); }
            .chat-messages { padding: 12px; padding-bottom:160px; overflow-y:auto; }
            /* Fix input to bottom and respect safe-area */
            .chat-input-area { position:fixed; left:0; right:0; bottom:env(safe-area-inset-bottom, 0); padding:8px 10px; background:linear-gradient(180deg, rgba(1,4,9,0.98), rgba(1,4,9,1)); z-index:70; border-top:1px solid var(--border-color); }
            .input-wrapper { padding:6px; gap:6px; }
            #chat-input { font-size:15px; padding:8px; max-height:120px; }
            .input-actions .action-btn { width:40px; height:40px; font-size:16px; }
            #send-btn { width:44px; height:40px; border-radius:8px; }
            /* Adjust auth controls so they don't overlap mobile input */
            .auth-controls { position:fixed; right:10px; bottom:110px; top:auto; z-index:69; display:flex; flex-direction:column; gap:8px; }
            /* Slightly reduce bubble max-width for narrow screens */
            .chat-bubble { max-width:94%; }
        }

        /* Even smaller devices: compact spacing & font sizes */
        @media (max-width: 420px) {
            .mobile-header { padding:6px 8px; }
            .mobile-header .title { font-size:14px; }
            .new-chat-btn span { display:none; } /* icon only to save space */
            .sidebar { width:84%; max-width:300px; }
            .chat-messages { padding:10px; padding-bottom:150px; gap:12px; }
            .input-actions .action-btn { width:38px; height:38px; font-size:15px; }
            #chat-input { font-size:14px; }
        }

        @media (max-width: 360px) {
            .mobile-header .title { font-size:13px; }
            .hamburger { width:40px; height:40px; }
            .auth-controls { right:8px; bottom:120px; }
            .chat-input-area { padding:8px; }
            .chat-messages { padding-bottom:140px; }
        }

        /* Compact tools (mobile) */
        @media (max-width:600px) {
            .input-wrapper {
                position: relative;
            }
            .toggle-tools-btn {
                display:flex !important;
            }
            .tool-buttons {
                display:flex;
                align-items:center;
                gap:6px;
                transition:opacity .18s ease, transform .18s ease;
            }
            .tool-buttons.collapsed {
                opacity:0;
                pointer-events:none;
                transform:translateY(4px);
                position:absolute;
                left:8px;
                right:60px;
                bottom:100%;
                /* hidden */
            }
            .mobile-tools-active .tool-buttons {
                opacity:1;
                transform:translateY(0);
                position:absolute;
                left:8px;
                right:60px;
                bottom:100%;
                background:rgba(22,27,34,0.95);
                padding:6px 8px;
                border:1px solid var(--border-color);
                border-radius:10px;
                box-shadow:0 4px 18px rgba(0,0,0,0.55);
                z-index:90;
            }
            .tool-buttons .action-btn {
                width:38px;
                height:38px;
                font-size:16px;
            }
            .toggle-tools-btn {
                display:flex;
                background:none;
                border:1px solid var(--border-color);
                width:40px;
                height:40px;
                border-radius:8px;
                align-items:center;
                justify-content:center;
                color:var(--text-secondary-color);
                cursor:pointer;
            }
            .toggle-tools-btn.active {
                background:rgba(47,129,247,0.15);
                color:var(--text-color);
                border-color:var(--accent-color);
            }
            /* Khi bàn phím mở (class keyboard-open gắn vào body) -> ép thu gọn */
            body.keyboard-open .tool-buttons:not(.force-open) {
                opacity:0;
                pointer-events:none;
                transform:translateY(4px);
            }
        }

        /* Nút toggle lịch sử trên mobile */
        #history-toggle-btn {
            display:none;
            background:transparent;
            border:1px solid var(--border-color);
            color:var(--text-secondary-color);
            padding:6px 10px;
            border-radius:8px;
            font-size:13px;
            cursor:pointer;
        }
        #history-toggle-btn.active {
            background:rgba(47,129,247,0.15);
            color:var(--text-color);
            border-color:var(--accent-color);
        }
        @media (max-width:600px) {
          #history-toggle-btn { display:inline-flex; align-items:center; gap:6px; }
        }

        /* Dual pane (landscape + đủ rộng) */
        @media (max-width:900px) and (orientation:landscape) and (min-width:640px) {
          body.dual-pane .sidebar {
              position:relative;
              transform:translateX(0) !important;
              width:230px;
              box-shadow:none;
          }
          body.dual-pane .sidebar-backdrop { display:none !important; }
          body.dual-pane .chat-area { min-height:100vh; }
          body.dual-pane #mobile-header { padding-right:0; }
          body.dual-pane #history-toggle-btn { display:none; }
        }
        /* Hiệu ứng vuốt (gợi ý) – chỉ chiều ngang */
        .sidebar {
           touch-action: pan-y;
        }

        @media (max-width:600px) {
          .history-drawer-toggle {
              position:fixed;
              top:50%;
              left:4px;
              transform:translateY(-50%);
              z-index:90;
              width:34px;
              height:52px;
              background:rgba(22,27,34,0.88);
              border:1px solid var(--border-color);
              border-left:none;
              border-radius:0 10px 10px 0;
              display:flex;
              align-items:center;
              justify-content:center;
              color:var(--text-secondary-color);
              cursor:pointer;
              backdrop-filter:blur(4px);
              transition:background .18s, color .18s;
          }
          .history-drawer-toggle:hover { background:rgba(47,129,247,0.15); color:var(--text-color); }
          .history-drawer-toggle.open { left: calc(78% - 18px); border-left:1px solid var(--border-color); border-radius:10px 0 0 10px; }
        }

        /* Phóng to nút history ≡ */
.history-top-toggle .history-icon,
.history-drawer-toggle .history-icon {
    font-size: 26px; /* tăng gấp ~2 lần so với font-awesome mặc định 14–16px */
    line-height: 1;
    display:inline-block;
    transform: translateY(-1px);
    letter-spacing:2px;
    font-weight:600;
}
.history-top-toggle,
.history-drawer-toggle {
    width:46px !important;
    height:46px !important;
}

/* Compact white triple bars button */
.history-top-toggle,
.history-drawer-toggle {
    background: var(--chat-bg) !important; /* trùng nền chính */
    border: 1px solid var(--border-color);
    box-shadow: 0 0 0 0 transparent;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
}
.history-top-toggle:hover,
.history-drawer-toggle:hover {
    border-color: var(--accent-color);
    background: var(--chat-bg);
}
.history-top-toggle .bars,
.history-drawer-toggle .bars {
    display:flex;
    flex-direction:column;
    gap:5px;
    width:26px;
    height:22px;
    align-items:flex-start;
    justify-content:center;
}
.history-top-toggle .bar,
.history-drawer-toggle .bar {
    display:block;
    height:2px;              /* thon hơn */
    width:22px;
    background:#fff;          /* màu trắng */
    border-radius:2px;
    transition:width .25s ease, background .25s;
}
.history-top-toggle .bar:nth-child(2),
.history-drawer-toggle .bar:nth-child(2){
    width:18px;               /* giữa ngắn hơn nhẹ */
}
.history-top-toggle .bar:nth-child(3),
.history-drawer-toggle .bar:nth-child(3){
    width:14px;               /* dưới ngắn hơn nữa */
}
.history-top-toggle.open .bar,
.history-drawer-toggle.open .bar {
    background: var(--accent-color);
    width:22px;               /* khi mở đồng nhất chiều dài */
}
.history-top-toggle.open .bar:nth-child(2){
    width:22px;
}
.history-top-toggle.open .bar:nth-child(3){
    width:22px;
}
/* Ẩn style cũ của .history-icon nếu còn */
.history-icon { display:none !important; }

/* Override: loại viền trắng mờ nút history */
.history-top-toggle,
.history-drawer-toggle {
    border: 1px solid var(--chat-bg) !important; /* trùng nền -> coi như mất viền */
}

.history-top-toggle:hover,
.history-drawer-toggle:hover,
.history-top-toggle.open,
.history-drawer-toggle.open {
    border: 1px solid var(--border-color) !important; /* chỉ hiện viền khi hover / mở */
}

/* (Tuỳ chọn) nếu muốn bỏ hẳn viền luôn:
.history-top-toggle,
.history-drawer-toggle { border:0 !important; }
.history-top-toggle:hover,
.history-drawer-toggle:hover { border:0 !important; }
*/
/* Thêm ngay sau <body> */
.bg-animation {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 0; /* nằm dưới các chat bubble */
}
.particle {
    position: absolute;
    width: 4px; height: 4px;
    background: #8b5cf6;
    border-radius: 50%;
    animation: float 20s infinite linear;
    box-shadow: 0 0 10px #8b5cf6;
}
.particle:nth-child(1) { left: 20%; animation-delay: 0s; animation-duration: 15s; }
.particle:nth-child(2) { left: 40%; animation-delay: 5s; animation-duration: 20s; background: #7c3aed; box-shadow: 0 0 10px #7c3aed; }
.particle:nth-child(3) { left: 60%; animation-delay: 10s; animation-duration: 25s; background: #a78bfa; box-shadow: 0 0 10px #a78bfa; }
.particle:nth-child(4) { left: 80%; animation-delay: 15s; animation-duration: 18s; }
.particle:nth-child(5) { left: 10%; animation-delay: 8s; animation-duration: 22s; background: #7c3aed; box-shadow: 0 0 10px #7c3aed; }
@keyframes float {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
}

/* Snowfall animation */
.particle.snowflake {
    border-radius: 50%;
    box-shadow: 0 0 8px #fff;
    position: absolute;
    animation: snow-fall linear infinite;
}
@keyframes snow-fall {
    0% { transform: translateY(-10vh); opacity: 0.8; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(110vh); opacity: 0.2; }
}
#snow-canvas { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:0; }
.chat-messages, .chat-bubble { position:relative; z-index:2; } /* đảm bảo tuyết không đè lên */
    </style>
    <style>
      @media (max-width:600px) {
        /* Popup tool panel */
        #tool-buttons {
          position:absolute;
          bottom:100%;           /* nằm trên input */
          right:0;
          left:auto;
          display:flex;
          flex-direction:column; /* xếp dọc */
          gap:10px;
          padding:10px 12px;
          background:rgba(13,17,23,0.95);
          border:1px solid var(--border-color);
          border-radius:14px;
          box-shadow:0 8px 28px -4px rgba(0,0,0,0.55);
          backdrop-filter:blur(6px);
          transform-origin: bottom right;
          transition: opacity .18s ease, transform .18s ease;
          z-index:120;
          width:66px; /* đủ cho icon vuông */
        }
        /* Nếu muốn dạng 2 cột (bỏ comment):
        #tool-buttons {
           width:134px;
           flex-wrap:wrap;
           flex-direction:row;
        }
        #tool-buttons .action-btn { flex:0 0 calc(50% - 6px); }
        */

        #tool-buttons .action-btn {
          width:52px;
          height:52px;
          font-size:20px;
          border:1px solid var(--border-color);
          border-radius:12px;
          background:#161b22;
          transition:background .18s, border-color .18s, color .18s;
        }
        #tool-buttons .action-btn:hover {
          background:#1f2731;
          border-color:var(--accent-color);
          color:var(--text-color);
        }

        #tool-buttons.collapsed {
          opacity:0;
          transform:translateY(10px) scale(.92);
          pointer-events:none;
        }
        #tool-buttons:not(.collapsed) {
          opacity:1;
          transform:translateY(0) scale(1);
        }

        /* Căn nút + sát bên phải để panel mở lên ngay trên */
        .input-actions {
          position:relative;
        }
        #toggle-tools-btn {
          position:relative;
          z-index:121; /* nằm trên panel */
        }
      }
    </style>
    <style>
/* === 3D Tilt Effect (buttons) === */
.tilt-3d{
  position:relative;
  background:linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
  box-shadow:0 4px 10px -2px rgba(0,0,0,0.45), 0 0 0 1px var(--border-color);
  transform-style:preserve-3d;
  will-change:transform;
  transition:transform .28s cubic-bezier(.25,.8,.25,1), box-shadow .35s;
  border-radius:8px;
}
.tilt-3d:hover{
  box-shadow:
    0 6px 18px -4px rgba(0,0,0,0.55),
    0 0 0 1px rgba(47,129,247,0.55),
    0 0 14px -2px rgba(47,129,247,0.55);
}
.tilt-3d::after{
  content:'';
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at var(--mx,50%) var(--my,50%),
      rgba(255,255,255,0.28),
      rgba(255,255,255,0.05) 38%,
      rgba(255,255,255,0) 70%);
  opacity:var(--glow-o,0);
  mix-blend-mode:screen;
  pointer-events:none;
  transition:opacity .25s;
  border-radius:inherit;
}
.tilt-3d:active{
  transition:transform .08s;
  transform:perspective(800px) rotateX(0deg) rotateY(0deg) translateZ(0) scale(.95);
}
</style>
<!-- Ensure the drawer toggle appears on mobile only -->
<style>
  @media (max-width:600px){
    #history-drawer-toggle { display: inline-flex; }
    .mobile-header { display: flex; }
  }
</style>
</head>
<body>
    <div class="bg-animation">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    <div class="chat-container">
        <!-- (XÓA nút cũ ở đây nếu còn) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="startNewConversation()" title="Cuộc trò chuyện mới (Ctrl+Shift+X)">
                    <i class="fas fa-plus"></i>
                    <span>Cuộc trò chuyện mới</span>
                </button>
                <button id="find-btn" class="new-chat-btn" onclick="openFindModal()" title="Tìm trong cuộc trò chuyện (Ctrl+Shift+F)">
                  <i class="fas fa-search"></i>
                  <span>Tìm kiếm</span>
                  <span style="margin-left:auto;font-size:11px;opacity:.6;">Ctrl+Shift+F</span>
                </button>
            </div>
            <nav class="history">
                <h3>
                    Lịch sử
                    <span id="history-actions" style="font-size:12px;"></span>
                </h3>
                <ul id="history-list"></ul>
            </nav>
            <div class="sidebar-footer">Made with ❤️ by TT1403 & Ant.</div>
        </aside>

        <div class="resizer" id="resizer"></div>
        <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
 
         <main class="chat-area" id="chat-area">
            <canvas id="snow-canvas"></canvas>
            <!-- Nút toggle lịch sử mới (mobile) -->
            <button id="history-drawer-toggle" class="history-top-toggle" aria-label="Mở lịch sử">
                <span class="bars" aria-hidden="true">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </span>
            </button>
            <!-- Mobile header (shown on small screens) -->
            <div class="mobile-header" id="mobile-header">
                <button class="hamburger" id="mobile-menu-btn" aria-label="Mở menu"><i class="fas fa-bars"></i></button>
                <div class="title">JAREMIS</div>
                <button id="history-toggle-btn" aria-label="Xem lịch sử" onclick="toggleHistoryMode()">
                    <i class="fas fa-clock-rotate-left"></i><span style="margin-left:4px;">Lịch sử</span>
                </button>
            </div>
             <!-- Auth controls (top-right) -->
             <div class="auth-controls" id="auth-controls">
                 <!-- Will be populated by JS -->
             </div>
 
            <div class="chat-messages" id="chat-messages">
                <div style="height:12px;"></div> <!-- spacer tránh trùng nút auth -->
                <div class="chat-bubble bot-bubble">
                    <strong>Chào bạn 👋 Mình là JAREMIS.</strong>
                    <p style="margin-top:8px; color:var(--text-secondary-color);">
                        Hãy nhập các dấu hiệu, hỏi chuyện, hoặc bật chế độ <strong>Diagnose</strong> để yêu cầu chẩn đoán y khoa.
                    </p>
                </div>
            </div>

            <div class="chat-input-area">
                <div id="image-preview-container"></div>
                <div class="input-wrapper">
                    <textarea id="chat-input" placeholder="Nhập tin nhắn hoặc tải lên hình ảnh..." rows="1" oninput="autoResize(this)"></textarea>

                    <div class="input-actions">
                        <button id="toggle-tools-btn" class="toggle-tools-btn" title="Mở công cụ" onclick="toggleToolTray(event)">
                            <i class="fas fa-plus"></i>
                        </button>

                        <div id="tool-buttons" class="tool-buttons collapsed">
                            <button class="action-btn" id="attach-btn" onclick="document.getElementById('images').click()" title="Đính kèm ảnh (Ctrl+Shift+U)">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button id="mode-btn" class="action-btn" title="Chế độ: Chat (Ctrl+Shift+K)" onclick="toggleMode(event)">
                                <i class="fas fa-comments"></i>
                            </button>
                            <button id="mic-btn" class="action-btn" title="Ghi giọng nói (Ctrl+M). Nhấn để bắt đầu/dừng" onclick="toggleMic(event)">
                                <i class="fas fa-microphone"></i>
                                <span id="mic-indicator"></span>
                            </button>
                            <button id="think-btn" class="action-btn" title="Bật Think (Ctrl+Shift+Y)" onclick="toggleThink(event)">
                                <i class="fas fa-brain"></i>
                            </button>
                        </div>

                        <button id="send-btn" class="action-btn" onclick="submitData()" title="Gửi (Enter)">
                            <i class="fas fa-paper-plane"></i>
                        </button>

                        <input type="file" id="images" multiple hidden onchange="handleImageUpload(event)">
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div id="model-status">Model: JAREMIS 1.5</div>
                    <div style="font-size:12px; color:var(--text-secondary-color);">Trạng thái: Rảnh</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Auth modal -->
    <div class="modal-backdrop" id="auth-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
            <h3 id="auth-title">Đăng nhập / Đăng ký</h3>

            <div class="tabs">
                <div class="tab active" id="tab-login" onclick="showTab('login')">Đăng nhập</div>
                <div class="tab" id="tab-register" onclick="showTab('register')">Đăng ký</div>
            </div>

            <!-- Login form -->
            <div id="form-login">
                <div class="form-row">
                    <label>Username hoặc Email</label>
                    <input id="login-username" placeholder="Tên đăng nhập hoặc email">
                </div>
                <div class="form-row">
                    <label>Mật khẩu</label>
                    <input id="login-password" type="password" placeholder="Mật khẩu">
                </div>
                <div class="form-row">
                    <button class="btn-primary" onclick="submitLogin()">Đăng nhập</button>
                    <button class="btn-primary" onclick="loginWithGoogle()" style="background-color: #4285F4;"> <i class="fab fa-google"></i> Google</button>
                    <button class="btn-primary" onclick="loginWithFacebook()" style="background-color: #3b5998;"> <i class="fab fa-facebook"></i> Facebook</button>
                </div>

                <div class="form-actions">
                    <button class="btn-ghost" onclick="closeAuthModal()">Hủy</button>
                </div>
                <div class="small-muted">Bạn chưa có tài khoản? Chuyển sang tab "Đăng ký".</div>
            </div>

            <!-- Register form -->
            <div id="form-register" style="display:none">
                <div class="form-row">
                    <label>Tên đăng nhập</label>
                    <input id="reg-username" placeholder="Tên đăng nhập">
                </div>
                <div class="form-row">
                    <label>Email</label>
                    <input id="reg-email" placeholder="email@example.com" type="email">
                </div>
                <div class="form-row">
                    <label>Mật khẩu</label>
                    <input id="reg-password" type="password" placeholder="Mật khẩu (ít nhất 6 ký tự)">
                </div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="submitRegister()">Đăng ký</button>
                    <button class="btn-ghost" onclick="closeAuthModal()">Hủy</button>
                </div>
                <div class="small-muted">Bằng cách đăng ký, bạn đồng ý thử nghiệm tính năng.</div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="find-backdrop" style="display:none;">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="find-title">
        <h3 id="find-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>Tìm kiếm</span>
          <button class="btn-ghost" style="padding:4px 10px;font-size:14px;" onclick="closeFindModal()" title="Đóng (Esc)">&times;</button>
        </h3>
        <div class="form-row" style="margin-bottom:10px;">
          <input id="find-query" placeholder="Nhập từ khóa... (Enter=Tiếp, Shift+Enter=Trước)" style="background:#071018;">
        </div>
        <div class="form-row" style="flex-direction:row;align-items:center;gap:14px;margin-bottom:12px;">
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;">
            <input type="checkbox" id="find-case"> Phân biệt hoa/thường
          </label>
          <div id="find-count" style="margin-left:auto;font-size:12px;color:var(--text-secondary-color);">0 / 0</div>
        </div>
        <div class="form-actions" style="justify-content:flex-start;gap:8px;">
          <button class="btn-ghost" onclick="findPrev()" title="Trước (Shift+Enter)">Trước</button>
          <button class="btn-primary" onclick="findNext()" title="Tiếp (Enter)">Tiếp</button>
          <button class="btn-ghost" onclick="clearFindHighlights()" title="Xóa highlight">Xóa</button>
          <button class="btn-ghost" onclick="closeFindModal()" title="Đóng (Esc)">Đóng</button>
        </div>
        <div class="small-muted" style="margin-top:10px;">
          Ctrl+F mở • Enter=Tiếp • Shift+Enter=Trước • Esc=Đóng
        </div>
      </div>
    </div>

    <style>
      /* Animated AI Reply component styles */
      .ai-reply { white-space: pre-wrap; line-height: 1.6; }
      .ai-reply .seg { opacity: 0; will-change: opacity, transform; }
      .ai-reply .seg-inline { display: inline; transform: translateY(2px); }
      .ai-reply .seg-line { display: block; transform: translateY(4px); margin-bottom: 2px; }
      .ai-reply .fade-in { animation: aiFade 180ms ease-out forwards; }
      @keyframes aiFade {
        from { opacity: 0; transform: translateY(4px); }
        to   { opacity: 1; transform: translateY(0); }
      }
    </style>
    <!-- Vue 3 for Animated AI Reply component (CDN) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
    // AnimatedAIReply Vue component: typing/progressive reveal by char/word/line
    (function(){
      if (window._animated_ai_reply_installed) return; window._animated_ai_reply_installed = true;
      const { createApp, ref, watch, onMounted, onBeforeUnmount, computed } = window.Vue || {};
      if (!createApp) {
        console.warn('Vue 3 not available – AnimatedAIReply will not be registered.');
        return;
      }

      function splitSegments(text, mode){
        if (!text) return [];
        if (mode === 'char') return Array.from(text);
        if (mode === 'word') return text.split(/(\s+)/).filter(Boolean);
        // line
        return String(text).split(/\r?\n/);
      }

      const AnimatedAIReply = {
        name: 'AnimatedAIReply',
        props: {
          text: { type: String, required: true },
          mode: { type: String, default: 'word', validator: v => ['char','word','line'].includes(v) },
          charDelay: { type: Number, default: 18 },
          wordDelay: { type: Number, default: 50 },
          lineDelay: { type: Number, default: 220 },
          startDelay: { type: Number, default: 0 },
          className: { type: String, default: '' }
        },
        emits: ['complete','update:count'],
        setup(props, { emit }){
          const timer = ref(null);
          const startTimer = ref(null);
          const count = ref(0);
          const segments = computed(()=> splitSegments(props.text, props.mode));
          const delay = computed(()=> props.mode === 'char' ? props.charDelay : (props.mode === 'word' ? props.wordDelay : props.lineDelay));

          function clearTimers(){ if (timer.value) clearTimeout(timer.value); if (startTimer.value) clearTimeout(startTimer.value); timer.value = null; startTimer.value = null; }
          function start(){
            clearTimers();
            count.value = 0;
            const total = segments.value.length;
            if (total === 0) return;
            let i = 0;
            const tick = () => {
              i += 1; count.value = i; emit('update:count', i);
              if (i < total) { timer.value = setTimeout(tick, delay.value); }
              else { emit('complete'); }
            };
            startTimer.value = setTimeout(()=>{ timer.value = setTimeout(tick, delay.value); }, Math.max(0, props.startDelay));
          }

          watch(()=>[props.text, props.mode, props.charDelay, props.wordDelay, props.lineDelay, props.startDelay], start, { immediate: true });
          onMounted(start);
          onBeforeUnmount(clearTimers);

          return { count, segments };
        },
        template: `
          <div class="ai-reply" :class="className">
            <div v-if="mode==='line'" class="lines">
              <div v-for="(line, idx) in segments.slice(0, count)" :key="idx" class="seg seg-line fade-in" :style="{ animationDelay: Math.min(idx*0.03, 0.6)+'s' }">{{ line }}</div>
            </div>
            <span v-else class="inline">
              <span v-for="(seg, idx) in segments.slice(0, count)" :key="idx" class="seg seg-inline fade-in" :style="{ animationDelay: Math.min(idx*0.015, 0.5)+'s' }">{{ seg }}</span>
            </span>
          </div>
        `
      };

      // Helper to mount the component onto an existing element (imperative API for vanilla JS)
      // Usage: const inst = window.jaremis.mountAnimatedReply(targetEl, { text: 'Hello', mode:'word', wordDelay:45, startDelay:100, className:'bot-reply' });
      // Later to replace with final HTML: inst.replaceWithHtml(finalHtml)
      // Or to unmount: inst.unmount()
      window.jaremis = window.jaremis || {};
      window.jaremis.mountAnimatedReply = function(targetEl, props){
        if (!targetEl) throw new Error('mountAnimatedReply: targetEl is required');
        targetEl.innerHTML = '';
        const host = document.createElement('div');
        targetEl.appendChild(host);
        const app = createApp(AnimatedAIReply, props || {});
        const vm = app.mount(host);
        return {
          app,
          host,
          vm,
          unmount(){ try { app.unmount(); } catch(_) {} if (host && host.parentNode) host.parentNode.removeChild(host); },
          replaceWithHtml(html){ this.unmount(); targetEl.innerHTML = html || ''; }
        };
      };

      // Also expose component constructor for advanced usage
      window.AnimatedAIReply = AnimatedAIReply;
    })();
    </script>

    <!-- KaTeX helper & auto-render (Doctor-style) -->
    <script>
(function(){
  if (window._jaremis_shortcuts_installed) return; window._jaremis_shortcuts_installed = true;

  // Safe helper to click an element by id
  function tryClick(id){ try{ const el = document.getElementById(id); if(el){ el.click(); return true; } }catch(e){} return false; }

  // Provide lightweight global stubs (will defer to real implementations when available)
  window.jaremis = window.jaremis || {};
  window.jaremis.ensureRenderMath = function(el){ if (window.renderMathIn) return window.renderMathIn(el); /* no-op until katex loader runs */ };
  // Keep existing wrapResultMath/addResultBoxStyles if present; otherwise noop
  if (!window.wrapResultMath) window.wrapResultMath = function(b){ /* will be replaced by real implementation if defined later */ };
  if (!window.addResultBoxStyles) window.addResultBoxStyles = function(){ };

  // Keyboard shortcuts mapping (use Ctrl+letter / Ctrl+Shift+letter). Avoid overriding basic input behavior.
  document.addEventListener('keydown', function(e){
    const tgt = e.target || {};
    const tag = (tgt.tagName || '').toUpperCase();
    const isEditable = tag === 'INPUT' || tag === 'TEXTAREA' || tgt.isContentEditable;

    // Ctrl+Enter -> send (works even when typing)
    if (e.ctrlKey && !e.shiftKey && e.key === 'Enter') {
      e.preventDefault(); tryClick('send-btn'); return;
    }

    // If typing in a text field, do not hijack other shortcuts (except send)
    if (isEditable) return;

    // Map single Ctrl+letter and Ctrl+Shift+letter combinations
    if (e.ctrlKey && !e.altKey) {
      const k = (e.key || '').toLowerCase();
      const shift = e.shiftKey;
      // Mic: Ctrl+M
      if (!shift && k === 'm') { e.preventDefault(); tryClick('mic-btn'); flashNotice && flashNotice('Mic toggled (Ctrl+M)'); return; }
      // Attach: Ctrl+Shift+U
      if (shift && k === 'u') { e.preventDefault(); tryClick('attach-btn') || document.getElementById('images')?.click(); flashNotice && flashNotice('Attach file (Ctrl+Shift+U)'); return; }
      // Diagnose: Ctrl+Shift+K
      if (shift && k === 'k') { e.preventDefault(); tryClick('mode-btn'); flashNotice && flashNotice('Toggle Diagnose (Ctrl+Shift+K)'); return; }
      // Model switch: Ctrl+Shift+Y
      if (shift && k === 'y') { e.preventDefault(); tryClick('think-btn'); flashNotice && flashNotice('Switch model (Ctrl+Shift+Y)'); return; }
      // New chat: Ctrl+Shift+X
      if (shift && k === 'x') { e.preventDefault(); startNewConversation && startNewConversation(); flashNotice && flashNotice('New chat (Ctrl+Shift+X)'); return; }
      // Open history/find: Ctrl+Shift+F
      if (shift && k === 'f') { e.preventDefault(); openFindModal && openFindModal(); flashNotice && flashNotice('Find (Ctrl+Shift+F)'); return; }
    }
  }, true);

  // Ensure chatInput Ctrl+Enter works even if focus is inside textarea
  try { const ci = document.getElementById('chat-input'); const sb = document.getElementById('send-btn');
    if (ci && sb) {
      ci.addEventListener('keydown', function(ev){ if (ev.ctrlKey && ev.key === 'Enter') { ev.preventDefault(); sb.click(); } });
    }
  } catch(e){}

})();
</script>
<!-- KaTeX helper & auto-render (Doctor-style) -->
<script>
// Define helper like Doctor's implementation and an unobtrusive observer
if (!window._jaremis_katex_setup) {
  window._jaremis_katex_setup = true;

  // renderMathIn wrapper (safe: no throw, ignores code/pre)
  function renderMathIn(el){
    if (!el || !window.renderMathInElement) return;
    try{
      window.renderMathInElement(el, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$',  right: '$',  display: false},
          {left: '\\[', right: '\\]', display: true},
          {left: '\\(', right: '\\)', display: false}
        ],
        throwOnError: false,
        ignoredTags: ['script','noscript','style','textarea','pre','code'],
        ignoredClasses: ['no-math','katex']
      });
    }catch(err){
      // don't interfere with app; just warn
      console.warn('renderMathIn error', err);
    }
  }

  window.renderMathIn = renderMathIn;

  // Normalize LaTeX delimiters inside text nodes of an element.
  function normalizeLatexInElement(el){
    if(!el) return;
    try{
      const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null);
      const nodes = [];
      while(walker.nextNode()) nodes.push(walker.currentNode);
      nodes.forEach(n => {
        let s = n.nodeValue;
        if(!s || (!s.includes('$') && !s.includes('\\(') && !s.includes('\\['))) return;
        // Collapse repeated dollar signs (e.g. $$$ -> $$)
        s = s.replace(/\${3,}/g, '$$');
        // Convert display $$...$$ to \[ ... \]
        s = s.replace(/\$\$(.*?)\$\$/gs, '\\[$1\\]');
        // Convert simple inline $...$ to \\( ... \\)
        // Avoid replacing when $ is adjacent to whitespace at boundaries
        s = s.replace(/\$(\S[\s\S]*?\S)\$/gs, '\\\($1\\\)');
        // Trim accidental spaces inside delimiters
        s = s.replace(/\\\(\s+/g,'\\\\(').replace(/\s+\\\)/g,'\\\\)');
        n.nodeValue = s;
      });
    }catch(err){ console.warn('normalizeLatexInElement error', err); }
  }

  function cleanupStrayDollarSigns(el){
    if(!el) return;
    try{
      const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null);
      const nodes = [];
      while(walker.nextNode()) nodes.push(walker.currentNode);
      for(const n of nodes){
        // skip text nodes that are inside a KaTeX-rendered element
        if(n.parentElement && n.parentElement.closest && n.parentElement.closest('.katex')) continue;
        let s = n.nodeValue;
        if(!s || !s.includes('$')) continue;
        // Remove unescaped single or double dollar signs left over (keep escaped \$)
        // Use lookbehind to avoid removing \$
        try{
          s = s.replace(/(?<!\\)\${1,2}/g, '');
        }catch(e){
          // fallback for older engines: remove all $ then restore escaped sequences
          s = s.replace(/\\\$/g, '__ESC_DOLLAR__').replace(/\$/g,'').replace(/__ESC_DOLLAR__/g,'\\$');
        }
        n.nodeValue = s;
      }
    }catch(err){ console.warn('cleanupStrayDollarSigns error', err); }
  }

  function renderBubbleIfNeeded(bubble){
    if (!bubble || bubble.dataset.katexRendered) return;
    if (!bubble.classList || !bubble.classList.contains('chat-bubble')) return;
    // Normalize delimiters first to avoid stray $ and inconsistent markers
    normalizeLatexInElement(bubble);
    renderMathIn(bubble);
    // Remove any leftover $ or $$ in plain text nodes outside KaTeX elements
    cleanupStrayDollarSigns(bubble);
    bubble.dataset.katexRendered = '1';
  }

  // Auto-render existing chat bubbles and newly added ones.
  document.addEventListener('DOMContentLoaded', ()=>{
    const container = document.getElementById('chat-messages');
    if (!container) return;
    // Render existing bubbles
    container.querySelectorAll('.chat-bubble').forEach(renderBubbleIfNeeded);
    // Observe added nodes
    const mo = new MutationObserver(muts=>{
      for (const m of muts){
        for (const n of m.addedNodes){
          if (n.nodeType !== 1) continue;
          if (n.classList && n.classList.contains('chat-bubble')) renderBubbleIfNeeded(n);
          else if (n.querySelectorAll) n.querySelectorAll('.chat-bubble').forEach(renderBubbleIfNeeded);
        }
      }
    });
    mo.observe(container, { childList: true, subtree: true });
  });
}
</script>
    <!-- Inject the animated reply utility (vanilla, non-intrusive) -->
    <script src="animated-reply.js"></script>
    <script>
// === Basic utility helpers (from Doctor variant, trimmed) ===
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
function autoResize(t){t.style.height='auto';t.style.height=(t.scrollHeight)+'px';}

// Session / user helpers (stubs; integrate with real logic if available)
function getLocalUser(){ try{ return JSON.parse(localStorage.getItem('jaremis_user')||'null'); }catch(e){ return null; } }

// Global state
window.useProModel = window.useProModel || false;
window.diagnosticMode = window.diagnosticMode || false;

const chatInput = document.getElementById('chat-input');
const chatMessages = document.getElementById('chat-messages');
const sendBtn = document.getElementById('send-btn');
const modeBtn = document.getElementById('mode-btn');
const thinkBtn = document.getElementById('think-btn');
const micBtn = document.getElementById('mic-btn');
const attachBtn = document.getElementById('attach-btn');
const imageInput = document.getElementById('images');
const imagePreviewContainer = document.getElementById('image-preview-container');

function toggleMode(e){ e&&e.preventDefault(); window.diagnosticMode = !window.diagnosticMode; modeBtn.classList.toggle('active', window.diagnosticMode); modeBtn.title = window.diagnosticMode? 'Chế độ: Diagnose':'Chế độ: Chat'; }
function toggleThink(e){ e&&e.preventDefault(); window.useProModel = !window.useProModel; thinkBtn.classList.toggle('active', window.useProModel); document.getElementById('model-status').textContent = 'Model: ' + (window.useProModel? 'JAREMIS Pro':'JAREMIS 1.5'); }
function toggleMic(){ /* TODO: implement speech recog later */ }

function handleImageUpload(ev){ imagePreviewContainer.innerHTML=''; Array.from(ev.target.files).forEach((file,i)=>{ const r=new FileReader(); r.onload = e=>{ const div=document.createElement('div'); div.className='preview-item'; div.innerHTML=`<img src="${e.target.result}"><button class='remove-btn' onclick='removeImage(${i})'>&times;</button>`; imagePreviewContainer.appendChild(div); }; r.readAsDataURL(file); }); }
function removeImage(idx){ const dt=new DataTransfer(); const files=Array.from(imageInput.files); files.splice(idx,1); files.forEach(f=>dt.items.add(f)); imageInput.files = dt.files; handleImageUpload({target:imageInput}); }

function startNewConversation(){ chatMessages.innerHTML=''; chatMessages.insertAdjacentHTML('beforeend', `<div class='chat-bubble bot-bubble'><strong>Bắt đầu cuộc trò chuyện mới ✅</strong></div>`); }
function openFindModal(){ /* stub */ }

// Streaming UI helper
function startStreamingInto(bubble){
  let aggregated='';
  const anim = AnimatedReply.mount(bubble, { text:'', mode:'word', wordDelay:38 });
  return {
    onDelta(chunk){ if(!chunk) return; aggregated += chunk; anim.replace(escapeHtml(aggregated)); },
    onDone(finalHtml){ if(finalHtml){ bubble.innerHTML = finalHtml; } else { anim.finish(); bubble.dataset.final='1'; if(window.convertMarkdown) { bubble.innerHTML = convertMarkdown(aggregated); } } if(window.renderMathIn) renderMathIn(bubble); },
    onError(msg){ bubble.innerHTML = `<div style='color:var(--error-color)'>${escapeHtml(msg||'Lỗi kết nối')}</div>`; }
  };
}

async function submitData(){
  const message = chatInput.value.trim();
  const files = imageInput.files;
  if(!message && files.length===0) return;
  const user = getLocalUser();
  // user bubble
  let userHtml = `<div class='chat-bubble user-bubble'><div class='user-bubble-content'>`;
  if(message) userHtml += `<p>${escapeHtml(message)}</p>`;
  if(files.length){ let imgs='<div class="user-images-preview">'; for(let i=0;i<files.length;i++){ imgs += `<img src='${URL.createObjectURL(files[i])}'>`; } imgs+='</div>'; userHtml += imgs; }
  if(user) userHtml += `<div style='font-size:11px;margin-top:6px;color:var(--text-secondary-color)'>${escapeHtml(user.username)}</div>`;
  userHtml += `</div></div>`;
  chatMessages.insertAdjacentHTML('beforeend', userHtml);
  chatInput.value=''; autoResize(chatInput); imagePreviewContainer.innerHTML='';
  const loadingBubble = document.createElement('div'); loadingBubble.className='chat-bubble bot-bubble'; chatMessages.appendChild(loadingBubble); chatMessages.scrollTop = chatMessages.scrollHeight;

  try {
    // Always stream (chat mode); if diagnosticMode true you would call /api/diagnose via fetch POST (not implemented here yet)
    const params = new URLSearchParams({
      message,
      model: window.useProModel? 'pro':'flash',
      submittedBy: user? user.username:'',
      includeHistory:'true'
    });
    const es = new EventSource('/api/chat-stream?'+params.toString());
    const ui = startStreamingInto(loadingBubble);

    es.addEventListener('message', (e)=>{ try{ const data = JSON.parse(e.data); if(data.chunk) ui.onDelta(data.chunk); if(data.done){ ui.onDone(data.replyHtml); es.close(); } if(data.error){ ui.onError(data.error); es.close(); } }catch(err){} });
    es.onerror = ()=>{ ui.onError('Stream lỗi'); es.close(); };
  } catch(err){ loadingBubble.innerHTML = `<div style='color:var(--error-color)'>${escapeHtml(err.message||'Lỗi gửi yêu cầu')}</div>`; }
}

sendBtn?.addEventListener('click', (e)=>{ e.preventDefault(); submitData(); });
chatInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); submitData(); }});

// 3D tilt effect re-bind (similar selectors to Doctor version)
(function(){
  if(window.__TILT_BOUND_INDEX__) return; window.__TILT_BOUND_INDEX__=true;
  const SELECTORS=['#send-btn','.action-btn','.new-chat-btn','.auth-controls .auth-btn','#mode-btn','#think-btn','#mic-btn','.hamburger','#history-drawer-toggle','.btn-primary','.btn-ghost'];
  const MAX_TILT=14,PERS=900;
  function bindTilt(el){ if(!el||el.dataset.tiltApplied) return; el.dataset.tiltApplied='1'; el.classList.add('tilt-3d');
    function move(e){ const r=el.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width; const y=(e.clientY-r.top)/r.height; const rx=(0.5-y)*(MAX_TILT*2); const ry=(x-0.5)*(MAX_TILT*2); el.style.setProperty('--mx',(x*100)+'%'); el.style.setProperty('--my',(y*100)+'%'); el.style.transform=`perspective(${PERS}px) rotateX(${rx}deg) rotateY(${ry}deg) translateZ(6px)`; el.style.setProperty('--glow-o','1'); }
    function leave(){ el.style.transform=`perspective(${PERS}px) rotateX(0deg) rotateY(0deg) translateZ(0)`; el.style.setProperty('--glow-o','0'); }
    el.addEventListener('mousemove',move); el.addEventListener('mouseenter',move); el.addEventListener('mouseleave',leave);
  }
  function scan(){ SELECTORS.forEach(sel=> document.querySelectorAll(sel).forEach(bindTilt)); }
  document.addEventListener('DOMContentLoaded', scan); new MutationObserver(scan).observe(document.body,{childList:true,subtree:true});
})();
</script>
</body>
</html>