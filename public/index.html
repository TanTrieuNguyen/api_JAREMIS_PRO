<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JAREMIS - AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 260px;
            --bg-color: #0d1117;
            --sidebar-bg: #161b22;
            --chat-bg: #010409;
            --input-bg: #161b22;
            --bot-bubble-bg: #161b22;
            --user-bubble-bg: #003666;
            --text-color: #c9d1d9;
            --text-secondary-color: #8b949e;
            --border-color: #30363d;
            --accent-color: #2f81f7;
            --error-color: #f85149;
            --success-color: #238636;
            --who-bg: #212013;
            --mic-red: #ff4d4d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container { display: flex; width: 100%; height: 100%; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 200px;
            max-width: 500px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 16px;
            transition: width 0.1s ease-out;
            flex-shrink: 0;
        }
        .resizer { width: 5px; cursor: col-resize; background-color: transparent; flex-shrink: 0; position: relative; z-index: 10; }
        .resizer:hover { background-color: var(--accent-color); }

        .sidebar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:8px; }
        .new-chat-btn {
            display:flex; align-items:center; gap:8px; width:100%; padding:10px; background:transparent; color:var(--text-color);
            border:1px solid var(--border-color); border-radius:6px; font-size:14px; cursor:pointer;
        }
        .new-chat-btn:hover { background-color:#2c313a; }

        .history { flex-grow:1; overflow-y:auto; margin-top:10px; }
        .history h3 { font-size:12px; color:var(--text-secondary-color); margin-bottom:8px; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; }
        .history ul { list-style:none; padding:0; display:flex; flex-direction:column; gap:6px; }
        .history li { padding:8px; border-radius:6px; cursor:pointer; color:var(--text-color); background:transparent; border:1px solid transparent; font-size:13px; }
        .history li:hover { background:#111720; border-color:var(--border-color); }
        .sidebar-footer { font-size:12px; color:var(--text-secondary-color); text-align:center; margin-top:10px; }

        /* Chat area */
        .chat-area { flex-grow:1; display:flex; flex-direction:column; background-color:var(--chat-bg); border-left:1px solid var(--border-color); position:relative; }
        .chat-messages { flex-grow:1; padding:24px; overflow-y:auto; display:flex; flex-direction:column; gap:20px; }
        .chat-bubble { max-width:80%; padding:16px; border-radius:12px; line-height:1.6; word-wrap:break-word; }
        .bot-bubble { background-color:var(--bot-bubble-bg); align-self:flex-start; border:1px solid var(--border-color); }
        .user-bubble { background-color:var(--user-bubble-bg); align-self:flex-end; color:#fff; }

        .user-bubble-content p { margin-bottom:12px; }
        .user-images-preview { display:flex; gap:10px; flex-wrap:wrap; }
        .user-images-preview img { width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid var(--border-color); }

        .chat-input-area { padding:16px 24px; border-top:1px solid var(--border-color); display:flex; flex-direction:column; gap:8px; }
        .input-wrapper { position:relative; display:flex; align-items:center; background-color:var(--input-bg); border:1px solid var(--border-color); border-radius:8px; padding:8px; gap:8px; }

        #chat-input { flex-grow:1; background:transparent; border:none; color:var(--text-color); font-size:16px; padding:8px; resize:none; max-height:200px; overflow-y:auto; }
        #chat-input:focus { outline:none; }

        .input-actions { display:flex; align-items:center; gap:8px; }
        .action-btn {
            background:none; border:none; color:var(--text-secondary-color); font-size:20px; cursor:pointer; width:40px; height:40px; border-radius:6px;
            display:flex; align-items:center; justify-content:center;
        }
        .action-btn:hover { background-color:#2c313a; color:var(--text-color); }
        #send-btn { background-color:var(--accent-color); color:white; border-radius:6px; width:44px; height:40px; display:flex; align-items:center; justify-content:center; }
        #send-btn:disabled { background-color:#30363d; cursor:not-allowed; }

        #image-preview-container { display:flex; gap:10px; margin-top:10px; padding:0 8px; }
        .preview-item { position:relative; }
        .preview-item img { width:60px; height:60px; object-fit:cover; border-radius:6px; }
        .remove-btn { position:absolute; top:-5px; right:-5px; background:var(--error-color); color:white; border:none; width:20px; height:20px; border-radius:50%; cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center; }

        /* Analysis steps */
        .analysis-steps { display:flex; flex-direction:column; gap:12px; }
        .step-item { display:flex; align-items:center; gap:12px; font-size:14px; transition:color 0.3s ease; }
        .step-item .icon { width:20px; text-align:center; }
        .step-item.pending { color:var(--text-secondary-color); }
        .step-item.active { color:var(--text-color); font-weight:600; }
        .step-item.completed { color:var(--success-color); }
        .fa-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }

        /* Result */
        .error-message { color:var(--error-color); }
        .confidence-meter { background:#2c313a; border-radius:20px; height:24px; margin:16px 0; overflow:hidden; position:relative; }
        .confidence-bar { background:var(--success-color); height:100%; display:flex; align-items:center; padding-left:12px; color:white; font-weight:bold; font-size:12px; transition: width 0.5s ease; }

        .disease-list { margin:20px 0; display:flex; flex-direction:column; gap:15px; }
        .disease-item { border-left:3px solid var(--accent-color); padding-left:15px; }
        .probability-bar { height:8px; background:#30363d; border-radius:10px; overflow:hidden; margin-top:8px; }
        .probability-fill { height:100%; background:var(--accent-color); transition:width 0.5s ease; }

        .diagnosis-details h2, .diagnosis-details h3 { border-bottom:1px solid var(--border-color); padding-bottom:8px; margin:20px 0 10px 0; font-size:1.1em; }
        .references-section { margin-top:25px; padding:15px; background:rgba(47,129,247,0.1); border-radius:8px; }
        .reference-item { margin-top:10px; }
        .reference-item a { color:var(--accent-color); text-decoration:none; }
        .reference-item a:hover { text-decoration:underline; }
        .reference-source { font-size:0.8em; color:var(--text-secondary-color); margin-top:4px; }

        .warning { margin-top:20px; padding:12px; background:var(--who-bg); border-left:4px solid #f1e05a; color:#d4c873; font-size:14px; border-radius:4px; }
        .warning strong { color:#f1e05a; }

        /* Think button style */
        #think-btn { background:none; border:1px solid var(--border-color); border-radius:6px; padding:6px 8px; color:var(--text-secondary-color); cursor:pointer; width:auto; height:40px; display:flex; align-items:center; justify-content:center; }
        #think-btn.active { background: linear-gradient(90deg, rgba(47,129,247,0.12), rgba(47,129,247,0.06)); color:var(--text-color); border-color: rgba(47,129,247,0.6); }
        #model-status { font-size:12px; color:var(--text-secondary-color); margin-left:8px; align-self:center; }

        /* Mic button style */
        #mic-btn { background:none; border:1px solid var(--border-color); border-radius:6px; padding:6px 8px; color:var(--text-secondary-color); cursor:pointer; width:auto; height:40px; display:flex; align-items:center; justify-content:center; }
        #mic-btn.recording { background: rgba(255,77,77,0.12); color: var(--text-color); border-color: rgba(255,77,77,0.5); box-shadow: 0 0 8px rgba(255,77,77,0.12); }
        #mic-indicator {
            width:8px; height:8px; border-radius:50%; background:var(--mic-red); margin-left:6px; display:inline-block; opacity:0;
            box-shadow: 0 0 6px rgba(255,77,77,0.8);
            animation: pulse 1.2s infinite;
        }
        #mic-btn.recording #mic-indicator { opacity:1; }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        /* Auth UI (top-right) */
        .auth-controls {
            position: absolute;
            top: 12px;
            right: 18px;
            display:flex;
            gap:8px;
            align-items:center;
            z-index: 40;
        }
        .auth-btn {
            background: transparent;
            color: var(--text-secondary-color);
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .auth-btn:hover { background: #1f272e; color: var(--text-color); }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal {
            background: #0b1116;
            border: 1px solid var(--border-color);
            padding: 18px;
            border-radius: 10px;
            width: 360px;
            max-width: 92%;
            color: var(--text-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .modal h3 { margin-bottom: 10px; font-size: 18px; }
        .tabs { display:flex; gap:8px; margin-bottom:12px; }
        .tab { padding:8px 12px; border-radius:6px; cursor:pointer; background:transparent; color:var(--text-secondary-color); border:1px solid transparent; }
        .tab.active { background: rgba(47,129,247,0.12); color:var(--text-color); border-color: rgba(47,129,247,0.2); }
        .form-row { margin-bottom:10px; display:flex; flex-direction:column; gap:6px; }
        .form-row input { background: #071018; border: 1px solid var(--border-color); color: var(--text-color); padding:8px 10px; border-radius:6px; }
        .form-actions { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; }
        .btn-primary { background: var(--accent-color); color: #fff; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
        .btn-ghost { background:transparent; color:var(--text-secondary-color); border:1px solid var(--border-color); padding:8px 10px; border-radius:6px; cursor:pointer; }

        .small-muted { font-size:12px; color:var(--text-secondary-color); margin-top:8px; }

        /* small responsive */
        @media (max-width: 900px) {
            .sidebar { display:none; }
            .resizer { display:none; }
            .auth-controls { right: 8px; top: 8px; }
        }
        /* ✅ Responsive cho điện thoại */
        /* === Thêm ở đây === */
        @media (max-width: 768px) {
            .chat-messages {
                font-size: 1rem;   /* chữ to hơn */
                padding: 12px;
            }

            .chat-bubble {
                font-size: 0.95rem;
                padding: 12px;
                border-radius: 14px;
                max-width: 95%;   /* chiếm gần hết màn hình mobile */
            }

            #chat-input {
                font-size: 1rem;  /* input to hơn */
                padding: 12px;
            }

            .input-wrapper {
                padding: 10px;
            }

            .action-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            #send-btn {
                width: 45px;
                height: 40px;
            }
        }
        /* === Hết phần thêm === */

    </style>
</head>
<body>
    <div class="chat-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="window.location.reload()">
                    <i class="fas fa-plus"></i>
                    <span>Cuộc trò chuyện mới</span>
                </button>
            </div>
            <nav class="history">
                <h3>
                    Lịch sử
                    <span id="history-actions" style="font-size:12px;"></span>
                </h3>
                <ul id="history-list"></ul>
            </nav>
            <div class="sidebar-footer">Made with ❤️ by 717483 & Ant.</div>
        </aside>

        <div class="resizer" id="resizer"></div>

        <main class="chat-area" id="chat-area">
            <!-- Auth controls (top-right) -->
            <div class="auth-controls" id="auth-controls">
                <!-- Will be populated by JS -->
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="chat-bubble bot-bubble">
                    <strong>Chào bạn 👋 Mình là JAREMIS.</strong>
                    <p style="margin-top:8px; color:var(--text-secondary-color);">
                        Hãy nhập các dấu hiệu, hỏi chuyện, hoặc bật chế độ <strong>Diagnose</strong> để yêu cầu chẩn đoán y khoa.
                    </p>
                </div>
            </div>

            <div class="chat-input-area">
                <div id="image-preview-container"></div>
                <div class="input-wrapper">
                    <textarea id="chat-input" placeholder="Nhập tin nhắn hoặc tải lên hình ảnh..." rows="1" oninput="autoResize(this)"></textarea>

                    <div class="input-actions">
                        <button class="action-btn" onclick="document.getElementById('images').click()" title="Đính kèm ảnh">
                            <i class="fas fa-paperclip"></i>
                        </button>

                        <!-- Mode toggle: Chat / Diagnose -->
                        <button id="mode-btn" class="action-btn" title="Chế độ: Chat (mặc định)" onclick="toggleMode(event)">
                            <i class="fas fa-comments"></i>
                        </button>

                        <!-- Mic button -->
                        <button id="mic-btn" class="action-btn" title="Ghi giọng nói (Vietnamese). Nhấn để bắt đầu/dừng" onclick="toggleMic(event)">
                            <i class="fas fa-microphone"></i>
                            <span id="mic-indicator"></span>
                        </button>

                        <!-- Think toggle button -->
                        <button id="think-btn" class="action-btn" title="Bật Think (dùng Gemini Pro)" onclick="toggleThink(event)">
                            <i class="fas fa-brain"></i>
                        </button>

                        <button id="send-btn" class="action-btn" onclick="submitData()" title="Gửi">
                            <i class="fas fa-paper-plane"></i>
                        </button>

                        <input type="file" id="images" multiple hidden onchange="handleImageUpload(event)">
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div id="model-status">Model: JAREMIS 1.0</div>
                    <div style="font-size:12px; color:var(--text-secondary-color);">Trạng thái: Rảnh</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Auth modal -->
    <div class="modal-backdrop" id="auth-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
            <h3 id="auth-title">Đăng nhập / Đăng ký</h3>

            <div class="tabs">
                <div class="tab active" id="tab-login" onclick="showTab('login')">Đăng nhập</div>
                <div class="tab" id="tab-register" onclick="showTab('register')">Đăng ký</div>
            </div>

            <!-- Login form -->
            <div id="form-login">
                <div class="form-row">
                    <label>Username hoặc Email</label>
                    <input id="login-username" placeholder="Tên đăng nhập hoặc email">
                </div>
                <div class="form-row">
                    <label>Mật khẩu</label>
                    <input id="login-password" type="password" placeholder="Mật khẩu">
                </div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="submitLogin()">Đăng nhập</button>
                    <button class="btn-ghost" onclick="closeAuthModal()">Hủy</button>
                </div>
                <div class="small-muted">Bạn chưa có tài khoản? Chuyển sang tab "Đăng ký".</div>
            </div>

            <!-- Register form -->
            <div id="form-register" style="display:none">
                <div class="form-row">
                    <label>Tên đăng nhập</label>
                    <input id="reg-username" placeholder="Tên đăng nhập">
                </div>
                <div class="form-row">
                    <label>Email</label>
                    <input id="reg-email" placeholder="email@example.com" type="email">
                </div>
                <div class="form-row">
                    <label>Mật khẩu</label>
                    <input id="reg-password" type="password" placeholder="Mật khẩu (ít nhất 6 ký tự)">
                </div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="submitRegister()">Đăng ký</button>
                    <button class="btn-ghost" onclick="closeAuthModal()">Hủy</button>
                </div>
                <div class="small-muted">Bằng cách đăng ký, bạn đồng ý thử nghiệm tính năng.</div>
            </div>
        </div>
    </div>

    <script>
        // ------------------------------
        // UI elements & state
        // ------------------------------
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const imageInput = document.getElementById('images');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const chatMessages = document.getElementById('chat-messages');
        const thinkBtn = document.getElementById('think-btn');
        const modelStatusEl = document.getElementById('model-status');
        const micBtn = document.getElementById('mic-btn');
        const micIndicator = document.getElementById('mic-indicator');
        const modeBtn = document.getElementById('mode-btn');

        const historyListEl = document.getElementById('history-list');
        const historyActionsEl = document.getElementById('history-actions');

        const authBackdrop = document.getElementById('auth-backdrop');
        const authControls = document.getElementById('auth-controls');

        let useProModel = false;
        let diagnosticMode = false; // Chat mode default
        let recognition = null;
        let isRecording = false;
        let textBeforeRecording = '';
        let historyCache = [];

        // ------------------------------
        // Helper: Escape HTML
        // ------------------------------
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ------------------------------
        // Auto-resize textarea
        // ------------------------------
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // ------------------------------
        // Mode & Think toggles
        // ------------------------------
        function toggleMode(e) {
            e?.preventDefault();
            diagnosticMode = !diagnosticMode;
            if (diagnosticMode) {
                modeBtn.classList.add('active');
                modeBtn.title = 'Chế độ: Diagnose (chẩn đoán y khoa)';
                modeBtn.innerHTML = '<i class="fas fa-stethoscope"></i>';
            } else {
                modeBtn.classList.remove('active');
                modeBtn.title = 'Chế độ: Chat';
                modeBtn.innerHTML = '<i class="fas fa-comments"></i>';
            }
        }

        function toggleThink(e) {
            e?.preventDefault();
            useProModel = !useProModel;
            if (useProModel) {
                thinkBtn.classList.add('active');
                modelStatusEl.textContent = 'Model: JAREMIS PRO';
            } else {
                thinkBtn.classList.remove('active');
                modelStatusEl.textContent = 'Model: JAREMIS 1.0';
            }
        }

        // ------------------------------
        // Authentication & user state (client session stored in localStorage)
        // ------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            renderAuthControls();
            const u = getLocalUser();
            if (u) fetchAndRenderHistory(u.username);
        });

        function getLocalUser() {
            try {
                const raw = localStorage.getItem('jaremis_user');
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                return null;
            }
        }

        function renderAuthControls() {
            authControls.innerHTML = '';
            const user = getLocalUser();
            if (user) {
                const nameEl = document.createElement('div');
                nameEl.style.color = 'var(--text-color)';
                nameEl.style.fontSize = '13px';
                nameEl.textContent = user.username;

                const btnHistoryClear = document.createElement('button');
                btnHistoryClear.className = 'auth-btn';
                btnHistoryClear.textContent = 'Xóa lịch sử';
                btnHistoryClear.title = 'Xóa toàn bộ lịch sử chat';
                btnHistoryClear.onclick = async () => {
                    if (!confirm('Xóa toàn bộ lịch sử chat của bạn?')) return;
                    try {
                        const res = await fetch(`/api/history?username=${encodeURIComponent(user.username)}`, { method: 'DELETE' });
                        const json = await res.json();
                        if (!res.ok) {
                            alert(json.error || 'Không xóa được lịch sử');
                            return;
                        }
                        historyCache = [];
                        renderHistoryList([]);
                        flashNotice('Đã xóa lịch sử');
                    } catch (e) {
                        console.error(e);
                        flashNotice('Lỗi khi xóa lịch sử');
                    }
                };

                const logoutBtn = document.createElement('button');
                logoutBtn.className = 'auth-btn';
                logoutBtn.textContent = 'Đăng xuất';
                logoutBtn.onclick = () => {
                    localStorage.removeItem('jaremis_user');
                    renderAuthControls();
                    historyCache = [];
                    renderHistoryList([]);
                };

                authControls.appendChild(nameEl);
                authControls.appendChild(btnHistoryClear);
                authControls.appendChild(logoutBtn);
            } else {
                const loginBtn = document.createElement('button');
                loginBtn.className = 'auth-btn';
                loginBtn.textContent = 'Đăng nhập';
                loginBtn.onclick = openAuthModal;

                const registerBtn = document.createElement('button');
                registerBtn.className = 'auth-btn';
                registerBtn.textContent = 'Đăng ký';
                registerBtn.onclick = () => { openAuthModal(); showTab('register'); };

                authControls.appendChild(loginBtn);
                authControls.appendChild(registerBtn);
            }
        }

        function openAuthModal() {
            authBackdrop.style.display = 'flex';
            showTab('login');
        }
        function closeAuthModal() {
            authBackdrop.style.display = 'none';
        }
        function showTab(tab) {
            document.getElementById('tab-login').classList.toggle('active', tab === 'login');
            document.getElementById('tab-register').classList.toggle('active', tab === 'register');
            document.getElementById('form-login').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('form-register').style.display = tab === 'register' ? 'block' : 'none';
        }

        async function submitRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;

            if (!username || !email || !password) {
                flashNotice('Vui lòng nhập đầy đủ thông tin đăng ký');
                return;
            }
            if (password.length < 6) {
                flashNotice('Mật khẩu ít nhất 6 ký tự');
                return;
            }

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const json = await res.json();
                if (!res.ok) {
                    flashNotice(json.error || 'Đăng ký thất bại');
                    return;
                }
                localStorage.setItem('jaremis_user', JSON.stringify(json.user));
                flashNotice('Đăng ký thành công! Bạn đã đăng nhập tạm thời.', 2000);
                closeAuthModal();
                renderAuthControls();
                fetchAndRenderHistory(json.user.username);
            } catch (e) {
                console.error('Register error', e);
                flashNotice('Lỗi kết nối khi đăng ký');
            }
        }

        async function submitLogin() {
            const usernameOrEmail = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            if (!usernameOrEmail || !password) {
                flashNotice('Vui lòng nhập username/email và mật khẩu');
                return;
            }
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usernameOrEmail, password })
                });
                const json = await res.json();
                if (!res.ok) {
                    flashNotice(json.error || 'Đăng nhập thất bại');
                    return;
                }
                localStorage.setItem('jaremis_user', JSON.stringify(json.user));
                flashNotice('Đăng nhập thành công', 1200);
                closeAuthModal();
                renderAuthControls();
                fetchAndRenderHistory(json.user.username);
            } catch (e) {
                console.error('Login error', e);
                flashNotice('Lỗi kết nối khi đăng nhập');
            }
        }

        function flashNotice(msg, duration = 2000) {
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble bot-bubble';
            bubble.innerHTML = `<em style="color:var(--text-secondary-color)">${escapeHtml(msg)}</em>`;
            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            setTimeout(() => bubble.remove(), duration);
        }

        // ------------------------------
        // History: fetch, render, open
        // ------------------------------
        async function fetchAndRenderHistory(username) {
            if (!username) return;
            try {
                const res = await fetch(`/api/history?username=${encodeURIComponent(username)}`);
                const json = await res.json();
                if (!res.ok) {
                    console.warn('Không lấy được lịch sử', json);
                    renderHistoryList([]);
                    return;
                }
                historyCache = json.history || [];
                renderHistoryList(historyCache);
            } catch (e) {
                console.error('fetch history error', e);
            }
        }

        function renderHistoryList(list) {
            historyListEl.innerHTML = '';
            if (!list || list.length === 0) {
                historyListEl.innerHTML = `<li style="color:var(--text-secondary-color); font-size:13px;">Chưa có lịch sử</li>`;
                historyActionsEl.innerHTML = '';
                return;
            }
            list.forEach(item => {
                const li = document.createElement('li');
                li.dataset.id = item.id;
                const time = new Date(item.timestamp).toLocaleString();
                const titleText = (item.input && item.input.length > 60) ? item.input.slice(0, 60) + '...' : (item.input || 'Không có nội dung');
                li.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div style="flex:1; padding-right:8px;">
                                      <div style="font-size:13px; color:var(--text-color);">${escapeHtml(titleText)}</div>
                                      <div style="font-size:11px; color:var(--text-secondary-color); margin-top:4px">${escapeHtml(time)} • ${escapeHtml(item.modelUsed || '')} • ${escapeHtml(item.type || '')}</div>
                                    </div>
                                    <div style="margin-left:8px; font-size:12px; color:var(--text-secondary-color)"><i class="fas fa-chevron-right"></i></div>
                                </div>`;
                li.onclick = () => openHistoryItem(item.id);
                historyListEl.appendChild(li);
            });
            historyActionsEl.innerHTML = `<button class="auth-btn" onclick="clearLocalHistory()">Xóa</button>`;
        }

        async function clearLocalHistory() {
            const user = getLocalUser();
            if (!user) return;
            if (!confirm('Bạn có muốn xóa toàn bộ lịch sử?')) return;
            try {
                const res = await fetch(`/api/history?username=${encodeURIComponent(user.username)}`, { method: 'DELETE' });
                const json = await res.json();
                if (!res.ok) {
                    alert(json.error || 'Không xóa được lịch sử');
                    return;
                }
                historyCache = [];
                renderHistoryList([]);
                flashNotice('Đã xóa lịch sử');
            } catch (e) {
                console.error(e);
                flashNotice('Lỗi khi xóa lịch sử');
            }
        }

        function openHistoryItem(id) {
            const item = historyCache.find(h => String(h.id) === String(id));
            if (!item) return;
            chatMessages.innerHTML = '';
            const userHtml = `<div class="chat-bubble user-bubble"><div class="user-bubble-content"><p>${escapeHtml(item.input || '')}</p></div></div>`;
            chatMessages.innerHTML += userHtml;
            const replyContent = escapeHtml(item.reply || item.diagnosis || '');
            const botHtml = `<div class="chat-bubble bot-bubble">
                                <div class="diagnosis-details">
                                    <h3>Kết quả trước đó</h3>
                                    <div style="font-size:13px; color:var(--text-secondary-color); margin-bottom:8px;">${new Date(item.timestamp).toLocaleString()} • ${escapeHtml(item.modelUsed || '')} • ${escapeHtml(item.type || '')}</div>
                                    <div style="white-space:pre-wrap; font-size:14px; color:var(--text-color);">${replyContent}</div>
                                </div>
                             </div>`;
            chatMessages.innerHTML += botHtml;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ------------------------------
        // Mic / SpeechRecognition
        // ------------------------------
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN';
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            recognition.continuous = false;

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('recording');
                micBtn.title = 'Đang ghi âm — nhấn để dừng';
                textBeforeRecording = chatInput.value || '';
                chatInput.focus();
            };

            recognition.onerror = (event) => {
                console.warn('Speech recognition error', event.error);
                stopRecognition();
                flashNotice('Lỗi ghi âm: ' + (event.error || 'Không xác định'));
            };

            recognition.onend = () => {
                stopRecognition(false);
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = 0; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                chatInput.value = (textBeforeRecording + ' ' + finalTranscript + interimTranscript).trim();
                autoResize(chatInput);
            };
        } else {
            micBtn.title = 'Trình duyệt của bạn không hỗ trợ ghi âm chuyển văn bản (Web Speech API). Dùng Chrome/Microsoft Edge mới nhất để có chức năng này.';
            micBtn.style.opacity = '0.6';
            micBtn.style.pointerEvents = 'none';
        }

        function toggleMic(e) {
            e?.preventDefault();
            if (!SpeechRecognition) return;
            if (!isRecording) startRecognition();
            else stopRecognition();
        }

        function startRecognition() {
            if (!recognition) return;
            try {
                textBeforeRecording = chatInput.value || '';
                recognition.start();
            } catch (err) {
                console.warn('Không thể bắt đầu ghi âm:', err);
                flashNotice('Không thể bắt đầu ghi âm: ' + (err.message || err));
            }
        }

        function stopRecognition(clearInterim = false) {
            if (!recognition) return;
            try { recognition.stop(); } catch (e) {}
            isRecording = false;
            micBtn.classList.remove('recording');
            micBtn.title = 'Ghi giọng nói (Vietnamese). Nhấn để bắt đầu/dừng';
            if (clearInterim) {
                chatInput.value = textBeforeRecording || '';
                autoResize(chatInput);
            }
        }

        // ------------------------------
        // Image preview
        // ------------------------------
        function handleImageUpload(event) {
            imagePreviewContainer.innerHTML = '';
            Array.from(event.target.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-btn" onclick="removeImage(${index})">&times;</button>
                    `;
                    imagePreviewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            const dt = new DataTransfer();
            const files = Array.from(imageInput.files);
            files.splice(index, 1);
            files.forEach(file => dt.items.add(file));
            imageInput.files = dt.files;
            handleImageUpload({ target: imageInput });
        }

        // ------------------------------
        // Animate analysis steps (UX)
        // ------------------------------
        async function animateAnalysisSteps(bubbleElement) {
            const steps = [
                'Đang khởi tạo và gửi dữ liệu...',
                'Tìm kiếm tài liệu tham khảo (PubMed, ClinicalTrials)...',
                'AI đang phân tích và chẩn đoán hình ảnh...',
                'Tổng hợp và định dạng kết quả chẩn đoán...'
            ];

            let html = '<div class="analysis-steps">';
            steps.forEach((step, index) => {
                html += `<div id="step-${index}" class="step-item pending">
                            <span class="icon"><i class="fas fa-hourglass-half"></i></span>
                            <span>${step}</span>
                         </div>`;
            });
            html += '</div>';
            bubbleElement.innerHTML = html;

            for (let i = 0; i < steps.length; i++) {
                const stepEl = bubbleElement.querySelector(`#step-${i}`);
                const iconEl = stepEl.querySelector('.icon');

                stepEl.classList.remove('pending');
                stepEl.classList.add('active');
                iconEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                await new Promise(resolve => setTimeout(resolve, 600 + Math.random() * 600));

                stepEl.classList.remove('active');
                stepEl.classList.add('completed');
                iconEl.innerHTML = '<i class="fas fa-check"></i>';
            }
        }

        // ------------------------------
        // Submit: chooses /api/chat or /api/diagnose
        // ------------------------------
        async function submitData() {
            const labResults = chatInput.value.trim();
            const images = imageInput.files;

            if (!labResults && images.length === 0) return;

            if (isRecording && recognition) {
                stopRecognition();
            }

            sendBtn.disabled = true;
            const currentUser = getLocalUser();

            // 1. Display user bubble
            let userHtml = `<div class="chat-bubble user-bubble"><div class="user-bubble-content">`;
            if (labResults) userHtml += `<p>${escapeHtml(labResults)}</p>`;
            if (images.length > 0) {
                let imagePreviews = '<div class="user-images-preview">';
                for (let i = 0; i < images.length; i++) {
                    imagePreviews += `<img src="${URL.createObjectURL(images[i])}" alt="user image">`;
                }
                imagePreviews += '</div>';
                userHtml += imagePreviews;
            }
            if (currentUser) {
                userHtml += `<div style="margin-top:8px; font-size:12px; color:var(--text-secondary-color)">Đã gửi bởi: ${escapeHtml(currentUser.username)}</div>`;
            }
            userHtml += `</div></div>`;
            chatMessages.innerHTML += userHtml;

            // 2. Clear input + previews
            chatInput.value = '';
            autoResize(chatInput);
            imagePreviewContainer.innerHTML = '';

            // 3. Create loading bubble
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble bot-bubble';
            chatMessages.appendChild(loadingBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                if (diagnosticMode) {
                    // Diagnose flow
                    const formData = new FormData();
                    if (labResults) formData.append('labResults', labResults);
                    Array.from(images).forEach(img => formData.append('images', img));
                    formData.append('model', useProModel ? 'pro' : 'flash');
                    if (currentUser) formData.append('submittedBy', currentUser.username);

                    const analysisPromise = animateAnalysisSteps(loadingBubble);
                    const fetchPromise = fetch('/api/diagnose', { method: 'POST', body: formData });

                    const [_, response] = await Promise.all([analysisPromise, fetchPromise]);

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: 'Lỗi không xác định từ máy chủ' }));
                        throw new Error(error.error || 'Lỗi không xác định từ máy chủ');
                    }
                    const data = await response.json();
                    displayResults(data, loadingBubble);
                    if (currentUser) fetchAndRenderHistory(currentUser.username);
                } else {
                    // Chat flow
                    const body = { message: labResults, model: useProModel ? 'pro' : 'flash' };
                    if (currentUser) body.submittedBy = currentUser.username;
                    if (images.length > 0) body.imagesCount = images.length;

                    const resp = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({ error: 'Lỗi từ server' }));
                        throw new Error(err.error || 'Lỗi khi gọi /api/chat');
                    }
                    const data = await resp.json();
                    // Render reply (simple)
                    const replyHtml = `<div class="diagnosis-details">${convertMarkdown(data.reply || data.replyText || '')}</div>`;
                    loadingBubble.innerHTML = replyHtml;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    if (currentUser) fetchAndRenderHistory(currentUser.username);
                }
            } catch (error) {
                showError(error.message, loadingBubble);
            } finally {
                sendBtn.disabled = false;
                imageInput.value = '';
            }
        }

        // ------------------------------
        // displayResults for diagnose flows
        // ------------------------------
        function displayResults(data, targetBubble) {
            // if it's a chat-style reply
            if (data.reply) {
                targetBubble.innerHTML = `<div class="diagnosis-details">${convertMarkdown(data.reply)}</div>`;
                return;
            }

            let html = '';

            if (data.confidence !== undefined) {
                html += `
                    <div class="confidence-meter">
                        <div class="confidence-bar" style="width:${Math.max(0, Math.min(100, data.confidence))}%">Độ tin cậy: ${data.confidence}%</div>
                    </div>
                `;
            }

            if (Array.isArray(data.diseases) && data.diseases.length) {
                html += '<h3><i class="fas fa-notes-medical"></i> Khả năng chẩn đoán</h3><div class="disease-list">';
                data.diseases.forEach(d => {
                    const pct = Math.min(d.probability || 0, 100);
                    html += `
                        <div class="disease-item">
                            <strong>${escapeHtml(d.name || '')}</strong>
                            <div class="probability-bar">
                                <div class="probability-fill" style="width:${pct}%"></div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (data.diagnosis) {
                html += `<div class="diagnosis-details">
                    ${convertMarkdown(data.diagnosis)}
                    ${displayReferences(data.references)}
                    <div class="warning">${data.warning || ''}</div>
                </div>`;
            } else if (data.icdDescriptions && data.icdDescriptions.length) {
                html += `<div class="diagnosis-details"><h3>Chẩn đoán phân biệt (ICD)</h3>`;
                data.icdDescriptions.forEach(item => {
                    html += `<div class="disease-item"><strong>${escapeHtml(item.label)}</strong><div>${escapeHtml(item.icdCode || '')} - ${escapeHtml(item.description || '')}</div></div>`;
                });
                html += `</div>`;
            }

            if (data.modelUsed) {
                html += `<div style="margin-top:10px; font-size:12px; color:var(--text-secondary-color)">Đã dùng model: ${escapeHtml(data.modelUsed)}</div>`;
            }

            targetBubble.innerHTML = html;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayReferences(references) {
            if (!references || !references.length) return '';
            return `
                <div class="references-section">
                    <h3><i class="fas fa-book-medical"></i> Tài liệu tham khảo</h3>
                    ${references.map(ref => `
                        <div class="reference-item">
                            <a href="${escapeHtml(ref.url || '#')}" target="_blank" rel="noopener noreferrer">${escapeHtml(ref.title || 'Tài liệu tham khảo')}</a>
                            ${ref.source ? `<div class="reference-source">Nguồn: ${escapeHtml(ref.source)}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showError(message, targetBubble) {
            targetBubble.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Lỗi:</strong> ${escapeHtml(message)}
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function convertMarkdown(text) {
            if (!text) return '';
            let out = text
                .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- (.*)/gm, '<li>$1</li>')
                .replace(/•\s*(.*)/g, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');
            return out;
        }

        // ------------------------------
        // Keyboard send
        // ------------------------------
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendBtn.disabled) submitData();
            }
        });

        // ------------------------------
        // Sidebar resize logic
        // ------------------------------
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('resizer');

        const mouseMoveHandler = function (e) {
            const dx = e.clientX - sidebar.getBoundingClientRect().right;
            const newWidth = sidebar.offsetWidth + dx;
            document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
        };

        const mouseUpHandler = function () {
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            document.body.style.cursor = 'default';
            document.body.style.userSelect = 'auto';
        };

        resizer.addEventListener('mousedown', function (e) {
            e.preventDefault();
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });
    </script>
</body>
</html>
