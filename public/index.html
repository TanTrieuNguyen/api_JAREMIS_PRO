<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JAREMIS - AI Chat</title>
    
    <!-- Favicon - Logo JAREMIS -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="/logo-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/logo-512.png">
    <link rel="apple-touch-icon" href="/favicon.svg">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="JAREMIS - Trợ lý AI y tế thông minh, hỗ trợ chẩn đoán, tư vấn sức khỏe 24/7">
    <meta name="keywords" content="AI y tế, chẩn đoán AI, tư vấn sức khỏe, JAREMIS, trợ lý y tế">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <style>
        :root {
            --sidebar-width: 260px;
            --bg-color: #0d1117;
            --sidebar-bg: #161b22;
            --chat-bg: #010409;
            --input-bg: #161b22;
            --bot-bubble-bg: #161b22;
            --user-bubble-bg: #003666;
            --text-color: #c9d1d9;
            --text-secondary-color: #8b949e;
            --border-color: #30363d;
            --accent-color: #2f81f7;
            --error-color: #f85149;
            --success-color: #238636;
            --who-bg: #212013;
            --mic-red: #ff4d4d;

            --auth-offset-top: 12px;
            --auth-offset-height: 48px; /* chiều cao ước lượng vùng auth (để chừa khoảng trống) */
            --mobile-header-height: 56px; /* chiều cao header mobile (nếu hiện) */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Hide mobile-only toggles on desktop */
        .mobile-header { display: none; }
        #history-drawer-toggle { display: none; }

        .chat-container { display: flex; width: 100%; height: 100%; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 200px;
            max-width: 500px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 16px;
            transition: width 0.1s ease-out;
            flex-shrink: 0;
        }
        .resizer { width: 5px; cursor: col-resize; background-color: transparent; flex-shrink: 0; position: relative; z-index: 10; }
        .resizer:hover { background-color: var(--accent-color); }

        .sidebar-header {
          display:flex;
          flex-direction:column;
          align-items:stretch;
          gap:8px;
          margin-bottom:12px;
        }

        .new-chat-btn {
            display:flex; align-items:center; gap:8px; width:100%; padding:10px; background:transparent; color:var(--text-color);
            border:1px solid var(--border-color); border-radius:6px; font-size:14px; cursor:pointer;
        }
        .new-chat-btn:hover { background-color:#2c313a; }

        .history { flex-grow:1; overflow-y:auto; margin-top:10px; }
        .history h3 { font-size:12px; color:var(--text-secondary-color); margin-bottom:8px; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; }
        .history ul { list-style:none; padding:0; display:flex; flex-direction:column; gap:6px; }
        .history li { 
          padding:8px; 
          border-radius:6px; 
          cursor:pointer; 
          color:var(--text-color); 
          background:transparent; 
          border:1px solid transparent; 
          font-size:13px; 
          display:flex; 
          justify-content:space-between; 
          align-items:center;
          position:relative;
        }
        .history li:hover { background:#111720; border-color:var(--border-color); }
        .history li .history-title { flex-grow:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .history li .history-menu-btn { 
          opacity:0; 
          padding:4px 8px; 
          background:transparent; 
          border:none; 
          color:var(--text-secondary-color); 
          cursor:pointer; 
          border-radius:4px;
          font-size:16px;
        }
        .history li:hover .history-menu-btn { opacity:1; }
        .history li .history-menu-btn:hover { background:#2c313a; color:var(--text-color); }
        
        /* Dropdown menu cho history item */
        .history-dropdown {
          position:absolute;
          top:100%;
          right:0;
          background:var(--sidebar-bg);
          border:1px solid var(--border-color);
          border-radius:6px;
          padding:4px;
          display:none;
          z-index:1000;
          min-width:160px;
          box-shadow:0 4px 12px rgba(0,0,0,0.3);
        }
        .history-dropdown.show { display:block; }
        .history-dropdown button {
          width:100%;
          padding:8px 12px;
          background:transparent;
          border:none;
          color:var(--text-color);
          text-align:left;
          cursor:pointer;
          border-radius:4px;
          font-size:13px;
          display:flex;
          align-items:center;
          gap:8px;
        }
        .history-dropdown button:hover { background:#2c313a; }
        .history-dropdown button i { width:16px; }
        
        /* Search tabs */
        .search-tab:hover { background:#2c313a !important; }
        .search-tab.active { border-bottom-color:var(--accent-color) !important; color:var(--accent-color) !important; }
        
        /* Search results */
        .search-result-item {
          padding:12px;
          background:var(--input-bg);
          border:1px solid var(--border-color);
          border-radius:6px;
          margin-bottom:8px;
          cursor:pointer;
          transition:all 0.2s;
        }
        .search-result-item:hover { background:#2c313a; border-color:var(--accent-color); }
        .search-result-question {
          font-size:14px;
          color:var(--text-color);
          margin-bottom:4px;
          font-weight:500;
        }
        .search-result-meta {
          font-size:12px;
          color:var(--text-secondary-color);
          display:flex;
          align-items:center;
          gap:8px;
        }
        .search-highlight {
          background:rgba(255,255,0,0.3);
          padding:2px 4px;
          border-radius:2px;
        }
        .sidebar-footer { font-size:12px; color:var(--text-secondary-color); text-align:center; margin-top:10px; }

        /* Account Section */
        .account-section {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .account-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        .account-info:hover {
            background: #2c313a;
        }
        .account-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            object-fit: cover;
        }
        .account-details {
            flex-grow: 1;
            min-width: 0;
        }
        .account-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .account-role {
            font-size: 12px;
            color: var(--text-secondary-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #account-chevron {
            color: var(--text-secondary-color);
            font-size: 12px;
            transition: transform 0.2s;
        }
        .account-info.open #account-chevron {
            transform: rotate(180deg);
        }
        .account-dropdown {
            display: none;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
            padding: 4px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        .account-dropdown.show {
            display: flex;
        }
        .account-dropdown button {
            width: 100%;
            padding: 10px 12px;
            background: transparent;
            border: none;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        .account-dropdown button:hover {
            background: #2c313a;
        }
        .account-dropdown button i {
            width: 18px;
            text-align: center;
        }

        /* Mode Selection Menu */
        .mode-menu-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 150;
            animation: fadeIn 0.2s;
        }
        .mode-menu-backdrop.show {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .mode-menu {
            background: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            min-width: 320px;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .mode-menu h3 {
            margin-bottom: 16px;
            font-size: 18px;
            color: var(--text-color);
            text-align: center;
        }
        .mode-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .mode-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--input-bg);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-option:hover {
            background: #2c313a;
            border-color: var(--border-color);
        }
        .mode-option.active {
            border-color: var(--accent-color);
            background: rgba(47,129,247,0.1);
        }
        .mode-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(47,129,247,0.15);
            border-radius: 10px;
            font-size: 24px;
            color: var(--accent-color);
        }
        .mode-option.active .mode-icon {
            background: var(--accent-color);
            color: white;
        }
        .mode-info {
            flex-grow: 1;
        }
        .mode-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }
        .mode-desc {
            font-size: 13px;
            color: var(--text-secondary-color);
            line-height: 1.4;
        }
        .mode-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            transition: all 0.2s;
        }
        .mode-option.active .mode-check {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
        }

        /* Professional Mode - Patient Records */
        .professional-records {
            display: none;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
            max-height: 40vh;
            overflow-y: auto;
        }
        .professional-records.show {
            display: flex;
        }
        .record-item {
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .record-item:hover {
            background: #2c313a;
            border-color: var(--accent-color);
        }
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .record-patient {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }
        .record-date {
            font-size: 12px;
            color: var(--text-secondary-color);
        }
        .record-summary {
            font-size: 13px;
            color: var(--text-secondary-color);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Chat area */
        .chat-area {
            position: relative; /* Đảm bảo lớp nền phủ đúng */
            flex-grow:1; display:flex; flex-direction:column; background-color:var(--chat-bg); border-left:1px solid var(--border-color); /* position:relative; */
        }
        .chat-messages {
          flex-grow:1;
          padding:24px;
          overflow-y:auto;
          display:flex;
          flex-direction:column;
          gap:20px;
          background: transparent;          /* đảm bảo không che nền */
          scrollbar-color: var(--accent-color) transparent; /* Firefox */
          scrollbar-width: thin;
        }

        /* Scrollbar WebKit (Chrome / Edge) */
        .chat-messages::-webkit-scrollbar {
          width: 10px;
        }
        .chat-messages::-webkit-scrollbar-track {
          background: transparent;          /* trong suốt để lộ nền & canvas tuyết */
        }
        .chat-messages::-webkit-scrollbar-thumb {
          background: linear-gradient(180deg, rgba(47,129,247,0.55), rgba(47,129,247,0.25));
          border-radius: 20px;
          border: 2px solid rgba(0,0,0,0);  /* tạo khoảng cách thị giác */
          min-height: 40px;
          transition: background .25s;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(180deg, rgba(47,129,247,0.85), rgba(47,129,247,0.45));
        }
        .chat-messages::-webkit-scrollbar-corner {
          background: transparent;
        }
        /* (Tuỳ chọn) Ẩn hẳn khi không hover:
        .chat-messages::-webkit-scrollbar { width: 0; }
        */

        .chat-bubble { max-width:80%; padding:16px; border-radius:12px; line-height:1.6; word-wrap:break-word; }
        .bot-bubble { background-color:var(--bot-bubble-bg); align-self:flex-start; border:1px solid var(--border-color); }
        .user-bubble { background-color:var(--user-bubble-bg); align-self:flex-end; color:#fff; }

        /* Professional Consultation Styling */
        .professional-consultation {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.8;
            color: var(--text-color);
        }
        
        .professional-consultation h1,
        .professional-consultation h2,
        .professional-consultation h3 {
            color: var(--accent-color);
            margin-top: 24px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .professional-consultation h1 { font-size: 24px; border-bottom: 2px solid var(--border-color); padding-bottom: 8px; }
        .professional-consultation h2 { font-size: 20px; }
        .professional-consultation h3 { font-size: 18px; }
        
        .professional-consultation p {
            margin-bottom: 12px;
            color: var(--text-color);
        }
        
        .professional-consultation table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .professional-consultation table th {
            background: rgba(47,129,247,0.15);
            color: var(--accent-color);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }
        
        .professional-consultation table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .professional-consultation table tr:last-child td {
            border-bottom: none;
        }
        
        .professional-consultation table tr:hover {
            background: rgba(255,255,255,0.03);
        }
        
        .professional-consultation ul,
        .professional-consultation ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .professional-consultation li {
            margin-bottom: 8px;
        }
        
        .professional-consultation code {
            background: rgba(110,118,129,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .professional-consultation pre {
            background: rgba(110,118,129,0.15);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
        }
        
        .professional-consultation pre code {
            background: none;
            padding: 0;
        }
        
        .professional-consultation blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary-color);
            font-style: italic;
        }
        
        .professional-consultation strong {
            color: var(--text-color);
            font-weight: 600;
        }
        
        .professional-consultation em {
            color: var(--text-secondary-color);
        }
        
        .professional-consultation hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 24px 0;
        }

        .user-bubble-content p { margin-bottom:12px; }
        .user-images-preview { display:flex; gap:10px; flex-wrap:wrap; }
        .user-images-preview img { width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid var(--border-color); }

        .chat-input-area { padding:16px 24px; border-top:1px solid var(--border-color); display:flex; flex-direction:column; gap:8px; }
        .input-wrapper { position:relative; display:flex; align-items:center; background-color:var(--input-bg); border:1px solid var(--border-color); border-radius:8px; padding:8px; gap:8px; }

        #chat-input { flex-grow:1; background:transparent; border:none; color:var(--text-color); font-size:16px; padding:8px; resize:none; max-height:200px; overflow-y:auto; }
        #chat-input:focus { outline:none; }

        .input-actions { display:flex; align-items:center; gap:8px; }
        .action-btn {
            background:none; border:none; color:var(--text-secondary-color); font-size:20px; cursor:pointer; width:40px; height:40px; border-radius:6px;
            display:flex; align-items:center; justify-content:center;
        }
        .action-btn:hover { background-color:#2c313a; color:var(--text-color); }
        #send-btn { background-color:var(--accent-color); color:white; border-radius:6px; width:44px; height:40px; display:flex; align-items:center; justify-content:center; }
        #send-btn:disabled { background-color:#30363d; cursor:not-allowed; }
        
        /* Stop button styling */
        #stop-btn { 
            background-color: var(--error-color); 
            color: white; 
            border-radius: 6px; 
            width: 44px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            animation: pulse 2s infinite;
        }
        #stop-btn:hover { 
            background-color: #ff6b6b; 
            transform: scale(1.05);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(248, 81, 73, 0); }
            100% { box-shadow: 0 0 0 0 rgba(248, 81, 73, 0); }
        }

        #image-preview-container { display:flex; gap:10px; margin-top:10px; padding:0 8px; }
        .preview-item { position:relative; }
        .preview-item img { width:60px; height:60px; object-fit:cover; border-radius:6px; }
        .remove-btn { position:absolute; top:-5px; right:-5px; background:var(--error-color); color:white; border:none; width:20px; height:20px; border-radius:50%; cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center; }

        /* Analysis steps */
        .analysis-steps { display:flex; flex-direction:column; gap:12px; }
        .step-item { display:flex; align-items:center; gap:12px; font-size:14px; transition:color 0.3s ease; }
        .step-item .icon { width:20px; text-align:center; }
        .step-item.pending { color:var(--text-secondary-color); }
        .step-item.active { color:var(--text-color); font-weight:600; }
        .step-item.completed { color:var(--success-color); }
        .fa-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }

        /* Result */
        .error-message { color:var(--error-color); }
        .confidence-meter { background:#2c313a; border-radius:20px; height:24px; margin:16px 0; overflow:hidden; position:relative; }
        .confidence-bar { background:var(--success-color); height:100%; display:flex; align-items:center; padding-left:12px; color:white; font-weight:bold; font-size:12px; transition: width 0.5s ease; }

        .disease-list { margin:20px 0; display:flex; flex-direction:column; gap:15px; }
        .disease-item { border-left:3px solid var(--accent-color); padding-left:15px; }
        .probability-bar { height:8px; background:#30363d; border-radius:10px; overflow:hidden; margin-top:8px; }
        .probability-fill { height:100%; background:var(--accent-color); transition:width 0.5s ease; }

        .diagnosis-details h2, .diagnosis-details h3 { border-bottom:1px solid var(--border-color); padding-bottom:8px; margin:20px 0 10px 0; font-size:1.1em; }
        .references-section { margin-top:25px; padding:15px; background:rgba(47,129,247,0.1); border-radius:8px; }
        .reference-item { margin-top:10px; }
        .reference-item a { color:var(--accent-color); text-decoration:none; }
        .reference-item a:hover { text-decoration:underline; }
        .reference-source { font-size:0.8em; color:var(--text-secondary-color); margin-top:4px; }

        .warning { margin-top:20px; padding:12px; background:var(--who-bg); border-left:4px solid #f1e05a; color:#d4c873; font-size:14px; border-radius:4px; }
        .warning strong { color:#f1e05a; }

        /* Think button style */
        #think-btn { background:none; border:1px solid var(--border-color); border-radius:6px; padding:6px 8px; color:var(--text-secondary-color); cursor:pointer; width:auto; height:40px; display:flex; align-items:center; justify-content:center; }
        #think-btn.active { background: linear-gradient(90deg, rgba(47,129,247,0.12), rgba(47,129,247,0.06)); color:var(--text-color); border-color: rgba(47,129,247,0.6); }
        #model-status { font-size:12px; color:var(--text-secondary-color); margin-left:8px; align-self:center; }

        /* Mic button style - Multi-language support */
        #mic-btn { 
            background:none; 
            border:1px solid var(--border-color); 
            border-radius:6px; 
            padding:6px 8px; 
            color:var(--text-secondary-color); 
            cursor:pointer; 
            width:auto; 
            height:40px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            position: relative;
            transition: all 0.2s ease;
        }
        #mic-btn:hover {
            background: rgba(255,255,255,0.05);
            border-color: var(--accent-color);
        }
        #mic-btn.recording { 
            background: rgba(255,77,77,0.12); 
            color: var(--text-color); 
            border-color: rgba(255,77,77,0.5); 
            box-shadow: 0 0 8px rgba(255,77,77,0.12); 
        }
        #mic-indicator {
            width:18px; 
            height:18px; 
            border-radius:50%; 
            background: transparent;
            margin-left:6px; 
            display:none; 
            font-size: 14px;
            line-height: 18px;
            text-align: center;
            animation: pulse 1.2s infinite;
        }
        #mic-btn.recording #mic-indicator { 
            display: inline-block;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.2); opacity: 0.6; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        /* Language selection menu */
        #lang-menu {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        #lang-menu::-webkit-scrollbar {
            width: 6px;
        }
        #lang-menu::-webkit-scrollbar-track {
            background: transparent;
        }
        #lang-menu::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        #lang-menu::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        /* Auth UI (top-right) */
        .auth-controls {
            position: fixed !important;
            top: var(--auth-offset-top) !important;
            right: 18px !important;
            bottom: auto !important;
            display: flex;
            gap: 8px;
            align-items: center;
            z-index: 120; /* cao hơn header & bong bóng */
            flex-direction: row !important;
        }
        @media (max-width:600px) {
            .auth-controls { right: 10px; }
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal-backdrop.show {
            display: flex;
        }
        .modal {
            background: #0b1116;
            border: 1px solid var(--border-color);
            padding: 18px;
            border-radius: 10px;
            width: 360px;
            max-width: 92%;
            color: var(--text-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .modal h3 { margin-bottom: 10px; font-size: 18px; }
        .tabs { display:flex; gap:8px; margin-bottom:12px; }
        .tab { padding:8px 12px; border-radius:6px; cursor:pointer; background:transparent; color:var(--text-secondary-color); border:1px solid transparent; }
        .tab.active { background: rgba(47,129,247,0.12); color:var(--text-color); border-color: rgba(47,129,247,0.2); }
        .form-row { margin-bottom:10px; display:flex; flex-direction:column; gap:6px; }
        .form-row input { background: #071018; border: 1px solid var(--border-color); color: var(--text-color); padding:8px 10px; border-radius:6px; }
        .form-actions { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; }
        .btn-primary { background: var(--accent-color); color: #fff; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
        .btn-ghost { background:transparent; color:var(--text-secondary-color); border:1px solid var(--border-color); padding:8px 10px; border-radius:6px; cursor:pointer; }

        .small-muted { font-size:12px; color:var(--text-secondary-color); margin-top:8px; }

        /* Base (desktop) – giữ hàng ngang cho tool buttons */
        .tool-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toggle-tools-btn {
            display: none; /* Chỉ hiện trên mobile */
        }

        /* Auth buttons styling */
        .auth-controls .auth-btn {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            line-height: 1.2;
            backdrop-filter: blur(4px);
            transition: background .18s, border-color .18s, color .18s;
        }
        .auth-controls .auth-btn:hover {
            background: rgba(47,129,247,0.16);
            border-color: var(--accent-color);
            color: #fff;
        }
        .auth-controls .auth-btn:active {
            background: rgba(47,129,247,0.28);
        }

        /* small responsive */
        @media (max-width: 900px) {
            .sidebar { display:none; }
            .resizer { display:none; }
            .auth-controls { right: 8px; top: 8px; }
            
            /* Table responsive on tablet */
            .bot-bubble table {
                font-size: 12px;
            }
            .bot-bubble table th {
                padding: 12px 10px;
                font-size: 12px;
            }
            .bot-bubble table td {
                padding: 10px 8px;
                font-size: 12px;
            }
        }

        /* Mobile-specific overrides */
        @media (max-width: 600px) {
            /* layout becomes column for small screens */
            .chat-container { flex-direction:column; }
            .mobile-header { display:flex; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid var(--border-color); background:var(--chat-bg); position:sticky; top:0; z-index:70; }
            .mobile-header .title { color:var(--text-color); font-weight:600; font-size:16px; flex:1; text-align:center; }
            .hamburger { background:transparent; border:1px solid var(--border-color); color:var(--text-secondary-color); width:44px; height:44px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; }
            /* Sidebar becomes overlay (hidden by default) */
            .sidebar { display:flex; position:fixed; top:0; left:0; bottom:0; width:78%; max-width:360px; transform:translateX(-120%); transition: transform 0.22s ease; z-index:80; box-shadow:6px 0 30px rgba(0,0,0,0.6); }
            .sidebar.mobile-open { transform:translateX(0); }
            .sidebar-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:75; display:none; }
            .sidebar-backdrop.show { display:block; }
            /* hide resizer (not needed) */
            .resizer { display:none; }
            /* Chat area sizing */
            .chat-area { flex:1 1 auto; min-height: calc(100vh - 56px); }
            .chat-messages { padding: 12px; padding-bottom:160px; overflow-y:auto; }
            /* Fix input to bottom and respect safe-area */
            .chat-input-area { position:fixed; left:0; right:0; bottom:env(safe-area-inset-bottom, 0); padding:8px 10px; background:linear-gradient(180deg, rgba(1,4,9,0.98), rgba(1,4,9,1)); z-index:70; border-top:1px solid var(--border-color); }
            .input-wrapper { padding:6px; gap:6px; }
            #chat-input { font-size:15px; padding:8px; max-height:120px; }
            .input-actions .action-btn { width:40px; height:40px; font-size:16px; }
            #send-btn { width:44px; height:40px; border-radius:8px; }
            /* Adjust auth controls so they don't overlap mobile input */
            .auth-controls { position:fixed; right:10px; bottom:110px; top:auto; z-index:69; display:flex; flex-direction:column; gap:8px; }
            /* Slightly reduce bubble max-width for narrow screens */
            .chat-bubble { max-width:94%; }
            
            /* Table responsive on mobile */
            .bot-bubble table {
                font-size: 12px; /* Smaller font on mobile */
                display: block;
                overflow-x: auto; /* Allow horizontal scroll if needed */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }
            .bot-bubble table th {
                padding: 10px 8px;
                font-size: 11px;
                line-height: 1.3;
            }
            .bot-bubble table td {
                padding: 8px 6px;
                font-size: 11px;
                line-height: 1.4;
                min-width: 80px; /* Minimum width per column */
            }
        }

        /* Even smaller devices: compact spacing & font sizes */
        @media (max-width: 420px) {
            .mobile-header { padding:6px 8px; }
            .mobile-header .title { font-size:14px; }
            .new-chat-btn span { display:none; } /* icon only to save space */
            .sidebar { width:84%; max-width:300px; }
            .chat-messages { padding:10px; padding-bottom:150px; gap:12px; }
            .input-actions .action-btn { width:38px; height:38px; font-size:15px; }
            #chat-input { font-size:14px; }
        }

        @media (max-width: 360px) {
            .mobile-header .title { font-size:13px; }
            .hamburger { width:40px; height:40px; }
            .auth-controls { right:8px; bottom:120px; }
            .chat-input-area { padding:8px; }
            .chat-messages { padding-bottom:140px; }
        }

        /* Compact tools (mobile) */
        @media (max-width:600px) {
            .input-wrapper {
                position: relative;
            }
            .toggle-tools-btn {
                display:flex !important;
            }
            .tool-buttons {
                display:flex;
                align-items:center;
                gap:6px;
                transition:opacity .18s ease, transform .18s ease;
            }
            .tool-buttons.collapsed {
                opacity:0;
                pointer-events:none;
                transform:translateY(4px);
                position:absolute;
                left:8px;
                right:60px;
                bottom:100%;
                /* hidden */
            }
            .mobile-tools-active .tool-buttons {
                opacity:1;
                transform:translateY(0);
                position:absolute;
                left:8px;
                right:60px;
                bottom:100%;
                background:rgba(22,27,34,0.95);
                padding:6px 8px;
                border:1px solid var(--border-color);
                border-radius:10px;
                box-shadow:0 4px 18px rgba(0,0,0,0.55);
                z-index:90;
            }
            .tool-buttons .action-btn {
                width:38px;
                height:38px;
                font-size:16px;
            }
            .toggle-tools-btn {
                display:flex;
                background:none;
                border:1px solid var(--border-color);
                width:40px;
                height:40px;
                border-radius:8px;
                align-items:center;
                justify-content:center;
                color:var(--text-secondary-color);
                cursor:pointer;
            }
            .toggle-tools-btn.active {
                background:rgba(47,129,247,0.15);
                color:var(--text-color);
                border-color:var(--accent-color);
            }
            /* Khi bàn phím mở (class keyboard-open gắn vào body) -> ép thu gọn */
            body.keyboard-open .tool-buttons:not(.force-open) {
                opacity:0;
                pointer-events:none;
                transform:translateY(4px);
            }
        }

        /* Nút toggle lịch sử trên mobile */
        #history-toggle-btn {
            display:none;
            background:transparent;
            border:1px solid var(--border-color);
            color:var(--text-secondary-color);
            padding:6px 10px;
            border-radius:8px;
            font-size:13px;
            cursor:pointer;
        }
        #history-toggle-btn.active {
            background:rgba(47,129,247,0.15);
            color:var(--text-color);
            border-color:var(--accent-color);
        }
        @media (max-width:600px) {
          #history-toggle-btn { display:inline-flex; align-items:center; gap:6px; }
        }

        /* Dual pane (landscape + đủ rộng) */
        @media (max-width:900px) and (orientation:landscape) and (min-width:640px) {
          body.dual-pane .sidebar {
              position:relative;
              transform:translateX(0) !important;
              width:230px;
              box-shadow:none;
          }
          body.dual-pane .sidebar-backdrop { display:none !important; }
          body.dual-pane .chat-area { min-height:100vh; }
          body.dual-pane #mobile-header { padding-right:0; }
          body.dual-pane #history-toggle-btn { display:none; }
        }
        /* Hiệu ứng vuốt (gợi ý) – chỉ chiều ngang */
        .sidebar {
           touch-action: pan-y;
        }

        @media (max-width:600px) {
          .history-drawer-toggle {
              position:fixed;
              top:50%;
              left:4px;
              transform:translateY(-50%);
              z-index:90;
              width:34px;
              height:52px;
              background:rgba(22,27,34,0.88);
              border:1px solid var(--border-color);
              border-left:none;
              border-radius:0 10px 10px 0;
              display:flex;
              align-items:center;
              justify-content:center;
              color:var(--text-secondary-color);
              cursor:pointer;
              backdrop-filter:blur(4px);
              transition:background .18s, color .18s;
          }
          .history-drawer-toggle:hover { background:rgba(47,129,247,0.15); color:var(--text-color); }
          .history-drawer-toggle.open { left: calc(78% - 18px); border-left:1px solid var(--border-color); border-radius:10px 0 0 10px; }
        }

        /* Phóng to nút history ≡ */
.history-top-toggle .history-icon,
.history-drawer-toggle .history-icon {
    font-size: 26px; /* tăng gấp ~2 lần so với font-awesome mặc định 14–16px */
    line-height: 1;
    display:inline-block;
    transform: translateY(-1px);
    letter-spacing:2px;
    font-weight:600;
}
.history-top-toggle,
.history-drawer-toggle {
    width:46px !important;
    height:46px !important;
}

/* Compact white triple bars button */
.history-top-toggle,
.history-drawer-toggle {
    background: var(--chat-bg) !important; /* trùng nền chính */
    border: 1px solid var(--border-color);
    box-shadow: 0 0 0 0 transparent;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
}
.history-top-toggle:hover,
.history-drawer-toggle:hover {
    border-color: var(--accent-color);
    background: var(--chat-bg);
}
.history-top-toggle .bars,
.history-drawer-toggle .bars {
    display:flex;
    flex-direction:column;
    gap:5px;
    width:26px;
    height:22px;
    align-items:flex-start;
    justify-content:center;
}
.history-top-toggle .bar,
.history-drawer-toggle .bar {
    display:block;
    height:2px;              /* thon hơn */
    width:22px;
    background:#fff;          /* màu trắng */
    border-radius:2px;
    transition:width .25s ease, background .25s;
}
.history-top-toggle .bar:nth-child(2),
.history-drawer-toggle .bar:nth-child(2){
    width:18px;               /* giữa ngắn hơn nhẹ */
}
.history-top-toggle .bar:nth-child(3),
.history-drawer-toggle .bar:nth-child(3){
    width:14px;               /* dưới ngắn hơn nữa */
}
.history-top-toggle.open .bar,
.history-drawer-toggle.open .bar {
    background: var(--accent-color);
    width:22px;               /* khi mở đồng nhất chiều dài */
}
.history-top-toggle.open .bar:nth-child(2){
    width:22px;
}
.history-top-toggle.open .bar:nth-child(3){
    width:22px;
}
/* Ẩn style cũ của .history-icon nếu còn */
.history-icon { display:none !important; }

/* Override: loại viền trắng mờ nút history */
.history-top-toggle,
.history-drawer-toggle {
    border: 1px solid var(--chat-bg) !important; /* trùng nền -> coi như mất viền */
}

.history-top-toggle:hover,
.history-drawer-toggle:hover,
.history-top-toggle.open,
.history-drawer-toggle.open {
    border: 1px solid var(--border-color) !important; /* chỉ hiện viền khi hover / mở */
}

/* (Tuỳ chọn) nếu muốn bỏ hẳn viền luôn:
.history-top-toggle,
.history-drawer-toggle { border:0 !important; }
.history-top-toggle:hover,
.history-drawer-toggle:hover { border:0 !important; }
*/
/* Thêm ngay sau <body> */
.bg-animation {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 0; /* nằm dưới các chat bubble */
}
.particle {
    position: absolute;
    width: 4px; height: 4px;
    background: #8b5cf6;
    border-radius: 50%;
    animation: float 20s infinite linear;
    box-shadow: 0 0 10px #8b5cf6;
}
.particle:nth-child(1) { left: 20%; animation-delay: 0s; animation-duration: 15s; }
.particle:nth-child(2) { left: 40%; animation-delay: 5s; animation-duration: 20s; background: #7c3aed; box-shadow: 0 0 10px #7c3aed; }
.particle:nth-child(3) { left: 60%; animation-delay: 10s; animation-duration: 25s; background: #a78bfa; box-shadow: 0 0 10px #a78bfa; }
.particle:nth-child(4) { left: 80%; animation-delay: 15s; animation-duration: 18s; }
.particle:nth-child(5) { left: 10%; animation-delay: 8s; animation-duration: 22s; background: #7c3aed; box-shadow: 0 0 10px #7c3aed; }
@keyframes float {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
}

/* Snowfall animation */
.particle.snowflake {
    border-radius: 50%;
    box-shadow: 0 0 8px #fff;
    position: absolute;
    animation: snow-fall linear infinite;
}
@keyframes snow-fall {
    0% { transform: translateY(-10vh); opacity: 0.8; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(110vh); opacity: 0.2; }
}
#snow-canvas { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:0; }
.chat-messages, .chat-bubble { position:relative; z-index:2; } /* đảm bảo tuyết không đè lên */

/* Website buttons container - ChatGPT style */
.websites-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 16px;
    padding: 0;
}

/* Individual website button - như ChatGPT */
.website-button {
    display: inline-block;
    border-radius: 8px;
    overflow: hidden;
    background: rgba(88, 166, 255, 0.05);
    border: 1px solid rgba(88, 166, 255, 0.15);
    transition: all 0.2s ease;
    animation: websiteButtonFadeIn 0.3s ease-out;
}

.website-button:hover {
    background: rgba(88, 166, 255, 0.1);
    border-color: rgba(88, 166, 255, 0.3);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(88, 166, 255, 0.15);
}

.website-button:active {
    transform: translateY(0);
}

.website-link {
    display: flex !important;
    align-items: center !important;
    padding: 8px 12px !important;
    text-decoration: none !important;
    color: var(--text-color) !important;
    gap: 8px !important;
    min-width: 0;
    transition: none !important;
}

.website-icon {
    position: relative;
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.website-icon img {
    width: 16px;
    height: 16px;
    border-radius: 2px;
    object-fit: contain;
}

.website-fallback-icon {
    display: none;
    font-size: 14px;
    line-height: 1;
}

.website-name {
    font-size: 13px !important;
    font-weight: 500 !important;
    color: var(--text-color) !important;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
}

/* Staggered animation */
.website-button:nth-child(1) { animation-delay: 0.1s; }
.website-button:nth-child(2) { animation-delay: 0.15s; }
.website-button:nth-child(3) { animation-delay: 0.2s; }
.website-button:nth-child(4) { animation-delay: 0.25s; }
.website-button:nth-child(5) { animation-delay: 0.3s; }

@keyframes websiteButtonFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* ========== BEAUTIFUL TABLE & HEADING STYLES ========== */

/* Markdown tables in chat bubbles */
.bot-bubble table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
    background: rgba(13, 17, 23, 0.5);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    table-layout: fixed; /* FIXED LAYOUT for equal column widths */
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
}

.bot-bubble table thead {
    background: linear-gradient(135deg, #1f6feb 0%, #0969da 100%);
}

.bot-bubble table th {
    padding: 14px 12px;
    text-align: center; /* Center align headers */
    font-weight: 600;
    color: #fff;
    font-size: 13px;
    letter-spacing: 0.3px;
    border-bottom: 2px solid rgba(47, 129, 247, 0.3);
    white-space: normal; /* Allow text wrapping */
    overflow: visible;
    word-wrap: break-word;
    hyphens: auto;
}

.bot-bubble table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-color);
    font-size: 13px;
    line-height: 1.5;
    text-align: center; /* Center align data */
    white-space: normal; /* Allow text wrapping for full content */
    overflow: visible;
    word-wrap: break-word;
    hyphens: auto;
    vertical-align: top; /* Align content to top when multi-line */
}

/* First column (usually time/label) - left align */
.bot-bubble table td:first-child,
.bot-bubble table th:first-child {
    text-align: left;
    font-weight: 500;
}

.bot-bubble table tbody tr:hover {
    background: rgba(47, 129, 247, 0.1);
    transition: background 0.2s ease;
}

.bot-bubble table tbody tr:last-child td {
    border-bottom: none;
}

/* Alternating row colors for better readability (like Excel) */
.bot-bubble table tbody tr:nth-child(even) {
    background: rgba(13, 17, 23, 0.3);
}

.bot-bubble table tbody tr:nth-child(odd) {
    background: rgba(13, 17, 23, 0.15);
}

/* Emoji headers - phân cấp màu rõ ràng, không lạm dụng xanh dạ quang */
.bot-bubble h1, .bot-bubble h2, .bot-bubble h3, .bot-bubble h4 {
    margin: 24px 0 16px 0;
    font-weight: 700;
    line-height: 1.3;
    display: flex;
    align-items: center;
    gap: 8px;
}

.bot-bubble h1 {
    font-size: 26px;
    color: #58a6ff; /* Xanh chủ đạo - CHỈ cho H1 */
    padding-bottom: 12px;
    border-bottom: 2px solid rgba(88, 166, 255, 0.3);
    margin-top: 28px;
}

.bot-bubble h2 {
    font-size: 22px;
    color: #79c0ff; /* Xanh nhạt hơn - cho H2 */
    margin-top: 24px;
}

.bot-bubble h3 {
    font-size: 18px;
    color: #a5d6ff; /* Xanh pastel - cho H3 */
    margin-top: 20px;
}

.bot-bubble h4 {
    font-size: 16px;
    color: #c9d1d9; /* Xám sáng - cho H4 */
    margin-top: 16px;
}

/* Styled lists - phân cấp màu theo level */
.bot-bubble ul, .bot-bubble ol {
    margin: 16px 0;
    padding-left: 24px;
}

.bot-bubble li {
    margin: 10px 0;
    line-height: 1.7;
    color: var(--text-color); /* Màu text thường, KHÔNG xanh dạ quang */
}

/* List markers phân cấp màu */
.bot-bubble ul > li::marker {
    color: #58a6ff; /* Level 1: xanh dạ quang */
}

.bot-bubble ul ul > li::marker {
    color: #79c0ff; /* Level 2: xanh nhạt hơn */
}

.bot-bubble ul ul ul > li::marker {
    color: #a5d6ff; /* Level 3: xanh pastel */
}

.bot-bubble ol > li::marker {
    color: #58a6ff; /* Ordered list level 1: xanh dạ quang */
    font-weight: 600;
}

.bot-bubble ol ol > li::marker {
    color: #79c0ff; /* Ordered list level 2 */
}

.bot-bubble ol ol ol > li::marker {
    color: #a5d6ff; /* Ordered list level 3 */
}

/* Paragraphs - spacing tốt */
.bot-bubble p {
    margin: 12px 0;
    line-height: 1.7;
}

/* First paragraph no top margin */
.bot-bubble p:first-child {
    margin-top: 0;
}

/* Citations section - đẹp, nổi bật */
.bot-bubble h2:has-text('📚'), 
.bot-bubble h3:has-text('📚'),
.bot-bubble p:contains('📚 Nguồn tham khảo') {
    margin-top: 28px;
    padding-top: 20px;
    border-top: 1px solid rgba(47, 129, 247, 0.3);
}

/* Links in citations */
.bot-bubble a {
    color: #58a6ff;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
}

.bot-bubble a:hover {
    color: #79c0ff;
    border-bottom-color: #79c0ff;
}

/* Citation buttons - nút bấm đẹp cho nguồn tham khảo */
.bot-bubble a.citation-btn {
    display: inline-block;
    padding: 6px 12px;
    margin: 4px 4px 4px 0;
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.15) 0%, rgba(88, 166, 255, 0.08) 100%);
    border: 1px solid rgba(88, 166, 255, 0.3);
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    color: #58a6ff;
    text-decoration: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.bot-bubble a.citation-btn:hover {
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.25) 0%, rgba(88, 166, 255, 0.15) 100%);
    border-color: rgba(88, 166, 255, 0.5);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(88, 166, 255, 0.2);
    color: #79c0ff;
}

.bot-bubble a.citation-btn::before {
    content: '📚 ';
    margin-right: 4px;
}

.bot-bubble a.citation-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* Code blocks */
.bot-bubble code {
    background: rgba(13, 17, 23, 0.7);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    color: #a5d6ff; /* Xanh pastel, KHÔNG dùng #79c0ff */
}

.bot-bubble pre {
    background: rgba(13, 17, 23, 0.7);
    padding: 16px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 16px 0;
}

.bot-bubble pre code {
    background: none;
    padding: 0;
}

/* Horizontal rules */
.bot-bubble hr {
    border: none;
    border-top: 1px solid var(--border-color);
    margin: 20px 0;
}

/* Strong emphasis - KHÔNG dùng xanh dạ quang */
.bot-bubble strong {
    font-weight: 600;
    color: #e6edf3; /* Trắng sáng, nổi bật nhưng không chói */
}

/* Result box - Khung kết quả đẹp cho đáp án cuối cùng */
.bot-bubble .result-box {
    margin: 20px 0;
    padding: 16px 20px;
    background: linear-gradient(135deg, rgba(88, 166, 255, 0.12) 0%, rgba(88, 166, 255, 0.05) 100%);
    border: 2px solid rgba(88, 166, 255, 0.35);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(88, 166, 255, 0.15);
    position: relative;
    overflow: hidden;
}

.bot-bubble .result-box::before {
    content: '✓';
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 28px;
    color: rgba(88, 166, 255, 0.2);
    font-weight: bold;
}

.bot-bubble .result-box .result-label {
    font-size: 13px;
    font-weight: 600;
    color: #58a6ff;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.bot-bubble .result-box .result-content {
    font-size: 18px;
    font-weight: 600;
    color: #e6edf3;
    text-align: center;
}

/* LaTeX trong result box */
.bot-bubble .result-box .katex {
    font-size: 1.3em !important;
}

/* Emoji spacing */
.bot-bubble p:has(> :first-child:is(span.emoji)) {
    display: flex;
    align-items: center;
    gap: 8px;
}
    </style>
    <style>
      @media (max-width:600px) {
        /* Popup tool panel */
        #tool-buttons {
          position:absolute;
          bottom:100%;           /* nằm trên input */
          right:0;
          left:auto;
          display:flex;
          flex-direction:column; /* xếp dọc */
          gap:10px;
          padding:10px 12px;
          background:rgba(13,17,23,0.95);
          border:1px solid var(--border-color);
          border-radius:14px;
          box-shadow:0 8px 28px -4px rgba(0,0,0,0.55);
          backdrop-filter:blur(6px);
          transform-origin: bottom right;
          transition: opacity .18s ease, transform .18s ease;
          z-index:120;
          width:66px; /* đủ cho icon vuông */
        }
        /* Nếu muốn dạng 2 cột (bỏ comment):
        #tool-buttons {
           width:134px;
           flex-wrap:wrap;
           flex-direction:row;
        }
        #tool-buttons .action-btn { flex:0 0 calc(50% - 6px); }
        */

        #tool-buttons .action-btn {
          width:52px;
          height:52px;
          font-size:20px;
          border:1px solid var(--border-color);
          border-radius:12px;
          background:#161b22;
          transition:background .18s, border-color .18s, color .18s;
        }
        #tool-buttons .action-btn:hover {
          background:#1f2731;
          border-color:var(--accent-color);
          color:var(--text-color);
        }

        #tool-buttons.collapsed {
          opacity:0;
          transform:translateY(10px) scale(.92);
          pointer-events:none;
        }
        #tool-buttons:not(.collapsed) {
          opacity:1;
          transform:translateY(0) scale(1);
        }

        /* Căn nút + sát bên phải để panel mở lên ngay trên */
        .input-actions {
          position:relative;
        }
        #toggle-tools-btn {
          position:relative;
          z-index:121; /* nằm trên panel */
        }
      }
    </style>
    <style>
/* === 3D Tilt Effect (buttons) === */
.tilt-3d{
  position:relative;
  background:linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
  box-shadow:0 4px 10px -2px rgba(0,0,0,0.45), 0 0 0 1px var(--border-color);
  transform-style:preserve-3d;
  will-change:transform;
  transition:transform .28s cubic-bezier(.25,.8,.25,1), box-shadow .35s;
  border-radius:8px;
}
.tilt-3d:hover{
  box-shadow:
    0 6px 18px -4px rgba(0,0,0,0.55),
    0 0 0 1px rgba(47,129,247,0.55),
    0 0 14px -2px rgba(47,129,247,0.55);
}
.tilt-3d::after{
  content:'';
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at var(--mx,50%) var(--my,50%),
      rgba(255,255,255,0.28),
      rgba(255,255,255,0.05) 38%,
      rgba(255,255,255,0) 70%);
  opacity:var(--glow-o,0);
  mix-blend-mode:screen;
  pointer-events:none;
  transition:opacity .25s;
  border-radius:inherit;
}
.tilt-3d:active{
  transition:transform .08s;
  transform:perspective(800px) rotateX(0deg) rotateY(0deg) translateZ(0) scale(.95);
}
</style>
<!-- Ensure the drawer toggle appears on mobile only -->
<style>
  @media (max-width:600px){
    #history-drawer-toggle { display: inline-flex; }
    .mobile-header { display: flex; }
  }
</style>
</head>
<body>
    <div class="bg-animation">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    <div class="chat-container">
        <!-- (XÓA nút cũ ở đây nếu còn) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="startNewConversation()" title="Cuộc trò chuyện mới (Ctrl+Shift+X)">
                    <i class="fas fa-plus"></i>
                    <span>Cuộc trò chuyện mới</span>
                </button>
                <button id="find-btn" class="new-chat-btn" onclick="openFindModal()" title="Tìm trong cuộc trò chuyện (Ctrl+Shift+F)">
                  <i class="fas fa-search"></i>
                  <span>Tìm kiếm</span>
                  <span style="margin-left:auto;font-size:11px;opacity:.6;">Ctrl+Shift+F</span>
                </button>
            </div>
            <nav class="history">
                <h3>
                    Lịch sử
                    <span id="history-actions" style="font-size:12px;"></span>
                </h3>
                <ul id="history-list"></ul>
            </nav>
            
            <!-- Professional Mode - Patient Records (hidden by default) -->
            <div class="professional-records" id="professional-records"></div>
            
            <!-- Account management & professional history -->
            <div class="account-section" id="account-section">
                <div class="account-info" id="account-info" onclick="toggleAccountMenu()">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" id="user-avatar" class="account-avatar" alt="Avatar">
                    <div class="account-details">
                        <div class="account-name" id="account-name">Guest User</div>
                        <div class="account-role" id="account-role">Chế độ: Chat</div>
                    </div>
                    <i class="fas fa-chevron-down" id="account-chevron"></i>
                </div>
                
                <div class="account-dropdown" id="account-dropdown">
                    <button onclick="openProfileModal()">
                        <i class="fas fa-user-edit"></i> Chỉnh sửa hồ sơ
                    </button>
                    <button onclick="showProfessionalHistory()" id="professional-history-btn">
                        <i class="fas fa-folder-open"></i> Hồ sơ bệnh nhân
                    </button>
                    <button onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Đăng xuất
                    </button>
                </div>
            </div>
        </aside>

        <div class="resizer" id="resizer"></div>
        <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
 
         <main class="chat-area" id="chat-area">
            <canvas id="snow-canvas"></canvas>
            <!-- Nút toggle lịch sử mới (mobile) -->
            <button id="history-drawer-toggle" class="history-top-toggle" aria-label="Mở lịch sử">
                <span class="bars" aria-hidden="true">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </span>
            </button>
            <!-- Mobile header (shown on small screens) -->
            <div class="mobile-header" id="mobile-header">
                <button class="hamburger" id="mobile-menu-btn" aria-label="Mở menu"><i class="fas fa-bars"></i></button>
                <div class="title">JAREMIS</div>
                <button id="history-toggle-btn" aria-label="Xem lịch sử" onclick="toggleHistoryMode()">
                    <i class="fas fa-clock-rotate-left"></i><span style="margin-left:4px;">Lịch sử</span>
                </button>
            </div>
             <!-- Auth controls (top-right) -->
             <div class="auth-controls" id="auth-controls">
                 <!-- Will be populated by JS -->
             </div>
 
            <div class="chat-messages" id="chat-messages">
                <div style="height:12px;"></div> <!-- spacer tránh trùng nút auth -->
                <div class="chat-bubble bot-bubble">
                    <strong>Chào bạn 👋 Mình là JAREMIS.</strong>
                    <p style="margin-top:8px; color:var(--text-secondary-color);">
                        Hãy nhập các dấu hiệu, hỏi chuyện, hoặc bật chế độ <strong>Diagnose</strong> để yêu cầu chẩn đoán y khoa.
                    </p>
                </div>
            </div>

            <div class="chat-input-area">
                <div id="image-preview-container"></div>
                <div class="input-wrapper">
                    <textarea id="chat-input" placeholder="Nhập tin nhắn hoặc tải lên hình ảnh..." rows="1" oninput="autoResize(this)"></textarea>

                    <div class="input-actions">
                        <button id="toggle-tools-btn" class="toggle-tools-btn" title="Mở công cụ" onclick="toggleToolTray(event)">
                            <i class="fas fa-plus"></i>
                        </button>

                        <div id="tool-buttons" class="tool-buttons collapsed">
                            <button class="action-btn" id="attach-btn" onclick="document.getElementById('images').click()" title="Đính kèm ảnh (Ctrl+Shift+U)">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button id="mode-btn" class="action-btn" title="Chế độ: Chat (Ctrl+Shift+K)" onclick="openModeMenu(event)">
                                <i class="fas fa-comments"></i>
                            </button>
                            <button id="mic-btn" class="action-btn" title="Ghi giọng nói (Ctrl+M). Nhấn để bắt đầu/dừng" onclick="toggleMic(event)">
                                <i class="fas fa-microphone"></i>
                                <span id="mic-indicator"></span>
                            </button>
                        </div>

                        <button id="send-btn" class="action-btn" title="Gửi (Enter)">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        
                        <button id="stop-btn" class="action-btn stop-btn" onclick="stopAIResponse()" title="Dừng AI (Esc)" style="display: none;">
                            <i class="fas fa-stop"></i>
                        </button>

                        <input type="file" id="images" multiple hidden onchange="handleImageUpload(event)">
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div id="model-status">Model: JAREMIS 1.5</div>
                    <div style="font-size:12px; color:var(--text-secondary-color);">Trạng thái: Rảnh</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Auth modal -->
    <div class="modal-backdrop" id="auth-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
            <h3 id="auth-title">Đăng nhập / Đăng ký</h3>

            <div class="tabs">
                <div class="tab active" id="tab-login" onclick="showTab('login')">Đăng nhập</div>
                <div class="tab" id="tab-register" onclick="showTab('register')">Đăng ký</div>
            </div>

            <!-- Login form -->
            <div id="form-login">
                <div class="form-row">
                    <label>Username hoặc Email</label>
                    <input id="login-username" placeholder="Tên đăng nhập hoặc email">
                </div>
                <div class="form-row">
                    <label>Mật khẩu</label>
                    <input id="login-password" type="password" placeholder="Mật khẩu">
                </div>
                <div class="form-row">
                    <button class="btn-primary" onclick="submitLogin()">Đăng nhập</button>
                    <!-- Tạm thời ẩn nút đăng nhập Facebook và Google -->
                    <!-- <button class="btn-primary" onclick="loginWithGoogle()" style="background-color: #4285F4;"> <i class="fab fa-google"></i> Google</button>
                    <button class="btn-primary" onclick="loginWithFacebook()" style="background-color: #3b5998;"> <i class="fab fa-facebook"></i> Facebook</button> -->
                </div>

                <div class="form-actions">
                    <button class="btn-ghost" onclick="closeAuthModal()">Hủy</button>
                </div>
                <div class="small-muted">Bạn chưa có tài khoản? Chuyển sang tab "Đăng ký".</div>
            </div>

            <!-- Register form -->
            <div id="form-register" style="display:none">
                <div class="form-row">
                    <label>Tên đăng nhập</label>
                    <input id="reg-username" placeholder="Tên đăng nhập">
                </div>
                <div class="form-row">
                    <label>Email</label>
                    <input id="reg-email" placeholder="email@example.com" type="email">
                </div>
                <div class="form-row">
                    <label>Mật khẩu</label>
                    <input id="reg-password" type="password" placeholder="Mật khẩu (ít nhất 6 ký tự)">
                </div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="submitRegister()">Đăng ký</button>
                    <button class="btn-ghost" onclick="closeAuthModal()">Hủy</button>
                </div>
                <div class="small-muted">Bằng cách đăng ký, bạn đồng ý thử nghiệm tính năng.</div>
            </div>
        </div>
    </div>

    <!-- Modal Tìm kiếm mới với 2 chế độ -->
    <div class="modal-backdrop" id="find-backdrop" style="display:none;">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="find-title" style="max-width: 600px; width: 90%;">
        <h3 id="find-title" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <span>Tìm kiếm</span>
          <button class="btn-ghost" style="padding:4px 10px;font-size:14px;" onclick="closeFindModal()" title="Đóng (Esc)">&times;</button>
        </h3>
        
        <!-- Tab chọn chế độ tìm kiếm -->
        <div style="display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid var(--border-color);">
          <button id="search-tab-questions" class="search-tab active" onclick="switchSearchTab('questions')" style="flex:1;padding:10px;background:transparent;border:none;border-bottom:2px solid var(--accent-color);color:var(--accent-color);cursor:pointer;font-size:14px;">
            <i class="fas fa-comments"></i> Tìm câu hỏi
          </button>
          <button id="search-tab-conversations" class="search-tab" onclick="switchSearchTab('conversations')" style="flex:1;padding:10px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--text-secondary-color);cursor:pointer;font-size:14px;">
            <i class="fas fa-history"></i> Tìm cuộc trò chuyện
          </button>
        </div>
        
        <!-- Ô nhập tìm kiếm -->
        <div class="form-row" style="margin-bottom:16px;">
          <input id="find-query" placeholder="Nhập từ khóa tìm kiếm..." style="background:#071018;font-size:14px;padding:12px;">
        </div>
        
        <!-- Kết quả tìm kiếm -->
        <div id="search-results" style="max-height:400px;overflow-y:auto;margin-bottom:16px;">
          <div style="text-align:center;color:var(--text-secondary-color);padding:40px 20px;">
            <i class="fas fa-search" style="font-size:48px;opacity:0.3;margin-bottom:16px;"></i>
            <div>Nhập từ khóa để tìm kiếm</div>
          </div>
        </div>
        
        <div class="small-muted" style="margin-top:10px;text-align:center;">
          Ctrl+Shift+F để mở • Esc để đóng
        </div>
      </div>
    </div>

    <!-- Mode Selection Menu -->
    <div class="mode-menu-backdrop" id="mode-menu-backdrop">
      <div class="mode-menu">
        <h3>Chọn chế độ hoạt động</h3>
        <div class="mode-options">
          <div class="mode-option" data-mode="chat" onclick="selectMode('chat')">
            <div class="mode-icon">
              <i class="fas fa-comments"></i>
            </div>
            <div class="mode-info">
              <div class="mode-title">Chat</div>
              <div class="mode-desc">Trò chuyện thông thường, hỏi đáp chung</div>
            </div>
            <div class="mode-check">
              <i class="fas fa-check"></i>
            </div>
          </div>
          
          <div class="mode-option" data-mode="diagnose" onclick="selectMode('diagnose')">
            <div class="mode-icon">
              <i class="fas fa-stethoscope"></i>
            </div>
            <div class="mode-info">
              <div class="mode-title">Diagnose</div>
              <div class="mode-desc">Chẩn đoán y khoa cơ bản, phân tích triệu chứng</div>
            </div>
            <div class="mode-check">
              <i class="fas fa-check"></i>
            </div>
          </div>
          
          <div class="mode-option" data-mode="professional" onclick="selectMode('professional')">
            <div class="mode-icon">
              <i class="fas fa-user-md"></i>
            </div>
            <div class="mode-info">
              <div class="mode-title">Professional</div>
              <div class="mode-desc">Dành cho bác sĩ: phân tích ảnh y tế, gợi ý thuốc, quản lý hồ sơ bệnh nhân</div>
            </div>
            <div class="mode-check">
              <i class="fas fa-check"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Edit Modal -->
    <div class="modal-backdrop" id="profile-modal-backdrop">
      <div class="modal" style="max-width:480px;">
        <h3>Chỉnh sửa hồ sơ</h3>
        
        <!-- Avatar Preview with Camera Icon -->
        <div style="text-align:center;margin-bottom:20px;">
          <div style="position:relative;display:inline-block;">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=default" 
                 id="profile-avatar-preview" 
                 style="width:120px;height:120px;border-radius:50%;border:3px solid var(--border-color);object-fit:cover;cursor:pointer;"
                 onclick="document.getElementById('avatar-upload').click()">
            <div onclick="document.getElementById('avatar-upload').click()" 
                 style="position:absolute;bottom:0;right:0;width:36px;height:36px;background:var(--accent-color);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:3px solid var(--sidebar-bg);box-shadow:0 2px 8px rgba(0,0,0,0.3);">
              <i class="fas fa-camera" style="color:white;font-size:16px;"></i>
            </div>
          </div>
          <input type="file" id="avatar-upload" accept="image/*" hidden onchange="handleAvatarUpload(event)">
          <div style="margin-top:12px;">
            <button type="button" class="btn-ghost" onclick="removeAvatar()" style="font-size:13px;padding:6px 16px;">
              <i class="fas fa-trash"></i> Xóa ảnh
            </button>
          </div>
        </div>
        
        <div class="form-row">
          <label style="color:var(--text-secondary-color);font-size:13px;">Tên hiển thị</label>
          <input type="text" id="profile-name" placeholder="Nhập tên của bạn">
        </div>
        
        <div class="form-row">
          <label style="color:var(--text-secondary-color);font-size:13px;">Tên người dùng</label>
          <input type="text" id="profile-username" placeholder="username" style="background:var(--input-bg);border:1px solid var(--border-color);color:var(--text-secondary-color);padding:8px 12px;border-radius:6px;">
          <div style="font-size:11px;color:var(--text-secondary-color);margin-top:4px;">
            Hồ sơ của bạn giúp người khác nhận ra bạn. Tên và tên người dùng của bạn cùng được sử dụng trong ứng dụng Sora.
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn-ghost" onclick="closeProfileModal()">Hủy</button>
          <button class="btn-primary" onclick="saveProfile()">Lưu</button>
        </div>
      </div>
    </div>

    <!-- Patient Info Modal (for Professional Mode) -->
    <div class="modal-backdrop" id="patient-info-modal-backdrop">
      <div class="modal" style="max-width:600px;max-height:90vh;overflow-y:auto;">
        <h3>📋 Thông tin bệnh nhân</h3>
        <p style="font-size:13px;color:var(--text-secondary-color);margin-bottom:16px;">
          Vui lòng nhập thông tin bệnh nhân trước khi gửi yêu cầu chẩn đoán
        </p>
        
        <div class="form-row">
          <label style="color:var(--text-secondary-color);font-size:13px;">Họ và tên <span style="color:var(--error-color);">*</span></label>
          <input type="text" id="patient-name" placeholder="Nguyễn Văn A" required>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px;">
          <div class="form-row" style="margin-bottom:0;">
            <label style="color:var(--text-secondary-color);font-size:13px;">Tuổi</label>
            <input type="number" id="patient-age" placeholder="30">
          </div>
          <div class="form-row" style="margin-bottom:0;">
            <label style="color:var(--text-secondary-color);font-size:13px;">Giới tính</label>
            <select id="patient-gender" style="background:var(--input-bg);border:1px solid var(--border-color);color:var(--text-color);padding:8px 10px;border-radius:6px;">
              <option value="">Chọn</option>
              <option value="Nam">Nam</option>
              <option value="Nữ">Nữ</option>
              <option value="Khác">Khác</option>
            </select>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px;">
          <div class="form-row" style="margin-bottom:0;">
            <label style="color:var(--text-secondary-color);font-size:13px;">Cân nặng (kg)</label>
            <input type="number" id="patient-weight" placeholder="65">
          </div>
          <div class="form-row" style="margin-bottom:0;">
            <label style="color:var(--text-secondary-color);font-size:13px;">Chiều cao (cm)</label>
            <input type="number" id="patient-height" placeholder="170">
          </div>
        </div>
        
        <div class="form-row">
          <label style="color:var(--text-secondary-color);font-size:13px;">Ngày bắt đầu có triệu chứng</label>
          <input type="date" id="symptoms-start-date" style="background:var(--input-bg);border:1px solid var(--border-color);color:var(--text-color);padding:8px 10px;border-radius:6px;">
        </div>
        
        <div class="form-row">
          <label style="color:var(--text-secondary-color);font-size:13px;">Tiền sử bệnh</label>
          <textarea id="patient-medical-history" placeholder="Ví dụ: Tiểu đường type 2, tăng huyết áp..." style="background:var(--input-bg);border:1px solid var(--border-color);color:var(--text-color);padding:8px 10px;border-radius:6px;min-height:60px;resize:vertical;"></textarea>
        </div>
        
        <div class="form-row">
          <label style="color:var(--text-secondary-color);font-size:13px;">Dị ứng thuốc</label>
          <input type="text" id="patient-allergies" placeholder="Ví dụ: Penicillin, Aspirin...">
        </div>
        
        <div class="form-row">
          <label style="color:var(--text-secondary-color);font-size:13px;">Thuốc đang dùng</label>
          <textarea id="patient-medications" placeholder="Ví dụ: Metformin 500mg x 2 lần/ngày..." style="background:var(--input-bg);border:1px solid var(--border-color);color:var(--text-color);padding:8px 10px;border-radius:6px;min-height:60px;resize:vertical;"></textarea>
        </div>
        
        <div class="form-actions">
          <button class="btn-ghost" onclick="closePatientInfoModal()">Hủy</button>
          <button id="submit-patient-info-btn" class="btn-primary">Gửi chẩn đoán</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Cấu hình marked.js để cho phép HTML cho citations
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false, // Cho phép HTML cho citations
                smartLists: true,
                smartypants: false
            });
        }

        // ------------------------------
        // Các phần tử UI & trạng thái ứng dụng
        // ------------------------------
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const imageInput = document.getElementById('images');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const chatMessages = document.getElementById('chat-messages');
        const thinkBtn = document.getElementById('think-btn');
        const modelStatusEl = document.getElementById('model-status');
        const micBtn = document.getElementById('mic-btn');
        const micIndicator = document.getElementById('mic-indicator');
        const modeBtn = document.getElementById('mode-btn');

        const historyListEl = document.getElementById('history-list');
        const historyActionsEl = document.getElementById('history-actions');

        const authBackdrop = document.getElementById('auth-backdrop');
        const authControls = document.getElementById('auth-controls');

        let useProModel = false;
        let diagnosticMode = false; // Mặc định chế độ Chat
        let recognition = null;
        let isRecording = false;
        let textBeforeRecording = '';
        let historyCache = [];

        let currentSessionId = null;

        // Cấu hình: timeout tùy chọn cho model 'flash'. 0 tắt auto-stop.
        // Đặt ví dụ window.FLASH_TIMEOUT_MS = 45000 để giới hạn 45s.
        window.FLASH_TIMEOUT_MS = window.FLASH_TIMEOUT_MS ?? 0;

        // Các hàm hỗ trợ cần thiết cho inline handlers và rendering
        function escapeHtml(str){
          if (str === null || str === undefined) return '';
          return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#039;');
        }
        function autoResize(el){
          if(!el) return;
          el.style.height = 'auto';
          const maxH = 200;
          el.style.height = Math.min(maxH, el.scrollHeight || 0) + 'px';
        }

        // Sidebar mobile (hamburger): mở/đóng overlay sidebar hiệu có (không tạo element mới)
        (function(){
          const mobileBtn = document.getElementById('mobile-menu-btn');
          const drawerToggleBtn = document.getElementById('history-drawer-toggle');
          const sidebarEl = document.getElementById('sidebar');
          const backdrop = document.getElementById('sidebar-backdrop');
          if (!sidebarEl || !backdrop) return;

          function openSidebar(){
            sidebarEl.classList.add('mobile-open');
            backdrop.style.display = 'block';
            backdrop.classList.add('show');
            document.body.classList.add('no-scroll');
            if (mobileBtn) mobileBtn.setAttribute('aria-expanded','true');
            if (drawerToggleBtn) drawerToggleBtn.classList.add('open');
            setTimeout(()=>{ try{ sidebarEl.focus(); }catch(e){} },50);
          }

          function closeSidebar(){
            sidebarEl.classList.remove('mobile-open');
            backdrop.classList.remove('show');
            backdrop.style.display = 'none';
            document.body.classList.remove('no-scroll');
            if (mobileBtn) mobileBtn.setAttribute('aria-expanded','false');
            if (drawerToggleBtn) drawerToggleBtn.classList.remove('open');
          }

          if (mobileBtn) {
            mobileBtn.addEventListener('click', function(e){
              e && e.preventDefault();
              if (sidebarEl.classList.contains('mobile-open')) closeSidebar();
              else openSidebar();
            });
          }

          if (drawerToggleBtn) {
            drawerToggleBtn.addEventListener('click', function(e){
              e && e.preventDefault();
              if (sidebarEl.classList.contains('mobile-open')) closeSidebar();
              else openSidebar();
            });
          }

          backdrop.addEventListener('click', function(){ closeSidebar(); });

          document.addEventListener('keydown', function(e){
            if (e.key === 'Escape' && sidebarEl.classList.contains('mobile-open')) closeSidebar();
          });

          if (historyListEl){
            historyListEl.addEventListener('click', function(e){
              const li = e.target.closest && e.target.closest('li');
              if (!li) return;
              setTimeout(closeSidebar, 120);
            });
          }

          function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t = setTimeout(fn, ms); }; }
          window.addEventListener('resize', debounce(function(){ if (window.innerWidth > 600) closeSidebar(); }, 180));
        })();

        // ------------------------------
        // ĐIỀU KHIỂN NÚT GỬI/DỪNG
        // ------------------------------
        function showSendButton() {
            if (sendBtn) {
                sendBtn.style.display = 'flex';
                sendBtn.disabled = false;
            }
            if (stopBtn) {
                stopBtn.style.display = 'none';
            }
        }
        
        function showStopButton() {
            if (sendBtn) {
                sendBtn.style.display = 'none';
            }
            if (stopBtn) {
                stopBtn.style.display = 'flex';
            }
        }
        
        function stopAIResponse() {
            console.log('🛑 User clicked Stop button');
            
            // Hủy yêu cầu hiện tại
            if (window._currentAbortController) {
                try {
                    window._currentAbortController.abort();
                    console.log('✅ Request aborted');
                } catch (e) {
                    console.error('❌ Error aborting request:', e);
                }
                window._currentAbortController = null;
                window._currentAbortStartedAt = 0;
            }
            
            // Hiển thị lại nút gửi
            showSendButton();
            
            // Thông báo nhanh
            flashNotice('Đã dừng AI', 'success');
            
            // Loại bỏ animation suy nghĩ khỏi tất cả bubble
            const thinkingBubbles = document.querySelectorAll('.chat-bubble .thinking-animation');
            thinkingBubbles.forEach(bubble => {
                const parent = bubble.parentElement;
                if (parent) {
                    parent.innerHTML = '<div style="color: var(--text-secondary-color); font-style: italic;">⚠️ Đã dừng phản hồi</div>';
                }
            });
        }

        // ------------------------------
        // Đã xóa toggleMode cũ - bây giờ dùng menu 3 chế độ qua openModeMenu()
        
        function toggleThink(e) {
            e?.preventDefault();
            useProModel = !useProModel;
            if (useProModel) {
                thinkBtn.classList.add('active');
                modelStatusEl.textContent = 'Model: JAREMIS PRO 1.5';
            } else {
                thinkBtn.classList.remove('active');
                modelStatusEl.textContent = 'Model: JAREMIS 1.5';
            }
        }

        // Chuyển đổi khay công cụ trên mobile (nút dấu +)
        function toggleToolTray(e) {
            e?.preventDefault();
            e?.stopPropagation();
            
            const toggleBtn = document.getElementById('toggle-tools-btn');
            const toolButtons = document.getElementById('tool-buttons');
            const inputWrapper = document.querySelector('.input-wrapper');
            
            if (!toggleBtn || !toolButtons) {
                console.warn('toggleToolTray: Elements not found');
                return;
            }
            
            // Chuyển đổi trạng thái active
            const isActive = toggleBtn.classList.contains('active');
            
            if (isActive) {
                // Đóng tool tray
                toggleBtn.classList.remove('active');
                toolButtons.classList.add('collapsed');
                inputWrapper?.classList.remove('mobile-tools-active');
            } else {
                // Mở tool tray
                toggleBtn.classList.add('active');
                toolButtons.classList.remove('collapsed');
                inputWrapper?.classList.add('mobile-tools-active');
            }
        }

        // Đóng tool tray khi click bên ngoài (mobile)
        document.addEventListener('click', (e) => {
            const toggleBtn = document.getElementById('toggle-tools-btn');
            const toolButtons = document.getElementById('tool-buttons');
            const inputWrapper = document.querySelector('.input-wrapper');
            
            // Nếu click bên ngoài tool tray và nút toggle
            if (toggleBtn && toolButtons && !toggleBtn.contains(e.target) && !toolButtons.contains(e.target)) {
                toggleBtn.classList.remove('active');
                toolButtons.classList.add('collapsed');
                inputWrapper?.classList.remove('mobile-tools-active');
            }
        });
        // ------------------------------
        // Xác thực & trạng thái người dùng (phiên client lưu trong localStorage)
        // ------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            renderAuthControls();
            const u = getLocalUser();
            if (u) fetchAndRenderHistory(u.username);
            // Khôi phục phiên ẩn danh để giữ ngữ cảnh giữa các lần tải lại trang
            try {
                const savedSess = localStorage.getItem('jaremis_session');
                if (savedSess) currentSessionId = savedSess;
            } catch(_) {}
        });

        function getLocalUser() {
            try {
                const raw = localStorage.getItem('jaremis_user');
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                return null;
            }
        }

        function renderAuthControls() {
            authControls.innerHTML = '';
            const user = getLocalUser();
            if (user) {
                const nameEl = document.createElement('div');
                nameEl.style.color = 'var(--text-color)';
                nameEl.style.fontSize = '13px';
                nameEl.textContent = user.username;

                const btnHistoryClear = document.createElement('button');
                btnHistoryClear.className = 'auth-btn';
                btnHistoryClear.textContent = 'Xóa lịch sử';
                btnHistoryClear.title = 'Xóa toàn bộ lịch sử chat';
                btnHistoryClear.onclick = async () => {
                    if (!confirm('Xóa toàn bộ lịch sử chat của bạn?')) return;
                    try {
                        const res = await fetch(`/api/history?username=${encodeURIComponent(user.username)}`, { method: 'DELETE' });
                        const json = await res.json();
                        if (!res.ok) {
                            alert(json.error || 'Không xóa được lịch sử');
                            return;
                        }
                        historyCache = [];
                        renderHistoryList([]);
                        flashNotice('Đã xóa lịch sử');
                    } catch (e) {
                        console.error(e);
                        flashNotice('Lỗi khi xóa lịch sử');
                    }
                };

                const logoutBtn = document.createElement('button');
                logoutBtn.className = 'auth-btn';
                logoutBtn.textContent = 'Đăng xuất';
                logoutBtn.onclick = () => {
                    try { localStorage.removeItem('jaremis_user'); } catch(e) {}
                    renderAuthControls();
                    historyCache = [];
                    renderHistoryList([]);
                };

                authControls.appendChild(nameEl);
                authControls.appendChild(btnHistoryClear);
                authControls.appendChild(logoutBtn);
            } else {
                const loginBtn = document.createElement('button');
                loginBtn.className = 'auth-btn';
                loginBtn.textContent = 'Đăng nhập';
                loginBtn.onclick = openAuthModal;

                const registerBtn = document.createElement('button');
                registerBtn.className = 'auth-btn';
                registerBtn.textContent = 'Đăng ký';
                registerBtn.onclick = () => { openAuthModal(); showTab('register'); };

                authControls.appendChild(loginBtn);
                authControls.appendChild(registerBtn);
            }
        }

        function openAuthModal() {
            authBackdrop.style.display = 'flex';
            showTab('login');
        }
        function closeAuthModal() {
            authBackdrop.style.display = 'none';
        }
        function showTab(tab) {
            document.getElementById('tab-login').classList.toggle('active', tab === 'login');
            document.getElementById('tab-register').classList.toggle('active', tab === 'register');
            document.getElementById('form-login').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('form-register').style.display = tab === 'register' ? 'block' : 'none';
        }

        async function submitRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;

            if (!username || !email || !password) {
                flashNotice('Vui lòng nhập đầy đủ thông tin đăng ký');
                return;
            }
            if (password.length < 6) {
                flashNotice('Mật khẩu ít nhất 6 ký tự');
                return;
            }

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const json = await res.json();
                if (!res.ok) {
                    flashNotice(json.error || 'Đăng ký thất bại');
                    return;
                }
                localStorage.setItem('jaremis_user', JSON.stringify(json.user));
                flashNotice('Đăng ký thành công! Bạn đã đăng nhập tạm thời.', 2000);
                closeAuthModal();
                renderAuthControls();
                fetchAndRenderHistory(json.user.username);
            } catch (e) {
                console.error('Register error', e);
                flashNotice('Lỗi kết nối khi đăng ký');
            }
        }

        async function submitLogin() {
            const usernameOrEmail = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            if (!usernameOrEmail || !password) {
                flashNotice('Vui lòng nhập username/email và mật khẩu');
                return;
            }
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usernameOrEmail, password })
                });
                const json = await res.json();
                if (!res.ok) {
                    flashNotice(json.error || 'Đăng nhập thất bại');
                    return;
                }
                localStorage.setItem('jaremis_user', JSON.stringify(json.user));
                flashNotice('Đăng nhập thành công', 1200);
                closeAuthModal();
                renderAuthControls();
                fetchAndRenderHistory(json.user.username);
            } catch (e) {
                console.error('Login error', e);
                flashNotice('Lỗi kết nối khi đăng nhập');
            }
        }

        // Mới: Đăng nhập bằng Google
        function loginWithGoogle() {
            window.location.href = '/auth/google';
        }

        // Mới: Đăng nhập bằng Facebook
        function loginWithFacebook() {
            window.location.href = '/auth/facebook';
        }

        function flashNotice(msg, duration = 2000) {
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble bot-bubble';
            bubble.innerHTML = `<em style="color:var(--text-secondary-color)">${escapeHtml(msg)}</em>`;
            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            setTimeout(() => bubble.remove(), duration);
        }

        // ------------------------------
        // Lịch sử: lấy, hiển thị, mở
        // ------------------------------
        async function fetchAndRenderHistory(username) {
            if (!username) return;
            console.log('🔄 Fetching history for user:', username);
            try {
                const res = await fetch(`/api/history?username=${encodeURIComponent(username)}`);
                const json = await res.json();
                if (!res.ok) {
                    console.warn('❌ Không lấy được lịch sử', json);
                    renderHistoryList([]);
                    return;
                }
                historyCache = json.history || [];
                console.log('✅ Fetched history entries:', historyCache.length);
                console.log('📦 Sample entries:', historyCache.slice(0, 3).map(e => ({ 
                    id: e.id, 
                    sessionId: e.sessionId, 
                    input: e.input?.substring(0, 30) 
                })));
                renderHistoryList(historyCache);
            } catch (e) {
                console.error('❌ fetch history error', e);
            }
        }

        // Nhóm & hiển thị lịch sử thành DANH SÁCH CUỘC TRÒ CHUYỆN với nút 3 chấm
        function renderHistoryList(list) {
          historyListEl.innerHTML = '';
          if (!list || list.length === 0) {
            historyListEl.innerHTML = `<li style="color:var(--text-secondary-color); font-size:13px;">Chưa có lịch sử</li>`;
            historyActionsEl.innerHTML = '';
            return;
          }
          // Gom nhóm theo sessionId
          const sessions = {};
          list.forEach(entry => {
            const sid = entry.sessionId || ('legacy-' + entry.id);
            if (!sessions[sid]) sessions[sid] = { title: '', entries: [] };
            sessions[sid].entries.push(entry);
            // Lưu title nếu có
            if (entry.conversationTitle) {
              sessions[sid].title = entry.conversationTitle;
            }
          });
          
          // Sắp xếp session theo newest timestamp
          const sessionArray = Object.entries(sessions).map(([sid, data]) => {
            const newestTs = Math.max(...data.entries.map(e => new Date(e.timestamp).getTime()));
            return { sid, ...data, newestTs };
          }).sort((a,b) => b.newestTs - a.newestTs);

          sessionArray.forEach(sess => {
            // Lấy title từ stored hoặc message user đầu tiên
            let title = sess.title;
            if (!title) {
              const chronological = [...sess.entries].sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));
              const first = chronological.find(e => e.input && e.input.trim()) || chronological[0];
              title = (first?.input || 'Cuộc trò chuyện').slice(0,60);
              if (first?.input && first.input.length > 60) title += '...';
            }
            
            const timeLabel = new Date(sess.newestTs).toLocaleString('vi-VN');
            const li = document.createElement('li');
            li.dataset.session = sess.sid;
            li.innerHTML = `
              <div class="history-title" onclick="openConversation('${sess.sid}')">
                <div style="font-size:13px; color:var(--text-color); font-weight:600;">${escapeHtml(title)}</div>
                <div style="font-size:11px; color:var(--text-secondary-color);">${escapeHtml(timeLabel)} • ${sess.entries.length} tin</div>
              </div>
              <button class="history-menu-btn" onclick="toggleHistoryMenu(event, '${sess.sid}')" title="Tùy chọn">
                <i class="fas fa-ellipsis-h"></i>
              </button>
              <div class="history-dropdown" id="menu-${sess.sid}">
                <button onclick="renameConversation('${sess.sid}')">
                  <i class="fas fa-edit"></i> Đổi tên
                </button>
                <button onclick="deleteConversation('${sess.sid}')" style="color:var(--error-color);">
                  <i class="fas fa-trash"></i> Xóa
                </button>
              </div>
            `;
            historyListEl.appendChild(li);
          });
          historyActionsEl.innerHTML = ''; // bỏ nút cũ
        }

        // Chuyển đổi menu 3 chấm
        function toggleHistoryMenu(event, sessionId) {
          event.stopPropagation();
          const menu = document.getElementById(`menu-${sessionId}`);
          const allMenus = document.querySelectorAll('.history-dropdown');
          allMenus.forEach(m => {
            if (m.id !== `menu-${sessionId}`) m.classList.remove('show');
          });
          menu.classList.toggle('show');
        }

        // Đóng menu khi click ra ngoài
        document.addEventListener('click', () => {
          document.querySelectorAll('.history-dropdown').forEach(m => m.classList.remove('show'));
        });

        // Đổi tên cuộc trò chuyện
        function renameConversation(sessionId) {
          const entries = historyCache.filter(e => (e.sessionId || ('legacy-'+e.id)) === sessionId);
          if (!entries.length) return;
          
          const currentTitle = entries.find(e => e.conversationTitle)?.conversationTitle || 
                              entries.find(e => e.input)?.input?.slice(0,60) || 
                              'Cuộc trò chuyện';
          
          const newTitle = prompt('Nhập tên mới cho cuộc trò chuyện:', currentTitle);
          if (newTitle && newTitle.trim()) {
            // Lưu title vào entry đầu tiên của session
            entries[0].conversationTitle = newTitle.trim();
            localStorage.setItem('jaremis_history', JSON.stringify(historyCache));
            renderHistoryList(historyCache);
          }
        }

        // Xóa cuộc trò chuyện
        function deleteConversation(sessionId) {
          if (!confirm('Bạn có chắc muốn xóa cuộc trò chuyện này?')) return;
          
          // Xóa tất cả entries của session
          historyCache = historyCache.filter(e => (e.sessionId || ('legacy-'+e.id)) !== sessionId);
          localStorage.setItem('jaremis_history', JSON.stringify(historyCache));
          renderHistoryList(historyCache);
          
          // Nếu đang xem session này, clear chat
          if (currentSessionId === sessionId) {
            chatMessages.innerHTML = '';
            currentSessionId = null;
            localStorage.removeItem('jaremis_session');
          }
        }

        // Mở toàn bộ cuộc trò chuyện - FIX: đảm bảo hiển thị đầy đủ
        async function openConversation(sessionId) {
          console.log('🔍 Opening conversation:', sessionId);
          console.log('📦 historyCache total entries:', historyCache.length);
          
          // 🔥 FIX: Nếu historyCache rỗng, fetch lại từ server
          if (historyCache.length === 0) {
            console.warn('⚠️ historyCache is empty, fetching from server...');
            const user = getLocalUser();
            if (user) {
              await fetchAndRenderHistory(user.username);
              console.log('✅ Re-fetched history, new cache size:', historyCache.length);
            }
          }
          
          const convoEntries = historyCache.filter(e => (e.sessionId || ('legacy-'+e.id)) === sessionId)
            .sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));
          
          console.log('✅ Found entries for this session:', convoEntries.length);
          console.log('📋 Entries:', convoEntries.map(e => ({ input: e.input?.substring(0, 30), timestamp: e.timestamp, reply: e.reply?.substring(0, 30) })));
          
          if (!convoEntries.length) {
            console.warn('❌ Không tìm thấy cuộc trò chuyện:', sessionId);
            console.warn('❌ Available sessions:', [...new Set(historyCache.map(e => e.sessionId || ('legacy-'+e.id)))]);
            return;
          }
          
          chatMessages.innerHTML = '';
          let successCount = 0;
          let errorCount = 0;
          
          convoEntries.forEach((entry, idx) => {
            try {
              // Kiểm tra an toàn: đảm bảo entry tồn tại
              if (!entry || typeof entry !== 'object') {
                console.warn(`⚠️ Invalid entry at index ${idx}:`, entry);
                return;
              }
              
              console.log(`📨 Rendering entry ${idx + 1}/${convoEntries.length}:`, {
                input: entry.input?.substring(0, 30),
                hasReply: !!entry.reply,
                replyLength: entry.reply?.length || 0,
                type: entry.type
              });
              
              // Bubble người dùng
              if (entry.input && entry.input.trim()) {
                const userBubble = document.createElement('div');
                userBubble.className = 'chat-bubble user-bubble';
                userBubble.innerHTML = `<div class="user-bubble-content"><p>${escapeHtml(entry.input)}</p></div>`;
                chatMessages.appendChild(userBubble);
                console.log(`  ✅ Added user bubble for: "${entry.input.substring(0, 20)}"`);
                successCount++;
              }
              
              // Phản hồi từ bot
              let botContent = '';
              if (entry.type === 'diagnose' && entry.diagnosis) {
                botContent = entry.diagnosis;
              } else if (entry.reply) {
                botContent = entry.reply;
              }
              
              if (botContent && botContent.trim()) {
                try {
                  const botBubble = document.createElement('div');
                  botBubble.className = 'chat-bubble bot-bubble';
                  
                  // 🔥 SỬA: Chuyển đổi markdown an toàn với dự phòng
                  let renderedContent = botContent;
                  try {
                    if (typeof marked !== 'undefined' && marked.parse) {
                      renderedContent = marked.parse(botContent);
                    } else {
                      // Dự phòng: Dùng văn bản thuần với ngắt dòng
                      renderedContent = botContent.replace(/\n/g, '<br>');
                    }
                  } catch (mdError) {
                    console.error(`  ❌ Markdown conversion error for entry ${idx + 1}:`, mdError);
                    // Dự phòng: Dùng văn bản thuần với ngắt dòng
                    renderedContent = botContent.replace(/\n/g, '<br>');
                  }
                  
                  botBubble.innerHTML = `
                    <div class="diagnosis-details">
                      <div style="font-size:12px; color:var(--text-secondary-color); margin-bottom:6px;">
                        ${entry.type === 'diagnose' ? 'Chẩn đoán' : 'Trả lời'} • ${new Date(entry.timestamp).toLocaleString('vi-VN')}
                      </div>
                      ${renderedContent}
                    </div>
                  `;
                  chatMessages.appendChild(botBubble);
                  console.log(`  ✅ Added bot bubble (${botContent.length} chars)`);
                  successCount++;
                } catch (bubbleError) {
                  console.error(`  ❌ Error creating bot bubble for entry ${idx + 1}:`, bubbleError);
                  errorCount++;
                }
              } else {
                console.warn(`  ⚠️ No bot reply for entry ${idx + 1}`);
              }
            } catch (entryError) {
              console.error(`❌ Error rendering entry ${idx + 1}:`, entryError);
              errorCount++;
            }
          });
          
          console.log(`\n📊 Render Summary:`);
          console.log(`  ✅ Successfully rendered: ${successCount} bubbles`);
          console.log(`  ❌ Errors: ${errorCount}`);
          console.log(`  📦 Expected: ${convoEntries.length * 2} bubbles (${convoEntries.length} user + ${convoEntries.length} bot)`);
          
          chatMessages.scrollTop = chatMessages.scrollHeight;
          currentSessionId = sessionId;
          localStorage.setItem('jaremis_session', currentSessionId);
          
          // 🔍 DEBUG: Kiểm tra số lượng chat bubbles đã render
          const totalBubbles = chatMessages.querySelectorAll('.chat-bubble').length;
          console.log(`✅ Rendered ${totalBubbles} chat bubbles in DOM`);
          console.log(`📊 Expected: ${convoEntries.length} user bubbles + ${convoEntries.filter(e => e.reply || e.diagnosis).length} bot bubbles = ${convoEntries.length + convoEntries.filter(e => e.reply || e.diagnosis).length} total`);
          
          // Đánh dấu active trong history list
          document.querySelectorAll('.history li').forEach(li => {
            li.style.background = li.dataset.session === sessionId ? '#111720' : 'transparent';
            li.style.borderColor = li.dataset.session === sessionId ? 'var(--border-color)' : 'transparent';
          });
        }

        // ------------------------------
        // Mic / SpeechRecognition - HỖ TRỢ NHIỀU NGÔN NGỮ
        // ------------------------------
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;

        // Các ngôn ngữ được hỗ trợ với tự động phát hiện
        const SUPPORTED_LANGUAGES = {
            'vi-VN': { name: 'Tiếng Việt', flag: '🇻🇳', priority: 1 },
            'en-US': { name: 'English (US)', flag: '🇺🇸', priority: 2 },
            'en-GB': { name: 'English (UK)', flag: '🇬🇧', priority: 3 },
            'zh-CN': { name: '中文 (简体)', flag: '🇨🇳', priority: 4 },
            'zh-TW': { name: '中文 (繁體)', flag: '🇹🇼', priority: 5 },
            'ja-JP': { name: '日本語', flag: '🇯🇵', priority: 6 },
            'ko-KR': { name: '한국어', flag: '🇰🇷', priority: 7 },
            'hi-IN': { name: 'हिन्दी (Hindi)', flag: '🇮🇳', priority: 8 },
            'th-TH': { name: 'ไทย (Thai)', flag: '🇹🇭', priority: 9 },
            'es-ES': { name: 'Español', flag: '🇪🇸', priority: 10 },
            'fr-FR': { name: 'Français', flag: '🇫🇷', priority: 11 },
            'de-DE': { name: 'Deutsch', flag: '🇩🇪', priority: 12 },
            'ru-RU': { name: 'Русский', flag: '🇷🇺', priority: 13 },
            'ar-SA': { name: 'العربية (Arabic)', flag: '🇸🇦', priority: 14 },
            'pt-BR': { name: 'Português (Brasil)', flag: '🇧🇷', priority: 15 },
            'id-ID': { name: 'Bahasa Indonesia', flag: '🇮🇩', priority: 16 }
        };

        // Ngôn ngữ nhận dạng hiện tại (mặc định tiếng Việt)
        let currentRecognitionLang = localStorage.getItem('jaremis_speech_lang') || 'vi-VN';

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = currentRecognitionLang;
            recognition.interimResults = true;
            recognition.maxAlternatives = 3; // Lấy nhiều lựa chọn để độ chính xác cao hơn
            recognition.continuous = false;

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('recording');
                const langInfo = SUPPORTED_LANGUAGES[currentRecognitionLang];
                micBtn.title = `🎤 Đang ghi âm (${langInfo?.name || currentRecognitionLang}) — nhấn để dừng`;
                textBeforeRecording = chatInput.value || '';
                chatInput.focus();
                
                // Hiển thị chỉ báo ngôn ngữ
                const indicator = document.getElementById('mic-indicator');
                if (indicator) {
                    indicator.textContent = langInfo?.flag || '🎤';
                    indicator.style.display = 'block';
                }
            };

            recognition.onerror = (event) => {
                console.warn('Speech recognition error', event.error);
                stopRecognition();
                
                let errorMsg = 'Lỗi ghi âm';
                if (event.error === 'no-speech') {
                    errorMsg = 'Không phát hiện giọng nói. Vui lòng thử lại.';
                } else if (event.error === 'audio-capture') {
                    errorMsg = 'Không tìm thấy microphone. Kiểm tra quyền truy cập.';
                } else if (event.error === 'not-allowed') {
                    errorMsg = 'Vui lòng cấp quyền sử dụng microphone.';
                } else if (event.error === 'network') {
                    errorMsg = 'Lỗi mạng. Kiểm tra kết nối internet.';
                } else if (event.error === 'language-not-supported') {
                    errorMsg = `Ngôn ngữ ${currentRecognitionLang} không được hỗ trợ.`;
                } else {
                    errorMsg += ': ' + (event.error || 'Không xác định');
                }
                
                flashNotice(errorMsg, 'error');
            };

            recognition.onend = () => {
                stopRecognition(false);
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = 0; i < event.results.length; i++) {
                    // Lấy lựa chọn tốt nhất (độ tin cậy cao nhất)
                    const result = event.results[i];
                    let bestTranscript = result[0].transcript;
                    let bestConfidence = result[0].confidence;
                    
                    // Kiểm tra các lựa chọn khác để tìm độ tin cậy tốt hơn
                    for (let j = 1; j < result.length; j++) {
                        if (result[j].confidence > bestConfidence) {
                            bestTranscript = result[j].transcript;
                            bestConfidence = result[j].confidence;
                        }
                    }
                    
                    if (result.isFinal) {
                        finalTranscript += bestTranscript + ' ';
                        console.log(`✅ Speech recognized (${currentRecognitionLang}): "${bestTranscript}" (confidence: ${(bestConfidence * 100).toFixed(1)}%)`);
                    } else {
                        interimTranscript += bestTranscript;
                    }
                }
                
                chatInput.value = (textBeforeRecording + ' ' + finalTranscript + interimTranscript).trim();
                autoResize(chatInput);
            };
        } else {
            micBtn.title = 'Trình duyệt của bạn không hỗ trợ ghi âm chuyển văn bản (Web Speech API). Dùng Chrome/Microsoft Edge mới nhất để có chức năng này.';
            micBtn.style.opacity = '0.6';
            micBtn.style.pointerEvents = 'none';
        }

        // Thay đổi ngôn ngữ nhận dạng
        function changeSpeechLanguage(langCode) {
            if (!SUPPORTED_LANGUAGES[langCode]) {
                console.warn('Unsupported language:', langCode);
                return;
            }
            
            currentRecognitionLang = langCode;
            localStorage.setItem('jaremis_speech_lang', langCode);
            
            if (recognition) {
                recognition.lang = langCode;
            }
            
            const langInfo = SUPPORTED_LANGUAGES[langCode];
            micBtn.title = `${langInfo.flag} Ghi giọng nói (${langInfo.name}). Nhấn để bắt đầu/dừng. Chuột phải để chọn ngôn ngữ.`;
            
            flashNotice(`🎤 Đã chuyển sang ${langInfo.flag} ${langInfo.name}`, 'success');
        }

        // Hiển thị menu lựa chọn ngôn ngữ
        function showLanguageMenu(e) {
            e?.preventDefault();
            e?.stopPropagation();
            
            // Xóa menu hiện có nếu đang mở
            const existingMenu = document.getElementById('lang-menu');
            if (existingMenu) existingMenu.remove();
            
            // Tạo menu mới
            const menu = document.createElement('div');
            menu.id = 'lang-menu';
            menu.style.cssText = `
                position: fixed;
                background: var(--sidebar-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 8px;
                z-index: 9999;
                box-shadow: 0 8px 24px rgba(0,0,0,0.5);
                max-height: 400px;
                overflow-y: auto;
                min-width: 220px;
            `;
            
            // Thêm tiêu đề
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 8px 12px;
                font-size: 13px;
                font-weight: 600;
                color: var(--text-secondary-color);
                border-bottom: 1px solid var(--border-color);
                margin-bottom: 8px;
            `;
            header.textContent = '🎤 Chọn ngôn ngữ nhận diện';
            menu.appendChild(header);
            
            // Thêm các tùy chọn ngôn ngữ (sắp xếp theo ưu tiên)
            const sortedLangs = Object.entries(SUPPORTED_LANGUAGES)
                .sort((a, b) => a[1].priority - b[1].priority);
            
            sortedLangs.forEach(([code, info]) => {
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 10px 12px;
                    cursor: pointer;
                    border-radius: 6px;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: background 0.15s;
                    ${code === currentRecognitionLang ? 'background: rgba(47,129,247,0.15); border-left: 3px solid var(--accent-color);' : ''}
                `;
                
                item.innerHTML = `
                    <span style="font-size: 20px;">${info.flag}</span>
                    <span style="flex: 1;">${info.name}</span>
                    ${code === currentRecognitionLang ? '<span style="color: var(--accent-color); font-size: 16px;">✓</span>' : ''}
                `;
                
                item.addEventListener('mouseenter', () => {
                    if (code !== currentRecognitionLang) {
                        item.style.background = 'rgba(255,255,255,0.05)';
                    }
                });
                
                item.addEventListener('mouseleave', () => {
                    if (code !== currentRecognitionLang) {
                        item.style.background = 'transparent';
                    }
                });
                
                item.addEventListener('click', () => {
                    changeSpeechLanguage(code);
                    menu.remove();
                });
                
                menu.appendChild(item);
            });
            
            // Định vị menu gần nút mic
            const micRect = micBtn.getBoundingClientRect();
            menu.style.left = `${micRect.left}px`;
            menu.style.top = `${micRect.top - 410}px`; // Phía trên nút
            
            // Điều chỉnh nếu menu ra ngoài màn hình
            document.body.appendChild(menu);
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.top < 10) {
                menu.style.top = `${micRect.bottom + 10}px`; // Phía dưới nút
            }
            if (menuRect.right > window.innerWidth - 10) {
                menu.style.left = `${window.innerWidth - menuRect.width - 10}px`;
            }
            
            // Đóng menu khi click bên ngoài
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }

        function toggleMic(e) {
            e?.preventDefault();
            
            if (!SpeechRecognition) return;
            
            // Click chuột phải hoặc giữ lâu để hiện menu ngôn ngữ
            if (e && (e.button === 2 || e.type === 'contextmenu')) {
                e.preventDefault();
                showLanguageMenu(e);
                return;
            }
            
            if (!isRecording) startRecognition();
            else stopRecognition();
        }
        
        // Thêm menu chuột phải để chọn ngôn ngữ
        if (micBtn) {
            micBtn.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showLanguageMenu(e);
            });
            
            // Cập nhật tooltip với ngôn ngữ hiện tại
            const langInfo = SUPPORTED_LANGUAGES[currentRecognitionLang];
            micBtn.title = `${langInfo.flag} Ghi giọng nói (${langInfo.name}). Nhấn để bắt đầu/dừng. Chuột phải để chọn ngôn ngữ.`;
        }

        function startRecognition() {
            if (!recognition) return;
           
            try {
                // Cập nhật ngôn ngữ trước khi bắt đầu
                recognition.lang = currentRecognitionLang;
                textBeforeRecording = chatInput.value || '';
                recognition.start();
                
                const langInfo = SUPPORTED_LANGUAGES[currentRecognitionLang];
                console.log(`🎤 Starting speech recognition in ${langInfo.flag} ${langInfo.name}`);
            } catch (err) {
                console.warn('Không thể bắt đầu ghi âm:', err);
                flashNotice('Không thể bắt đầu ghi âm: ' + (err.message || err), 'error');
            }
        }

        function stopRecognition(clearInterim = false) {
            if (!recognition) return;
            try { recognition.stop(); } catch (e) {}
            isRecording = false;
            micBtn.classList.remove('recording');
            
            // Cập nhật tooltip với ngôn ngữ hiện tại
            const langInfo = SUPPORTED_LANGUAGES[currentRecognitionLang];
            micBtn.title = `${langInfo.flag} Ghi giọng nói (${langInfo.name}). Nhấn để bắt đầu/dừng. Chuột phải để chọn ngôn ngữ.`;
            
            // Ẩn chỉ báo ngôn ngữ
            const indicator = document.getElementById('mic-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
            
            if (clearInterim) {
                chatInput.value = textBeforeRecording || '';
                autoResize(chatInput);
            }
        }

        // ------------------------------
        // Image preview
        // ------------------------------
        function handleImageUpload(event) {
            imagePreviewContainer.innerHTML = '';
            Array.from(event.target.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-btn" onclick="removeImage(${index})">&times;</button>
                    `;
                    imagePreviewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            const dt = new DataTransfer();
            const files = Array.from(imageInput.files);
            files.splice(index, 1);
            files.forEach(file => dt.items.add(file));
            imageInput.files = dt.files;
            handleImageUpload({ target: imageInput });
        }

        // ========================================
        // HỖ TRỢ DÁN ẢNH (Ctrl+V / Ctrl+C)
        // ========================================
        let pastedImages = []; // Lưu các ảnh đã dán riêng biệt

        // Lắng nghe sự kiện paste toàn cục
        document.addEventListener('paste', function(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    event.preventDefault(); // Ngăn hành vi paste mặc định
                    
                    const file = items[i].getAsFile();
                    if (!file) continue;
                    
                    // Thêm vào mảng ảnh đã dán
                    pastedImages.push(file);
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'preview-item';
                        div.innerHTML = `
                            <img src="${e.target.result}" alt="Pasted Image">
                            <button class="remove-btn" onclick="removePastedImage(${pastedImages.length - 1})">&times;</button>
                            <div class="paste-badge">📋 Dán ảnh</div>
                        `;
                        imagePreviewContainer.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                    
                    // Hiển thị thông báo
                    if (typeof flashNotice === 'function') {
                        flashNotice('✅ Đã dán ảnh từ clipboard! Nhấn Gửi để phân tích.', 'success');
                    }
                    
                    console.log('📋 Pasted image:', file.name || 'clipboard-image.png', file.size, 'bytes');
                }
            }
        });

        function removePastedImage(index) {
            // Xóa khỏi mảng pastedImages
            pastedImages.splice(index, 1);
            
            // Re-render all previews
            renderImagePreviews();
        }

        function renderImagePreviews() {
            imagePreviewContainer.innerHTML = '';
            
            // Render file input images
            Array.from(imageInput.files || []).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-btn" onclick="removeImage(${index})">&times;</button>
                    `;
                    imagePreviewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
            
            // Render pasted images
            pastedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Pasted Image">
                        <button class="remove-btn" onclick="removePastedImage(${index})">&times;</button>
                        <div class="paste-badge">📋</div>
                    `;
                    imagePreviewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // Helper lấy tất cả ảnh (file input + đã dán)
        function getAllImages() {
            const allFiles = [];
            
            // Add file input files
            if (imageInput.files) {
                allFiles.push(...Array.from(imageInput.files));
            }
            
            // Add pasted images
            allFiles.push(...pastedImages);
            
            return allFiles;
        }

        // Cập nhật handleImageUpload để cũng render ảnh đã dán
        const originalHandleImageUpload = handleImageUpload;
        handleImageUpload = function(event) {
            originalHandleImageUpload(event);
            // Cũng render ảnh đã dán nếu có
            if (pastedImages.length > 0) {
                renderImagePreviews();
            }
        };

        // ========================================
        // ENHANCED IMAGE PREVIEW STYLES
        // ========================================
        // Thêm CSS cho paste badge động
        const pasteStyles = document.createElement('style');
        pasteStyles.textContent = `
            .paste-badge {
                position: absolute;
                top: 4px;
                left: 4px;
                background: rgba(47, 129, 247, 0.9);
                color: white;
                font-size: 10px;
                padding: 2px 6px;
                border-radius: 4px;
                font-weight: 600;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            
            #image-preview-container {
                position: relative;
            }
            
            .preview-item {
                animation: slideInFromRight 0.3s ease-out;
            }
            
            @keyframes slideInFromRight {
                from {
                    opacity: 0;
                    transform: translateX(20px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
        `;
        document.head.appendChild(pasteStyles);

        // ========================================
        // HELPER THÔNG BÁO NHANH
        // ========================================
        function flashNotice(message, type = 'info') {
            const notice = document.createElement('div');
            notice.className = 'flash-notice';
            notice.textContent = message;
            
            notice.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#238636' : type === 'error' ? '#f85149' : '#2f81f7'};
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
                font-size: 14px;
            `;
            
            document.body.appendChild(notice);
            
            setTimeout(() => {
                notice.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notice.remove(), 300);
            }, 3000);
        }

        // Add animations
        const noticeAnimations = document.createElement('style');
        noticeAnimations.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(noticeAnimations);

        // ========================================
        // GỬI DỮ LIỆU - Nâng cao với Ảnh Đã Dán
        // ========================================
        
        // Lưu dữ liệu submit đang chờ khi mở modal thông tin bệnh nhân
        let pendingSubmitData = null;
        
        async function submitData() {
            console.log('🚀 submitData called'); // DEBUG
            console.log('📍 Current mode:', currentMode); // DEBUG MODE
            
            const message = chatInput.value.trim();
            const allImages = getAllImages();
            
            console.log('📝 Message:', message, 'Images:', allImages.length); // DEBUG
            
            if (!message && allImages.length === 0) {
                flashNotice('Vui lòng nhập tin nhắn hoặc đính kèm ảnh', 'error');
                return;
            }
            
            // If Professional mode, show patient info modal first
            if (currentMode === 'professional') {
                console.log('🏥 Professional mode detected - opening patient info modal'); // DEBUG
                // Đảm bảo pendingSubmitData có cấu trúc đúng
                pendingSubmitData = { 
                    message: message,
                    allImages: allImages || []
                };
                console.log('💾 Saved pendingSubmitData:', pendingSubmitData); // DEBUG
                openPatientInfoModal();
                return;
            }
            
            // Nếu không, tiến hành submit bình thường
            await performSubmit(message, allImages, null);
        }
        
        function openPatientInfoModal() {
            console.log('📂 Opening patient modal, pendingSubmitData:', pendingSubmitData); // DEBUG
            const backdrop = document.getElementById('patient-info-modal-backdrop');
            if (backdrop) {
                backdrop.classList.add('show');
                // Reset form
                document.getElementById('patient-name').value = '';
                document.getElementById('patient-age').value = '';
                document.getElementById('patient-gender').value = '';
                document.getElementById('patient-weight').value = '';
                document.getElementById('patient-height').value = '';
                document.getElementById('symptoms-start-date').value = '';
                document.getElementById('patient-medical-history').value = '';
                document.getElementById('patient-allergies').value = '';
                document.getElementById('patient-medications').value = '';
            }
        }
        
        function closePatientInfoModal() {
            const backdrop = document.getElementById('patient-info-modal-backdrop');
            if (backdrop) {
                backdrop.classList.remove('show');
            }
            // Don't reset pendingSubmitData here - it's needed after modal closes
        }
        
        async function submitProfessionalWithPatientInfo() {
            console.log('🔍 submitProfessionalWithPatientInfo called'); // DEBUG
            console.log('📦 Current pendingSubmitData:', pendingSubmitData); // DEBUG
            
            const patientName = document.getElementById('patient-name').value.trim();
            
            if (!patientName) {
                flashNotice('Vui lòng nhập tên bệnh nhân!', 'error');
                return;
            }
            
            const patientInfo = {
                name: patientName,
                age: document.getElementById('patient-age').value || null,
                gender: document.getElementById('patient-gender').value || null,
                weight: document.getElementById('patient-weight').value || null,
                height: document.getElementById('patient-height').value || null,
                medicalHistory: document.getElementById('patient-medical-history').value.trim() || '',
                allergies: document.getElementById('patient-allergies').value.trim() || '',
                currentMedications: document.getElementById('patient-medications').value.trim() || '',
                symptomsStartDate: document.getElementById('symptoms-start-date').value || null
            };
            
            console.log('👤 Patient info:', patientInfo); // DEBUG
            
            // QUAN TRỌNG: Lưu pendingSubmitData vào biến tạm TRƯỚC KHI đóng modal
            const savedData = pendingSubmitData;
            
            // Close modal first
            closePatientInfoModal();
            
            // Reset pendingSubmitData sau khi lưu vào biến tạm
            pendingSubmitData = null;
            
            // Kiểm tra an toàn cho savedData
            if (savedData && typeof savedData === 'object') {
                console.log('✅ Valid savedData, calling performSubmit'); // DEBUG
                await performSubmit(savedData.message || '', savedData.allImages || [], patientInfo);
            } else {
                console.error('❌ savedData is invalid:', savedData);
                flashNotice('Lỗi: Dữ liệu tin nhắn không hợp lệ. Vui lòng thử lại.', 'error');
            }
        }
        
        async function performSubmit(message, allImages, patientInfo) {
            // Ngăn chặn submit hai lần
            if (window._currentAbortController) {
                try {
                    const sig = window._currentAbortController.signal;
                    const startedAt = window._currentAbortStartedAt || 0;
                    const tooLong = Date.now() - startedAt > 20000;
                    if (sig && sig.aborted) {
                        window._currentAbortController = null;
                        window._currentAbortStartedAt = 0;
                        showSendButton();
                    } else if (tooLong) {
                        try { window._currentAbortController.abort(); } catch(e) {}
                        window._currentAbortController = null;
                        window._currentAbortStartedAt = 0;
                        showSendButton();
                    } else {
                        flashNotice('Đang xử lý phản hồi trước, hãy đợi hoặc nhấn nút dừng.', 'error');
                        return;
                    }
                } catch (e) {
                    window._currentAbortController = null;
                    window._currentAbortStartedAt = 0;
                    showSendButton();
                }
            }

            // Chọn endpoint dựa trên currentMode
            let endpoint = '/api/chat';
            if (currentMode === 'diagnose' || diagnosticMode) {
                endpoint = '/api/diagnose';
            } else if (currentMode === 'professional') {
                endpoint = '/api/professional';
            }
            
            // Chuẩn bị FormData
            const formData = new FormData();
            formData.append('message', message);
            formData.append('labResults', message);
            formData.append('symptoms', message);
            formData.append('model', useProModel ? 'pro' : 'flash');
            formData.append('sessionId', currentSessionId || generateSessionId());
            
            const user = getLocalUser();
            if (user) {
                formData.append('submittedBy', user.username);
                formData.append('doctorUsername', user.username);
            }
            
            // Chế độ chuyên môn - thêm thông tin bệnh nhân
            if (currentMode === 'professional' && patientInfo) {
                formData.append('patientInfo', JSON.stringify(patientInfo));
                formData.append('patientId', 'P' + Date.now());
                formData.append('symptomsStartDate', patientInfo.symptomsStartDate || '');
            }

            // Đính kèm tất cả ảnh
            allImages.forEach((file, index) => {
                const filename = file.name || `pasted-image-${index + 1}.png`;
                formData.append('images', file, filename);
            });

            // Thêm bong bóng tin nhắn người dùng
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble user-bubble';
            userBubble.innerHTML = `
                <div>${escapeHtml(message)}</div>
                ${allImages.length > 0 ? `<div style="margin-top:8px;color:var(--text-secondary-color);font-size:12px;">📎 ${allImages.length} ảnh đính kèm</div>` : ''}
            `;
            chatMessages.appendChild(userBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Xóa input và ảnh
            chatInput.value = '';
            imageInput.value = '';
            pastedImages = [];
            imagePreviewContainer.innerHTML = '';
            autoResize(chatInput);

            // Thêm bong bóng bot với hiệu ứng đang tải
            const botBubble = document.createElement('div');
            botBubble.className = 'chat-bubble bot-bubble';
            chatMessages.appendChild(botBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Hiển thị hiệu ứng đang suy nghĩ
            if (currentMode === 'diagnose' || diagnosticMode) {
                await animateAnalysisSteps(botBubble);
            } else if (currentMode === 'professional') {
                await animateProfessionalAnalysis(botBubble, allImages.length > 0);
            } else {
                showThinking(botBubble);
            }

            // Gửi yêu cầu
            try {
                const controller = new AbortController();
                window._currentAbortController = controller;
                window._currentAbortStartedAt = Date.now();
                
                // Hiện nút dừng thay vì nút gửi
                showStopButton();

                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });

                if (!response.ok) {
                    let errorMsg = 'Lỗi server';
                    try {
                        const error = await response.json();
                        errorMsg = error.error || error.message || 'Lỗi server';
                    } catch (e) {
                        errorMsg = `Lỗi ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                
                // Gỡ lỗi: log phản hồi với truy cập an toàn
                console.log('📦 Response received:', result);
                console.log('📦 Response keys:', result ? Object.keys(result) : 'null');
                console.log('📦 Has reply?', result?.reply);
                console.log('📦 Has replyHtml?', result?.replyHtml);
                
                // Xác thực cấu trúc phản hồi
                if (!result || typeof result !== 'object') {
                    console.error('❌ Invalid response type:', typeof result);
                    throw new Error('Response không hợp lệ từ server');
                }
                
                // Kiểm tra an toàn bổ sung cho các trường bắt buộc theo mode
                const hasContent = result.reply || result.replyHtml || result.diagnosis || result.consultation || result.consultationHtml;
                if (!hasContent) {
                    console.warn('⚠️ Response missing content:', result);
                    throw new Error('Server không trả về nội dung phản hồi');
                }
                
                // Xóa abort controller
                window._currentAbortController = null;
                window._currentAbortStartedAt = 0;
                
                // Hiện lại nút gửi
                showSendButton();

                // ========================================
                // 🔥 FIX: ĐỒNG BỘ LỊCH SỬ TỪ SERVER REAL-TIME
                // ========================================
                const user = getLocalUser();
                if (user) {
                    // Fetch lại history từ server để đảm bảo đồng bộ
                    // (Backend đã lưu vào users.json, giờ cần pull về frontend)
                    await fetchAndRenderHistory(user.username);
                    console.log('✅ Đã đồng bộ lịch sử từ server');
                    
                    // Đánh dấu session hiện tại là active trong history list
                    setTimeout(() => {
                        document.querySelectorAll('.history li').forEach(li => {
                            if (li.dataset.session === currentSessionId) {
                                li.style.background = '#111720';
                                li.style.borderColor = 'var(--border-color)';
                            }
                        });
                    }, 100);
                }

                // Hiển thị phản hồi
                if (currentMode === 'diagnose' || diagnosticMode) {
                    renderDiagnosisResponse(result, botBubble);
                } else if (currentMode === 'professional') {
                    renderProfessionalResponse(result, botBubble);
                } else {
                    // Render phản hồi chat với hiệu ứng gõ chữ
                    const replyHtml = result.replyHtml || result.reply || 'Không có phản hồi';
                    await renderBotReplyAnimated(botBubble, replyHtml);
                }

                // Hiện citations nếu có
                if (result.citations && result.citations.length > 0) {
                    const citationBubble = document.createElement('div');
                    citationBubble.className = 'chat-bubble bot-bubble';
                    citationBubble.innerHTML = result.citationsHtml || formatCitations(result.citations);
                    chatMessages.appendChild(citationBubble);
                }

                chatMessages.scrollTop = chatMessages.scrollHeight;

            } catch (error) {
                console.error('Submit error:', error);
                
                stopThinking(botBubble);
                
                // Xử lý thông báo lỗi an toàn
                const errorMessage = error?.message || error?.error || String(error) || 'Lỗi không xác định';
                botBubble.innerHTML = `
                    <div style="color:var(--error-color);">
                        ❌ <strong>Lỗi:</strong> ${escapeHtml(errorMessage)}
                    </div>
                `;

                window._currentAbortController = null;
                window._currentAbortStartedAt = 0;
                
                // Hiện lại nút gửi on error
                showSendButton();
            }
        }

        function generateSessionId() {
            const id = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            currentSessionId = id;
            try {
                localStorage.setItem('jaremis_session', id);
            } catch(e) {}
            return id;
        }

        function formatCitations(citations) {
            if (!citations || citations.length === 0) return '';
            
            let html = '<div style="margin-top:16px;"><h4>📖 Nguồn tham khảo:</h4><div style="margin:8px 0;">';
            citations.forEach((c, i) => {
                const shortTitle = c.title && c.title.length > 50 ? c.title.substring(0, 50) + '...' : (c.title || 'Source');
                html += `<a href="${escapeHtml(c.url)}" class="citation-btn" target="_blank" rel="noopener">${c.icon || '📚'} ${escapeHtml(c.type || 'Source')}: ${escapeHtml(shortTitle)}</a> `;
            });
            html += '</div></div>';
            return html;
        }

        function renderDiagnosisResponse(result, bubbleElement) {
            stopThinking(bubbleElement);
            
            console.log('🔍 Rendering diagnosis response:', result);
            
            let html = '<div class="diagnosis-result">';
            
            // ========================================
            // SEVERITY ALERT BANNER (NEW)
            // ========================================
            if (result.severityLevel) {
                console.log('🚨 Severity Level:', result.severityLevel);
                
                let alertColor, alertIcon, alertText, alertBg;
                
                if (result.severityLevel === 'CRITICAL' || result.isEmergency) {
                    alertColor = '#ff4d4d';
                    alertBg = 'rgba(255, 77, 77, 0.15)';
                    alertIcon = '🚨';
                    alertText = 'CẢNH BÁO NGUY HIỂM';
                } else if (result.severityLevel === 'MODERATE') {
                    alertColor = '#ff9933';
                    alertBg = 'rgba(255, 153, 51, 0.15)';
                    alertIcon = '⚠️';
                    alertText = 'CHÚ Ý - CẦN THEO DÕI';
                } else {
                    alertColor = '#4CAF50';
                    alertBg = 'rgba(76, 175, 80, 0.15)';
                    alertIcon = '✅';
                    alertText = 'BỆNH NHẸ';
                }
                
                html += `
                    <div style="
                        background: ${alertBg};
                        border: 2px solid ${alertColor};
                        border-radius: 12px;
                        padding: 16px 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    ">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-size: 32px;">${alertIcon}</span>
                            <div>
                                <div style="font-size: 18px; font-weight: 700; color: ${alertColor};">
                                    ${alertText}
                                </div>
                                ${result.mortalityRate > 0 ? `<div style="font-size: 13px; color: var(--text-secondary-color); margin-top: 4px;">
                                    Tỷ lệ tử vong ước tính: ${result.mortalityRate}%
                                </div>` : ''}
                            </div>
                        </div>
                        ${result.warning ? `<div style="font-size: 14px; color: var(--text-color); margin-top: 8px;">
                            ${result.warning}
                        </div>` : ''}
                    </div>
                `;
                
                // Red Flags Alert
                if (result.redFlags && result.redFlags.length > 0) {
                    html += `
                        <div style="
                            background: rgba(255, 77, 77, 0.2);
                            border-left: 4px solid #ff4d4d;
                            border-radius: 8px;
                            padding: 16px;
                            margin-bottom: 16px;
                        ">
                            <h4 style="color: #ff4d4d; margin: 0 0 12px 0;">🚨 DẤU HIỆU NGUY HIỂM PHÁT HIỆN:</h4>
                            ${result.redFlags.map(f => `
                                <div style="margin-bottom: 12px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                    <div style="font-weight: 600; color: #ff4d4d;">▸ ${f.symptom.toUpperCase()}</div>
                                    <div style="font-size: 13px; margin-top: 4px;">Nguy cơ: ${f.risk}</div>
                                    <div style="font-size: 14px; margin-top: 6px; color: #ffcc00; font-weight: 600;">
                                        → ${f.action}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Yellow Flags Alert
                if (result.yellowFlags && result.yellowFlags.length > 0) {
                    html += `
                        <div style="
                            background: rgba(255, 193, 7, 0.15);
                            border-left: 4px solid #ffc107;
                            border-radius: 8px;
                            padding: 16px;
                            margin-bottom: 16px;
                        ">
                            <h4 style="color: #ffc107; margin: 0 0 12px 0;">⚠️ DẤU HIỆU CẦN CHÚ Ý:</h4>
                            ${result.yellowFlags.map(f => `
                                <div style="margin-bottom: 10px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                    <div style="font-weight: 600; color: #ffc107;">▸ ${f.symptom}</div>
                                    <div style="font-size: 13px; margin-top: 4px;">Nguy cơ: ${f.risk}</div>
                                    <div style="font-size: 13px; margin-top: 4px; color: #ffeb3b;">
                                        → ${f.action}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }
            
            // Chẩn đoán chính - ƯU TIÊN markdown hơn HTML
            // diagnosisHtml không parse bảng markdown, nên dùng diagnosis (markdown thô)
            if (result.diagnosis) {
                console.log('✅ Using diagnosis (converting markdown with GFM tables)');
                console.log('📝 Raw diagnosis (first 500 chars):', result.diagnosis.substring(0, 500));
                console.log('🔧 marked.js available?', typeof marked !== 'undefined');
                
                // Chuyển markdown sang HTML
                if (typeof marked !== 'undefined') {
                    try {
                        // QUAN TRỌNG: Parse toàn bộ markdown bao gồm bảng
                        const parsedHtml = marked.parse(result.diagnosis, {
                            breaks: true,
                            gfm: true, // GitHub Flavored Markdown (hỗ trợ bảng)
                            tables: true,
                            headerIds: false,
                            mangle: false
                        });
                        console.log('✅ Markdown parsed successfully');
                        console.log('📄 Parsed HTML (first 500 chars):', parsedHtml.substring(0, 500));
                        html += parsedHtml;
                    } catch (e) {
                        console.warn('❌ Markdown parse error:', e);
                        html += result.diagnosis.replace(/\n/g, '<br>');
                    }
                } else {
                    console.warn('⚠️ marked.js not loaded, using fallback');
                    html += result.diagnosis.replace(/\n/g, '<br>');
                } {
                    html += result.diagnosis.replace(/\n/g, '<br>');
                }
            } else if (result.diagnosisHtml) {
                console.log('⚠️ Fallback to diagnosisHtml (may not render tables correctly)');
                html += result.diagnosisHtml;
            } else {
                // Fallback: hiển thị toàn bộ response nếu không có diagnosis
                console.warn('⚠️ No diagnosis field found, showing full response');
                html += '<div style="color:orange;">⚠️ Không tìm thấy kết quả chẩn đoán. Response:</div>';
                html += `<pre style="background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;overflow:auto;max-height:300px;font-size:11px;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>`;
            }
            
            // ========================================
            // EMERGENCY GUIDANCE (NEW)
            // ========================================
            if (result.emergencyGuidance) {
                console.log('🚨 Adding Emergency Guidance');
                
                // Convert markdown guidance to HTML
                let guidanceHtml = result.emergencyGuidance;
                if (typeof marked !== 'undefined') {
                    try {
                        guidanceHtml = marked.parse(result.emergencyGuidance, {
                            breaks: true,
                            gfm: true
                        });
                    } catch (e) {
                        guidanceHtml = result.emergencyGuidance.replace(/\n/g, '<br>');
                    }
                }
                
                html += `
                    <div style="
                        background: linear-gradient(135deg, rgba(47, 129, 247, 0.1) 0%, rgba(47, 129, 247, 0.05) 100%);
                        border: 2px solid rgba(47, 129, 247, 0.4);
                        border-radius: 12px;
                        padding: 20px;
                        margin-top: 24px;
                        box-shadow: 0 4px 12px rgba(47, 129, 247, 0.15);
                    ">
                        <h3 style="margin: 0 0 16px 0; color: #58a6ff; display: flex; align-items: center; gap: 10px;">
                            ${result.severityLevel === 'CRITICAL' ? '🚨' : result.severityLevel === 'MODERATE' ? '⚠️' : '🏠'}
                            ${result.severityLevel === 'CRITICAL' ? 'HƯỚNG DẪN XỬ TRÍ KHẨN CẤP' : result.severityLevel === 'MODERATE' ? 'HƯỚNG DẪN CHĂM SÓC & THEO DÕI' : 'HƯỚNG DẪN CHĂM SÓC TẠI NHÀ'}
                        </h3>
                        <div style="color: var(--text-color);">
                            ${guidanceHtml}
                        </div>
                    </div>
                `;
            }

            // Lab analysis
            if (result.labAnalysis && result.labAnalysis.abnormal && result.labAnalysis.abnormal.length > 0) {
                html += '<h4 style="margin-top:16px;">🔬 Xét nghiệm bất thường:</h4>';
                html += '<table style="width:100%;border-collapse:collapse;margin:8px 0;">';
                html += '<thead><tr><th>Chỉ số</th><th>Giá trị</th><th>Trạng thái</th><th>Mức độ</th></tr></thead><tbody>';
                result.labAnalysis.abnormal.forEach(a => {
                    html += `<tr>
                        <td>${escapeHtml(a.name)}</td>
                        <td>${a.value} (BT: ${escapeHtml(a.normal)})</td>
                        <td>${a.status}</td>
                        <td><span style="color:${a.severity === 'SEVERE' ? 'var(--error-color)' : a.severity === 'MODERATE' ? 'orange' : 'yellow'}">${a.severity}</span></td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }

            // NEWS2 Score
            if (result.news2Score) {
                html += `<div style="margin:16px 0;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;">
                    <h4>📊 NEWS2 Score: ${result.news2Score.score}/20</h4>
                    <p style="color:${result.news2Score.risk === 'HIGH' ? 'var(--error-color)' : result.news2Score.risk === 'MODERATE' ? 'orange' : 'var(--success-color)'}">
                        <strong>${result.news2Score.risk} RISK</strong>
                    </p>
                    <p style="font-size:13px;">${result.news2Score.interpretation}</p>
                </div>`;
            }

            // Treatment recommendations
            if (result.treatmentRecommendations) {
                html += '<h4 style="margin-top:16px;">💊 Khuyến nghị điều trị:</h4>';
                const tr = result.treatmentRecommendations;
                if (tr.firstLine && tr.firstLine.length > 0) {
                    html += '<ul>';
                    tr.firstLine.forEach(drug => {
                        html += `<li><strong>${escapeHtml(drug.drug)}</strong>: ${escapeHtml(drug.dose)} <em>(${escapeHtml(drug.evidence)})</em></li>`;
                    });
                    html += '</ul>';
                }
                if (tr.citation) {
                    html += `<p style="font-size:12px;color:var(--text-secondary-color);margin-top:8px;">📖 ${escapeHtml(tr.citation)}</p>`;
                }
            }

            // XAI Explanation
            if (result.xaiExplanation) {
                // xaiExplanation có thể là string hoặc object
                let xaiText = '';
                if (typeof result.xaiExplanation === 'string') {
                    xaiText = result.xaiExplanation;
                } else if (typeof result.xaiExplanation === 'object') {
                    // If it's an object, try to extract text from common properties
                    xaiText = result.xaiExplanation.reasoning || 
                              result.xaiExplanation.text || 
                              result.xaiExplanation.explanation ||
                              JSON.stringify(result.xaiExplanation, null, 2);
                }
                
                let xaiHtml = xaiText;
                if (typeof marked !== 'undefined' && xaiText) {
                    try {
                        xaiHtml = marked.parse(xaiText);
                    } catch (e) {
                        console.warn('XAI markdown parse error:', e);
                        xaiHtml = xaiText.replace(/\n/g, '<br>');
                    }
                }
                
                if (xaiHtml) {
                    html += `<details style="margin-top:16px;">
                        <summary style="cursor:pointer;color:var(--accent-color);"><strong>🧠 Giải thích AI (XAI)</strong></summary>
                        <div style="margin-top:8px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;">
                            ${xaiHtml}
                        </div>
                    </details>`;
                }
            }
            
            // Warning message
            if (result.warning) {
                html += `<div class="warning" style="margin-top:20px;padding:12px;background:rgba(241,224,90,0.12);border-left:4px solid #f1e05a;color:#d4c873;font-size:14px;border-radius:4px;">
                    ${result.warning}
                </div>`;
            }

            html += '</div>';
            
            bubbleElement.innerHTML = html;
            
            // Render LaTeX in diagnosis
            console.log('🔍 Rendering LaTeX in diagnosis...');
            if (typeof renderMathInElement === 'function') {
                try {
                    renderMathInElement(bubbleElement, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                    console.log('✅ LaTeX rendered successfully');
                } catch (e) {
                    console.warn('⚠️ LaTeX render error:', e);
                }
            } else {
                console.warn('⚠️ renderMathInElement not available');
            }
        }

        function renderProfessionalResponse(result, bubbleElement) {
            stopThinking(bubbleElement);
            
            console.log('🩺 Rendering professional response:', result);
            
            // LUÔN dùng consultation (markdown thô) thay vì consultationHtml để render đúng
            const consultationText = result.consultation || result.analysis || result.reply || '';
            
            if (!consultationText) {
                bubbleElement.innerHTML = '<div class="error-message">Không nhận được phản hồi từ server</div>';
                return;
            }
            
            // Parse markdown
            let renderedHtml = consultationText;
            
            if (typeof marked !== 'undefined') {
                try {
                    // Configure marked options
                    marked.setOptions({
                        breaks: true,  // Convert \n to <br>
                        gfm: true,     // GitHub Flavored Markdown
                        tables: true,  // Support tables
                        sanitize: false // Allow HTML in markdown
                    });
                    renderedHtml = marked.parse(consultationText);
                } catch (e) {
                    console.warn('Markdown parse error:', e);
                    renderedHtml = consultationText.replace(/\n/g, '<br>');
                }
            } else {
                console.warn('marked library not loaded, using fallback');
                renderedHtml = consultationText.replace(/\n/g, '<br>');
            }
            
            // Apply professional styling
            bubbleElement.innerHTML = `
                <div class="professional-consultation">
                    ${renderedHtml}
                </div>
            `;
            
            // Render LaTeX if available
            if (typeof renderMathInElement !== 'undefined') {
                try {
                    renderMathInElement(bubbleElement, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\[', right: '\\]', display: true},
                            {left: '\\(', right: '\\)', display: false}
                        ],
                        throwOnError: false
                    });
                } catch (e) {
                    console.warn('LaTeX render error:', e);
                }
            }
            
            // Apply syntax highlighting if available
            if (typeof hljs !== 'undefined') {
                bubbleElement.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }

        function showThinking(bubble) {
            bubble.innerHTML = '<div class="thinking-dots"><span></span><span></span><span></span></div>';
        }

        function stopThinking(bubble) {
            const thinking = bubble.querySelector('.thinking-dots');
            if (thinking) thinking.remove();
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Enter key to send
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitData();
                }
            });

            // Click nút gửi (dự phòng cho onclick)
            const sendBtn = document.getElementById('send-btn');
            if (sendBtn) {
                sendBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('🔘 Send button clicked via event listener');
                    submitData();
                });
            }

            // Nút gửi của modal thông tin bệnh nhân
            const submitPatientBtn = document.getElementById('submit-patient-info-btn');
            if (submitPatientBtn) {
                submitPatientBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    submitProfessionalWithPatientInfo();
                });
            }

            // Tạo ID phiên khi tải trang
            if (!currentSessionId) {
                generateSessionId();
            }
        });

        // ========================================
        // ANIMATE CÁC BƯỚC PHÂN TÍCH (UX)
        // ========================================
        async function animateAnalysisSteps(bubbleElement) {
            stopThinking(bubbleElement);
            
            // Clear previous content
            bubbleElement.innerHTML = '';

            const steps = [
                { text: 'Đang phân tích...', delay: 1000 },
                { text: 'Đang thu thập dữ liệu bệnh án...', delay: 1500 },
                { text: 'Đang so sánh triệu chứng...', delay: 1200 },
                { text: 'Đang đưa ra chẩn đoán khả thi...', delay: 1300 },
                { text: 'Đang lập kế hoạch điều trị...', delay: 1100 },
                { text: 'Hoàn tất!', delay: 800 }
            ];

            for (const step of steps) {
                const stepEl = document.createElement('div');
                stepEl.className = 'step-item';
                stepEl.innerHTML = `
                    <div class="icon"><i class="fas fa-check-circle"></i></div>
                    <div class="text">${step.text}</div>
                `;
                bubbleElement.appendChild(stepEl);
                bubbleElement.scrollTop = bubbleElement.scrollHeight;

                await new Promise(resolve => setTimeout(resolve, step.delay));
            }

            // Final message
            bubbleElement.innerHTML += `
                <div class="step-item completed">
                    <div class="icon"><i class="fas fa-thumbs-up"></i></div>
                    <div class="text">Phân tích hoàn tất! Xem kết quả bên dưới.</div>
                </div>
            `;
            bubbleElement.scrollTop = bubbleElement.scrollHeight;
        }

        async function animateProfessionalAnalysis(bubbleElement, hasImages = false) {
            stopThinking(bubbleElement);
            
            // Clear previous content
            bubbleElement.innerHTML = '';

            const steps = [
                { text: 'Đang phân tích hồ sơ bệnh nhân...', delay: 1000 }
            ];
            
            // Chỉ thêm bước xử lý ảnh nếu có ảnh
            if (hasImages) {
                steps.push({ text: 'Đang xử lý ảnh y tế (X-ray/MRI/CT)...', delay: 1500 });
            }
            
            steps.push(
                { text: 'Đang tra cứu cơ sở dữ liệu thuốc...', delay: 1200 },
                { text: 'Đang tạo chẩn đoán học thuật...', delay: 1300 },
                { text: 'Đang lập kế hoạch chăm sóc & dinh dưỡng...', delay: 1100 },
                { text: 'Đang lưu hồ sơ bệnh nhân...', delay: 900 },
                { text: 'Hoàn tất!', delay: 800 }
            );

            for (const step of steps) {
                const stepEl = document.createElement('div');
                stepEl.className = 'step-item';
                stepEl.innerHTML = `
                    <div class="icon"><i class="fas fa-check-circle"></i></div>
                    <div class="text">${step.text}</div>
                `;
                bubbleElement.appendChild(stepEl);
                bubbleElement.scrollTop = bubbleElement.scrollHeight;

                await new Promise(resolve => setTimeout(resolve, step.delay));
            }

            // Final message
            bubbleElement.innerHTML += `
                <div class="step-item completed">
                    <div class="icon"><i class="fas fa-user-md"></i></div>
                    <div class="text">Phân tích chuyên môn hoàn tất! Xem kết quả bên dưới.</div>
                </div>
            `;
            bubbleElement.scrollTop = bubbleElement.scrollHeight;
        }

        // Tự động bọc biểu thức toán học trong dấu phân cách LaTeX
        // Phát hiện các mẫu toán học phổ biến như x^2, √5, phân số, phương trình
        function autoWrapMathExpressions(text) {
            if (!text || typeof text !== 'string') return text;
            
            // Bỏ qua nếu đã có dấu phân cách LaTeX
            if (text.includes('$') || text.includes('\\(') || text.includes('\\[')) return text;
            
            // Bảo vệ code blocks và inline code khỏi bị sửa đổi
            const codeBlocks = [];
            const inlineCode = [];
            
            // Extract code blocks
            text = text.replace(/```[\s\S]*?```/g, (match) => {
                codeBlocks.push(match);
                return `__CODE_BLOCK_${codeBlocks.length - 1}__`;
            });
            
            // Extract inline code
            text = text.replace(/`[^`]+`/g, (match) => {
                inlineCode.push(match);
                return `__INLINE_CODE_${inlineCode.length - 1}__`;
            });
            
            // === GIAI ĐOẠN 1: Các mẫu phức tạp trước ===
            
            // 1. Phương trình với căn bậc hai: x = √5, x = -√5
            text = text.replace(/\b([a-zA-Z])\s*=\s*-?\s*√(\d+)/g, '$$$1 = -\\sqrt{$2}$$');
            text = text.replace(/\b([a-zA-Z])\s*=\s*√(\d+)/g, '$$$1 = \\sqrt{$2}$$');
            
            // 2. Square root with parentheses: √(x+5) → $\sqrt{x+5}$
            text = text.replace(/√\(([^)]+)\)/g, '$\\sqrt{$1}$');
            
            // 3. Power of sqrt: (√5)^2 → $(\sqrt{5})^2$
            text = text.replace(/\(√(\d+)\)\^(\d+)/g, '$(\\sqrt{$1})^{$2}$');
            
            // 4. Standalone sqrt: √5 → $\sqrt{5}$
            text = text.replace(/√(\d+)/g, '$\\sqrt{$1}$');
            text = text.replace(/√([a-zA-Z])/g, '$\\sqrt{$1}$');
            
            // === GIAI ĐOẠN 2: Số mũ ===
            
            // 5. Biểu thức với số mũ trong ngoặc: (x+1)^2
            text = text.replace(/\(([^)]+)\)\^(\d+)/g, '$($1)^{$2}$');
            
            // 6. Biến/số với số mũ: x^2, 2^10
            text = text.replace(/\b([a-zA-Z0-9]+)\^(\d+)\b/g, '$$$1^{$2}$$');
            text = text.replace(/\b([a-zA-Z])\^([a-zA-Z0-9]+)\b/g, '$$$1^{$2}$$');
            
            // === GIAI ĐOẠN 3: Phương trình ===
            
            // 7. Phương trình đơn giản: x = 5, x + y = 10
            // (bỏ qua nếu đã được bọc trong các giai đoạn trước)
            text = text.replace(/(?<!\$)\b([a-zA-Z][²³⁴⁵⁶⁷⁸⁹⁰]*)\s*=\s*([0-9\.\-+]+)\b(?!\$)/g, '$$$1 = $2$$');
            
            // 8. Phương trình với toán tử: x + y = 10
            text = text.replace(/\b([a-zA-Z])\s*([+\-])\s*([a-zA-Z0-9])\s*=\s*([0-9\.\-+]+)/g, '$$$1 $2 $3 = $4$$');
            
            // === GIAI ĐOẠN 4: Phân số ===
            
            // 9. Phân số a/b → $\frac{a}{b}$ (chỉ trong ngữ cảnh toán học, không phải URL)
            text = text.replace(/(?<![\w:\/])\b(\d+)\/(\d+)\b(?![\w\/])/g, '$\\frac{$1}{$2}$');
            
            // === GIAI ĐOẠN 5: Ký hiệu đặc biệt ===
            
            // 10. Ký hiệu đặc biệt (bọc riêng lẻ)
            text = text.replace(/±/g, '$\\pm$');
            text = text.replace(/×/g, '$\\times$');
            text = text.replace(/÷/g, '$\\div$');
            text = text.replace(/≤/g, '$\\leq$');
            text = text.replace(/≥/g, '$\\geq$');
            text = text.replace(/≠/g, '$\\neq$');
            text = text.replace(/∞/g, '$\\infty$');
            text = text.replace(/≈/g, '$\\approx$');
            
            // === GIAI ĐOẠN 6: Ký tự mũ Unicode ===
            
            // 11. Số ở dạng mũ sang số mũ đúng: x² → $x^2$
            text = text.replace(/([a-zA-Z])([²³⁴⁵⁶⁷⁸⁹⁰]+)/g, (match, letter, superscripts) => {
                const normalMap = {'²':'2','³':'3','⁴':'4','⁵':'5','⁶':'6','⁷':'7','⁸':'8','⁹':'9','⁰':'0'};
                const exp = superscripts.split('').map(c => normalMap[c] || c).join('');
                return `$${letter}^{${exp}}$`;
            });
            
            // === GIAI ĐOẠN 7: Dọn dẹp ===
            
            // 12. Gộp các dấu phân cách $ liên tiếp ($$$ → $$, nhưng giữ $$ hiển thị riêng với $ nội tuyến)
            text = text.replace(/\$\$/g, '__DISPLAY__');
            text = text.replace(/\$+/g, '$');
            text = text.replace(/__DISPLAY__/g, '$$');
            
            // 13. Merge adjacent inline math: $x$ $=$ $5$ → $x = 5$
            text = text.replace(/\$([^$]+)\$\s*\$([^$]+)\$/g, '$$$1 $2$$');
            text = text.replace(/\$([^$]+)\$\s*\$([^$]+)\$/g, '$$$1 $2$$'); // Run twice for chains
            
            // Khôi phục code blocks và inline code
            text = text.replace(/__CODE_BLOCK_(\d+)__/g, (_, i) => codeBlocks[i]);
            text = text.replace(/__INLINE_CODE_(\d+)__/g, (_, i) => inlineCode[i]);
            
            return text;
        }

        async function renderBotReplyAnimated(bubbleElement, htmlContent) {
            stopThinking(bubbleElement);
            
            // Auto-wrap math expressions in LaTeX delimiters
            htmlContent = autoWrapMathExpressions(htmlContent);
            
            // Parse markdown sang HTML - LUÔN parse nếu marked khả dụng
            let finalHtml = htmlContent;
            if (typeof marked !== 'undefined' && marked.parse) {
                try {
                    // Bật GFM (GitHub Flavored Markdown) cho bảng
                    finalHtml = marked.parse(htmlContent, {
                        breaks: true,
                        gfm: true, // Support tables, strikethrough, etc.
                        tables: true,
                        smartLists: true,
                        smartypants: false,
                        headerIds: false,
                        mangle: false
                    });
                    console.log('✅ Markdown parsed successfully');
                } catch (e) {
                    console.warn('❌ Markdown parse error:', e);
                    // Fallback to plain HTML
                    finalHtml = htmlContent;
                }
            }
            
            // Tạo phần bọc
            const wrapper = document.createElement('div');
            wrapper.className = 'bot-reply-content';
            wrapper.style.opacity = '0';
            bubbleElement.innerHTML = '';
            bubbleElement.appendChild(wrapper);
            
            // Kiểu Gemini: Hiện nội dung ngay với fade-in (không gõ từng ký tự)
            wrapper.innerHTML = finalHtml;
            
            // Render toán LaTeX TRƯỚC khi fade-in để tránh nhấp nháy
            if (typeof renderMathInElement === 'function') {
                try {
                    renderMathInElement(wrapper, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                } catch (e) {
                    console.warn('KaTeX render error:', e);
                }
            }
            
            // Animation fade in SAU KHI LaTeX được render
            requestAnimationFrame(() => {
                wrapper.style.transition = 'opacity 0.4s ease-out';
                wrapper.style.opacity = '1';
            });
            
            // Cuộn mượt xuống cuối
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 150);
            
            return { finish: () => {}, replace: (html) => { wrapper.innerHTML = html; } };
        }
    </script>
    <script>
/* === 3D Tilt Effect Script ===
   Áp dụng cho: đăng nhập / đăng xuất / xóa lịch sử (auth-btn),
   nút Diagnose (#mode-btn), Jaremis Pro (#think-btn),
   đính kèm file (paperclip – nút action-btn đầu tiên trong #tool-buttons),
   ghi âm (#mic-btn).
   Muốn thêm send: thêm '#send-btn' vào SELECTORS.
*/
(function(){
  const SELECTORS = [
    '.auth-controls .auth-btn',        // đăng nhập / đăng ký / đăng xuất / xóa lịch sử
    '#mode-btn',                       // Diagnose toggle
    '#think-btn',                      // Jaremis Pro
    '#mic-btn',                        // Mic
    '#tool-buttons .action-btn:first-child', // Paperclip
    '.new-chat-btn',                   // "Cuộc trò chuyện mới"
    '#send-btn',                       // Gửi
    '.btn-primary',                    // Nút Đăng nhập / Đăng ký
    '.btn-ghost'                       // Nút Hủy
  ];
  const MAX_TILT = 14;
  const PERSPECTIVE = 800;
  function applyTilt(el){
    if(!el || el.dataset.tiltApplied) return;
    el.dataset.tiltApplied = '1';
    el.classList.add('tilt-3d');
    function move(e){
      const rect = el.getBoundingClientRect();
      const x = (e.clientX - rect.left)/rect.width;
      const y = (e.clientY - rect.top)/rect.height;
      const rotX = (0.5 - y) * (MAX_TILT * 2);
      const rotY = (x - 0.5) * (MAX_TILT * 2);
      el.style.setProperty('--mx', (x*100).toFixed(2)+'%');
      el.style.setProperty('--my', (y*100).toFixed(2)+'%');
      el.style.transform = `perspective(${PERSPECTIVE}px) rotateX(${rotX}deg) rotateY(${rotY}deg) translateZ(6px)`;
      el.style.setProperty('--glow-o','1');
    }
    function leave(){
      el.style.transform = `perspective(${PERSPECTIVE}px) rotateX(0deg) rotateY(0deg) translateZ(0)`;
      el.style.setProperty('--glow-o','0');
    }
    el.addEventListener('mousemove', move);
    el.addEventListener('mouseenter', move);
    el.addEventListener('mouseleave', leave);
    el.addEventListener('touchmove', (e)=>{
      const t = e.touches[0];
      move(t);
    }, {passive:true});
    el.addEventListener('touchend', leave);
  }
  function scan(){
    SELECTORS.forEach(sel=>{
      document.querySelectorAll(sel).forEach(applyTilt);
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    scan();
    // Quan sát auth-controls vì nút được tạo động
    const auth = document.querySelector('.auth-controls');
    if(auth){
      new MutationObserver(scan).observe(auth,{childList:true,subtree:true});
    }
  });
})();
</script>
<script>
// ================= REALISTIC SNOW v2 (restored) =================
(function(){
  const canvas = document.getElementById('snow-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const CONFIG = {
    density: 0.11,
    globalSpeed: 1.0,
    windOscAmp: 0.55,
    windOscSpeed: 0.06,
    perParticleSway: 0.35,
    maxDrift: 0.35,
    fadeIn: true
  };
  const LAYERS = [
    { name:'far',  size:[0.6,1.4], speedY:[14,24], alpha:[0.15,0.35], blur:0,   countRatio:0.40 },
    { name:'mid',  size:[1.0,2.2], speedY:[22,38], alpha:[0.22,0.55], blur:0.5, countRatio:0.38 },
    { name:'near', size:[1.8,3.4], speedY:[34,58], alpha:[0.30,0.75], blur:0.9, countRatio:0.22 }
  ];
  let W=0,H=0, particles=[];
  let lastTime = performance.now();
  let windBase = 0;
  function rand(a,b){ return Math.random()*(b-a)+a; }
  function resize(){
    W = canvas.width  = canvas.offsetWidth  = canvas.parentElement.offsetWidth;
    H = canvas.height = canvas.offsetHeight = canvas.parentElement.offsetHeight;
    buildParticles();
  }
  window.addEventListener('resize', throttle(resize,250));
  resize();
  function totalCount(){ return Math.round((W*H/1000) * CONFIG.density); }
  function buildParticles(){
    particles.length = 0;
    const total = totalCount();
    LAYERS.forEach(layer=>{
      const need = Math.round(total * layer.countRatio);
      for(let i=0;i<need;i++){
        particles.push(makeParticle(layer, Math.random()*W, Math.random()*H));
      }
    });
  }
  function makeParticle(layer,x,y){
    const speedY = rand(layer.speedY[0], layer.speedY[1]) / 60 * CONFIG.globalSpeed;
    const r = rand(layer.size[0], layer.size[1]);
    return {
      layer,x,y,r,
      baseVy: speedY,
      alpha: rand(layer.alpha[0], layer.alpha[1]),
      swayOffset: Math.random()*Math.PI*2,
      swaySpeed: rand(0.4,1.1),
      driftSeed: Math.random()*1000,
      life:0,
      blur:layer.blur
    };
  }
  function update(dt){
    windBase += CONFIG.windOscSpeed * dt;
    const globalWind = Math.sin(windBase) * CONFIG.windOscAmp;
    for(let p of particles){
      p.life += dt;
      const sway = Math.sin(p.swayOffset + p.life * p.swaySpeed) * CONFIG.perParticleSway;
      const drift = (Math.sin((p.driftSeed + p.life*30)*0.015)+Math.sin((p.driftSeed + p.life*55)*0.011))*0.5*CONFIG.maxDrift;
      p.x += (globalWind + sway + drift) * (0.6 + (p.r*0.12));
      p.y += p.baseVy * dt * 60;
      if(p.x > W+8) p.x = -8;
      else if(p.x < -8) p.x = W+8;
      if(p.y > H+10){
        p.x = Math.random()*W;
        p.y = rand(-40,-10);
        p.life = 0;
        p.baseVy = rand(p.layer.speedY[0], p.layer.speedY[1]) / 60 * CONFIG.globalSpeed;
        p.r = rand(p.layer.size[0], p.layer.size[1]);
        p.alpha = rand(p.layer.alpha[0], p.layer.alpha[1]);
      }
    }
  }
  function draw(){
    ctx.clearRect(0,0,W,H);
    for(let layer of LAYERS){
      ctx.save();
      for(let p of particles){
        if(p.layer !== layer) continue;
        const a = CONFIG.fadeIn ? Math.min(p.alpha, p.alpha*(p.life*0.6)) : p.alpha;
        ctx.globalAlpha = a;
        if(p.blur>0){
          ctx.shadowBlur = p.blur*8;
          ctx.shadowColor = 'rgba(255,255,255,'+a+')';
        } else ctx.shadowBlur = 0;
        ctx.beginPath();
        ctx.fillStyle = '#fff';
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }
  }
  function loop(now){
    const dt = Math.min(0.07, (now - lastTime)/1000);
    lastTime = now;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
  function throttle(fn, ms){
    let t=0;
    return function(...args){
      if(performance.now()-t>ms){ t=performance.now(); fn.apply(this,args); }
    };
  }
})();
</script>
<script>
// ==== FIND MODAL (Word-like) ====
let findMatches = [];
let currentFindIndex = -1;
let lastFindQuery = '';
let findObserver = null;

function openFindModal(){
  const b = document.getElementById('find-backdrop');
  if(!b) return;
  b.style.display='flex';
  const inp = document.getElementById('find-query');
  setTimeout(()=>inp.focus(),30);
  if(lastFindQuery){ inp.value = lastFindQuery; performFind(lastFindQuery); }
}
function closeFindModal(){
  const b = document.getElementById('find-backdrop');
  if(b) b.style.display='none';
  clearFindHighlights();
}
document.addEventListener('keydown', e=>{
  if(e.key==='Escape'){
    const b=document.getElementById('find-backdrop');
    if(b && b.style.display!=='none'){ closeFindModal(); }
  }
});

function performFind(q){
  lastFindQuery = q;
  clearFindHighlights(true);
  if(!q){
    updateFindCount();
    return;
  }
  const caseSensitive = document.getElementById('find-case')?.checked;
  let re;
  try { re = new RegExp(escapeRegExp(q), caseSensitive?'g':'gi'); } catch(_){ return; }
  const container = document.getElementById('chat-messages');
  if(!container) return;

  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {
    acceptNode: n=>{
      if(!n.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
      if(n.parentElement && n.parentElement.classList.contains('find-highlight')) return NodeFilter.FILTER_REJECT;
      return NodeFilter.FILTER_ACCEPT;
    }
  });
  const nodes=[];
  while(walker.nextNode()) nodes.push(walker.currentNode);

  nodes.forEach(node=>{
    const txt = node.nodeValue;
    let m,last=0,frag=document.createDocumentFragment(),found=false;
    re.lastIndex=0;
    while((m = re.exec(txt))!==null){
      found=true;
      const pre = txt.slice(last,m.index);
      if(pre) frag.appendChild(document.createTextNode(pre));
      const span = document.createElement('span');
      span.className='find-highlight';
      span.textContent=m[0];
      frag.appendChild(span);
      findMatches.push(span);
      last = m.index + m[0].length;
      if(m[0].length===0) re.lastIndex++;
    }
    if(found){
      const rest = txt.slice(last);
      if(rest) frag.appendChild(document.createTextNode(rest));
      node.parentNode.replaceChild(frag,node);
    }
  });

  currentFindIndex = findMatches.length?0:-1;
  activateCurrentMatch();
  updateFindCount();

  if(findObserver) findObserver.disconnect();
  if(q){
    findObserver = new MutationObserver(()=>{
      const qq = lastFindQuery;
      if(qq) performFind(qq);
    });
    findObserver.observe(container,{childList:true,subtree:true});
  }
}

function findNext(){
  if(!findMatches.length){
    performFind(document.getElementById('find-query').value.trim());
    return;
  }
  currentFindIndex = (currentFindIndex+1) % findMatches.length;
  activateCurrentMatch();
  updateFindCount();
}
function findPrev(){
  if(!findMatches.length){
    performFind(document.getElementById('find-query').value.trim());
    return;
  }
  currentFindIndex = (currentFindIndex-1 + findMatches.length) % findMatches.length;
  activateCurrentMatch();
  updateFindCount();
}

function activateCurrentMatch(){
  findMatches.forEach(s=>s.classList.remove('active'));
  if(currentFindIndex>=0 && findMatches[currentFindIndex]){
    const el = findMatches[currentFindIndex];
    el.classList.add('active');
    const container = document.getElementById('chat-messages');
    const rect = el.getBoundingClientRect();
    const cRect = container.getBoundingClientRect();
    const scrollTo = rect.top - cRect.top + container.scrollTop - (container.clientHeight/2) + rect.height/2;
    container.scrollTo({ top: scrollTo, behavior: 'smooth' });
  }
}

function updateFindCount(){
  const el = document.getElementById('find-count');
  if(!el) return;
  if(!findMatches.length) el.textContent='0 / 0';
  else el.textContent=(currentFindIndex+1)+' / '+findMatches.length;
}

function clearFindHighlights(keepObs){
  if(findObserver && !keepObs){ findObserver.disconnect(); findObserver=null; }
  if(!findMatches.length) return;
  findMatches.forEach(span=>{
    if(span.parentNode){
      span.parentNode.replaceChild(document.createTextNode(span.textContent), span);
    }
  });
  findMatches=[];
  currentFindIndex=-1;
  updateFindCount();
}

function escapeRegExp(str){ 
  if (!str) return '';
  return String(str).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); 
}

document.addEventListener('DOMContentLoaded', ()=>{
  const q=document.getElementById('find-query');
  if(q){
    q.addEventListener('input', e=>performFind(e.target.value.trim()));
    q.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        if(e.shiftKey) findPrev(); else findNext();
      }
    });
  }
  const c=document.getElementById('find-case');
  if(c){ c.addEventListener('change', ()=>performFind(q.value.trim())); }
});
</script>

<!-- KaTeX helper & auto-render (Doctor-style) -->
<script>
(function(){
  if (window._jaremis_shortcuts_installed) return; window._jaremis_shortcuts_installed = true;

  // Hàm hỗ trợ an toàn để click phần tử theo id
  function tryClick(id){ try{ const el = document.getElementById(id); if(el){ el.click(); return true; } }catch(e){} return false; }

  // Cung cấp global stubs nhẹ (sẽ defer sang triển khai thật khi có)
  window.jaremis = window.jaremis || {};
  window.jaremis.ensureRenderMath = function(el){ if (window.renderMathIn) return window.renderMathIn(el); /* no-op until katex loader runs */ };
  // Giữ các hàm wrapResultMath/addResultBoxStyles hiện có nếu có; nếu không thì noop
  if (!window.wrapResultMath) window.wrapResultMath = function(b){ /* sẽ được thay thế bởi triển khai thực tế nếu được định nghĩa sau */ };
  if (!window.addResultBoxStyles) window.addResultBoxStyles = function(){ };

  // Ánh xạ phím tắt (dùng Ctrl+chữ / Ctrl+Shift+chữ). Tránh ghi đè hành vi nhập cơ bản.
  document.addEventListener('keydown', function(e){
    const tgt = e.target || {};
    const tag = (tgt.tagName || '').toUpperCase();
    const isEditable = tag === 'INPUT' || tag === 'TEXTAREA' || tgt.isContentEditable;

    // ESC -> dừng AI (hoạt động toàn cục)
    if (e.key === 'Escape') {
      if (window._currentAbortController) {
        e.preventDefault();
        stopAIResponse();
        return;
      }
    }

    // Ctrl+Enter -> gửi (hoạt động cả khi đang gõ)
    if (e.ctrlKey && !e.shiftKey && e.key === 'Enter') {
      e.preventDefault(); tryClick('send-btn'); return;
    }

    // Nếu đang gõ trong trường văn bản, không chiếm phím tắt khác (trừ send)
    if (isEditable) return;

    // Map single Ctrl+letter and Ctrl+Shift+letter combinations
    if (e.ctrlKey && !e.altKey) {
      const k = (e.key || '').toLowerCase();
      const shift = e.shiftKey;
      // Mic: Ctrl+M
      if (!shift && k === 'm') { e.preventDefault(); tryClick('mic-btn'); flashNotice && flashNotice('Mic toggled (Ctrl+M)'); return; }
      // Attach: Ctrl+Shift+U
      if (shift && k === 'u') { e.preventDefault(); tryClick('attach-btn') || document.getElementById('images')?.click(); flashNotice && flashNotice('Attach file (Ctrl+Shift+U)'); return; }
      // Mode Menu: Ctrl+Shift+K
      if (shift && k === 'k') { e.preventDefault(); openModeMenu(); flashNotice && flashNotice('Mở menu chế độ (Ctrl+Shift+K)'); return; }
      // Model switch: Ctrl+Shift+Y
      if (shift && k === 'y') { e.preventDefault(); tryClick('think-btn'); flashNotice && flashNotice('Switch model (Ctrl+Shift+Y)'); return; }
      // New chat: Ctrl+Shift+X
      if (shift && k === 'x') { e.preventDefault(); startNewConversation && startNewConversation(); flashNotice && flashNotice('New chat (Ctrl+Shift+X)'); return; }
      // Open history/find: Ctrl+Shift+F
      if (shift && k === 'f') { e.preventDefault(); openFindModal && openFindModal(); flashNotice && flashNotice('Find (Ctrl+Shift+F)'); return; }
    }
  }, true);

  // Đảm bảo chatInput Ctrl+Enter hoạt động cả khi focus trong textarea
  try { const ci = document.getElementById('chat-input'); const sb = document.getElementById('send-btn');
    if (ci && sb) {
      ci.addEventListener('keydown', function(ev){ if (ev.ctrlKey && ev.key === 'Enter') { ev.preventDefault(); sb.click(); } });
    }
  } catch(e){}

})();
</script>
<!-- KaTeX helper & auto-render (Doctor-style) -->
<script>
// Định nghĩa helper giống Doctor implementation và observer không gây phiền
if (!window._jaremis_katex_setup) {
  window._jaremis_katex_setup = true;

  // renderMathIn wrapper (an toàn: không ném lỗi, bỏ qua code/pre)
  function renderMathIn(el){
    if (!el || !window.renderMathInElement) return;
    try{
      window.renderMathInElement(el, {
        delimiters: [
          {left: '$$', right: '$$', display: true},
          {left: '$',  right: '$',  display: false},
          {left: '\\[', right: '\\]', display: true},
          {left: '\\(', right: '\\)', display: false}
        ],
        throwOnError: false,
        ignoredTags: ['script','noscript','style','textarea','pre','code'],
        ignoredClasses: ['no-math','katex']
      });
    }catch(err){
      // không can thiệp vào ứng dụng; chỉ cảnh báo
      console.warn('renderMathIn error', err);
    }
  }

  window.renderMathIn = renderMathIn;

  // Chuẩn hóa dấu phân cách LaTeX bên trong các node văn bản của một phần tử.
  function normalizeLatexInElement(el){
    if(!el) return;
    try{
      const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null);
      const nodes = [];
      while(walker.nextNode()) nodes.push(walker.currentNode);
      nodes.forEach(n => {
        let s = n.nodeValue;
        if(!s || (!s.includes('$') && !s.includes('\\(') && !s.includes('\\['))) return;
        // Thu gọn các dấu dollar lặp lại (ví dụ $$$ -> $$)
        s = s.replace(/\${3,}/g, '$$');
        // Convert display $$...$$ to \[ ... \]
        s = s.replace(/\$\$(.*?)\$\$/gs, '\\[$1\\]');
        // Convert simple inline $...$ to \\( ... \\)
        // Avoid replacing when $ is adjacent to whitespace at boundaries
        s = s.replace(/\$(\S[\s\S]*?\S)\$/gs, '\\\($1\\\)');
        // Trim accidental spaces inside delimiters
        s = s.replace(/\\\(\s+/g,'\\\\(').replace(/\s+\\\)/g,'\\\\)');
        n.nodeValue = s;
      });
    }catch(err){ console.warn('normalizeLatexInElement error', err); }
  }

  function cleanupStrayDollarSigns(el){
    if(!el) return;
    try{
      const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null);
      const nodes = [];
      while(walker.nextNode()) nodes.push(walker.currentNode);
      for(const n of nodes){
        // bỏ qua text nodes nằm trong element đã render KaTeX
        if(n.parentElement && n.parentElement.closest && n.parentElement.closest('.katex')) continue;
        let s = n.nodeValue;
        if(!s || !s.includes('$')) continue;
        // Xóa dấu dollar đơn hoặc kép không escape còn sót lại (giữ \$)
        // Dùng lookbehind để tránh xóa \$
        try{
          s = s.replace(/(?<!\\)\${1,2}/g, '');
        }catch(e){
          // dự phòng cho engine cũ hơn: xóa tất cả $ rồi khôi phục chuỗi escape
          s = s.replace(/\\\$/g, '__ESC_DOLLAR__').replace(/\$/g,'').replace(/__ESC_DOLLAR__/g,'\\$');
        }
        n.nodeValue = s;
      }
    }catch(err){ console.warn('cleanupStrayDollarSigns error', err); }
  }

  function renderBubbleIfNeeded(bubble){
    if (!bubble || bubble.dataset.katexRendered) return;
    if (!bubble.classList || !bubble.classList.contains('chat-bubble')) return;
    // Normalize delimiters first to avoid stray $ and inconsistent markers
    normalizeLatexInElement(bubble);
    renderMathIn(bubble);
    // Remove any leftover $ or $$ in plain text nodes outside KaTeX elements
    cleanupStrayDollarSigns(bubble);
    bubble.dataset.katexRendered = '1';
  }

  // Tự động render các bubble chat hiện có và mới thêm.
  document.addEventListener('DOMContentLoaded', ()=>{
    const container = document.getElementById('chat-messages');
    if (!container) return;
    // Render các bubble hiện có
    container.querySelectorAll('.chat-bubble').forEach(renderBubbleIfNeeded);
    // Observe added nodes
    const mo = new MutationObserver(muts=>{
      for (const m of muts){
        for (const n of m.addedNodes){
          if (n.nodeType !== 1) continue;
          if (n.classList && n.classList.contains('chat-bubble')) renderBubbleIfNeeded(n);
          else if (n.querySelectorAll) n.querySelectorAll('.chat-bubble').forEach(renderBubbleIfNeeded);
        }
      }
    });
    mo.observe(container, { childList: true, subtree: true });
  });
}
</script>

<!-- Animated Reply Script -->
<script src="animated-reply.js"></script>
<script>
// Cấu hình marked.js cho việc render markdown tốt hơn
if (typeof marked !== 'undefined') {
    marked.setOptions({
        breaks: true,
        gfm: true,
        tables: true,
        sanitize: false
    });
}

// Hàm hiển thị phản hồi của bot với hiệu ứng streaming kiểu Gemini
async function renderBotReplyAnimated(bubbleElement, htmlContent) {
    stopThinking(bubbleElement);
    
    // Tự động bọc biểu thức toán trong dấu phân cách LaTeX
    htmlContent = autoWrapMathExpressions(htmlContent);
    
    // Phân tích markdown sang HTML nếu nội dung trông giống markdown
    let finalHtml = htmlContent;
    if (typeof marked !== 'undefined' && (htmlContent.includes('##') || htmlContent.includes('|') || htmlContent.includes('-'))) {
        try {
            // Bật GFM (GitHub Flavored Markdown) cho bảng
            finalHtml = marked.parse(htmlContent, {
                breaks: true,
                gfm: true, // Hỗ trợ bảng, gạch ngang, v.v.
                tables: true
            });
        } catch (e) {
            console.warn('Lỗi phân tích Markdown:', e);
        }
    }
    
    // Create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'bot-reply-content';
    wrapper.style.opacity = '0';
    bubbleElement.innerHTML = '';
    bubbleElement.appendChild(wrapper);
    
    // Kiểu Gemini: Hiện nội dung ngay với fade-in (không gõ từng ký tự)
    wrapper.innerHTML = finalHtml;
    
    // Render LaTeX math BEFORE fade-in to avoid flicker
    if (typeof renderMathInElement === 'function') {
        try {
            renderMathInElement(wrapper, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false
            });
        } catch (e) {
            console.warn('KaTeX render error:', e);
        }
    }
    
    // Animation fade in SAU KHI LaTeX được render
    requestAnimationFrame(() => {
        wrapper.style.transition = 'opacity 0.4s ease-out';
        wrapper.style.opacity = '1';
    });
    
    // Smooth scroll to bottom
    setTimeout(() => {
        chatMessages.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: 'smooth'
        });
    }, 150);
    
    return { finish: () => {}, replace: (html) => { wrapper.innerHTML = html; } };
}
</script>

<script>
// ==== FIX 1: NEW CONVERSATION FUNCTION ====
function startNewConversation() {
  // Tạo session ID mới
  currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('jaremis_session', currentSessionId);
  
  // Clear chat messages
  chatMessages.innerHTML = '';
  
  // Bỏ highlight tất cả history items
  document.querySelectorAll('.history li').forEach(li => {
    li.style.background = 'transparent';
    li.style.borderColor = 'transparent';
  });
  
  // Focus vào input
  chatInput.focus();
  
  console.log('🆕 Bắt đầu cuộc trò chuyện mới:', currentSessionId);
}

// ==== FIX 3: ADVANCED SEARCH MODAL (2 MODES) ====
let currentSearchMode = 'questions'; // 'questions' or 'conversations'
let searchCacheData = [];

// Override openFindModal
const originalOpenFindModal = window.openFindModal;
window.openFindModal = function(){
  const b = document.getElementById('find-backdrop');
  if(!b) return;
  b.style.display='flex';
  const inp = document.getElementById('find-query');
  setTimeout(()=>inp.focus(),30);
  
  // Build search cache
  buildSearchCacheData();
}

// Override closeFindModal
const originalCloseFindModal = window.closeFindModal;
window.closeFindModal = function(){
  const b = document.getElementById('find-backdrop');
  if(b) b.style.display='none';
  const inp = document.getElementById('find-query');
  if(inp) inp.value = '';
  const resultsDiv = document.getElementById('search-results');
  if(resultsDiv) {
    resultsDiv.innerHTML = `
      <div style="text-align:center;color:var(--text-secondary-color);padding:40px 20px;">
        <i class="fas fa-search" style="font-size:48px;opacity:0.3;margin-bottom:16px;"></i>
        <div>Nhập từ khóa để tìm kiếm</div>
      </div>
    `;
  }
}

function switchSearchTab(mode) {
  currentSearchMode = mode;
  document.querySelectorAll('.search-tab').forEach(tab => {
    tab.classList.remove('active');
    tab.style.borderBottomColor = 'transparent';
    tab.style.color = 'var(--text-secondary-color)';
  });
  
  const activeTab = document.getElementById(`search-tab-${mode}`);
  if(activeTab) {
    activeTab.classList.add('active');
    activeTab.style.borderBottomColor = 'var(--accent-color)';
    activeTab.style.color = 'var(--accent-color)';
  }
  
  // Re-search với mode mới
  const query = document.getElementById('find-query')?.value;
  if (query) performSearchAdvanced(query);
}

function buildSearchCacheData() {
  searchCacheData = [];
  const sessions = {};
  
  // Group by session
  if(!historyCache || !historyCache.length) return;
  
  historyCache.forEach(entry => {
    // Kiểm tra an toàn: đảm bảo entry tồn tại và hợp lệ
    if (!entry || typeof entry !== 'object') {
      console.warn('⚠️ Invalid history entry:', entry);
      return;
    }
    
    const sid = entry.sessionId || ('legacy-' + entry.id);
    if (!sessions[sid]) {
      sessions[sid] = {
        id: sid,
        title: entry.conversationTitle || '',
        messages: []
      };
    }
    
    if (entry.input && entry.input.trim()) {
      sessions[sid].messages.push({
        type: 'user',
        text: entry.input,
        timestamp: entry.timestamp || Date.now(),
        fullEntry: entry
      });
    }
    
    const reply = entry.type === 'diagnose' ? entry.diagnosis : entry.reply;
    if (reply && reply.trim()) {
      sessions[sid].messages.push({
        type: 'bot',
        text: reply,
        timestamp: entry.timestamp || Date.now(),
        fullEntry: entry
      });
    }
  });
  
  // Generate search cache
  Object.values(sessions).forEach(session => {
    // Set title if not exists
    if (!session.title && session.messages && session.messages.length > 0) {
      const firstUserMsg = session.messages.find(m => m && m.type === 'user');
      session.title = (firstUserMsg && firstUserMsg.text) ? firstUserMsg.text.slice(0, 60) : 'Cuộc trò chuyện';
    }
    
    if (session.messages && Array.isArray(session.messages)) {
      session.messages.forEach((msg, idx) => {
        // Safe check: ensure msg exists and has required properties
        if (msg && typeof msg === 'object') {
          searchCacheData.push({
            sessionId: session.id,
            sessionTitle: session.title || 'Cuộc trò chuyện',
            messageIndex: idx,
            messageType: msg.type || 'unknown',
            messageText: msg.text || msg.input || msg.reply || '',
            timestamp: msg.timestamp || Date.now(),
            fullEntry: msg.fullEntry || msg
          });
        }
      });
    }
  });
}

function performSearchAdvanced(query) {
  const resultsDiv = document.getElementById('search-results');
  if(!resultsDiv) return;
  
  if (!query || !query.trim()) {
    resultsDiv.innerHTML = `
      <div style="text-align:center;color:var(--text-secondary-color);padding:40px 20px;">
        <i class="fas fa-search" style="font-size:48px;opacity:0.3;margin-bottom:16px;"></i>
        <div>Nhập từ khóa để tìm kiếm</div>
      </div>
    `;
    return;
  }
  
  const q = query.toLowerCase();
  let results = [];
  
  if (currentSearchMode === 'questions') {
    // Tìm câu hỏi - with safe checks
    results = searchCacheData.filter(item => 
      item && 
      item.messageType === 'user' && 
      item.messageText && 
      item.messageText.toLowerCase().includes(q)
    );
    
    if (results.length === 0) {
      resultsDiv.innerHTML = `
        <div style="text-align:center;color:var(--text-secondary-color);padding:40px 20px;">
          <i class="fas fa-search" style="font-size:48px;opacity:0.3;margin-bottom:16px;"></i>
          <div>Không tìm thấy câu hỏi nào</div>
        </div>
      `;
    } else {
      resultsDiv.innerHTML = results.map(r => {
        const highlighted = highlightSearchText(r.messageText, query);
        return `
          <div class="search-result-item" onclick="goToMessageAdvanced('${r.sessionId}', ${r.messageIndex})">
            <div class="search-result-question">${highlighted}</div>
            <div class="search-result-meta">
              <i class="fas fa-comments"></i>
              <span>${escapeHtml(r.sessionTitle)}</span>
              <span>•</span>
              <span>${new Date(r.timestamp).toLocaleString('vi-VN')}</span>
            </div>
          </div>
        `;
      }).join('');
    }
  } else {
    // Tìm cuộc trò chuyện
    const sessions = {};
    historyCache.forEach(entry => {
      // Safe check for entry
      if (!entry || typeof entry !== 'object') return;
      
      const sid = entry.sessionId || ('legacy-' + entry.id);
      if (!sessions[sid]) {
        const title = entry.conversationTitle || 
                     entry.input?.slice(0, 60) || 
                     'Cuộc trò chuyện';
        sessions[sid] = { id: sid, title, count: 0 };
      }
      sessions[sid].count++;
    });
    
    results = Object.values(sessions).filter(s => 
      s.title.toLowerCase().includes(q)
    );
    
    if (results.length === 0) {
      resultsDiv.innerHTML = `
        <div style="text-align:center;color:var(--text-secondary-color);padding:40px 20px;">
          <i class="fas fa-search" style="font-size:48px;opacity:0.3;margin-bottom:16px;"></i>
          <div>Không tìm thấy cuộc trò chuyện nào</div>
        </div>
      `;
    } else {
      resultsDiv.innerHTML = results.map(r => {
        const highlighted = highlightSearchText(r.title, query);
        return `
          <div class="search-result-item" onclick="openConversation('${r.id}'); closeFindModal();">
            <div class="search-result-question">${highlighted}</div>
            <div class="search-result-meta">
              <i class="fas fa-history"></i>
              <span>${r.count} tin nhắn</span>
            </div>
          </div>
        `;
      }).join('');
    }
  }
}

function highlightSearchText(text, query) {
  if (!text) return '';
  const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
  return escapeHtml(text).replace(regex, '<span class="search-highlight">$1</span>');
}

function goToMessageAdvanced(sessionId, messageIndex) {
  openConversation(sessionId);
  closeFindModal();
  
  // Scroll to message
  setTimeout(() => {
    const bubbles = chatMessages.querySelectorAll('.chat-bubble');
    if (bubbles[messageIndex]) {
      bubbles[messageIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
      bubbles[messageIndex].style.animation = 'pulse-highlight 1s';
    }
  }, 200);
}

// Add pulse animation
if(!document.getElementById('search-pulse-animation')) {
  const style = document.createElement('style');
  style.id = 'search-pulse-animation';
  style.textContent = `
    @keyframes pulse-highlight {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(47, 129, 247, 0.4); }
      50% { transform: scale(1.02); box-shadow: 0 0 20px 10px rgba(47, 129, 247, 0.2); }
    }
  `;
  document.head.appendChild(style);
}

// Listen to search input with debounce
let searchTimeout;
setTimeout(() => {
  const searchInput = document.getElementById('find-query');
  if(searchInput) {
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        performSearchAdvanced(e.target.value);
      }, 300);
    });
  }
}, 1000);

// ==== FIX 4: HISTORY MENU (3 chấm) ====
function toggleHistoryMenu(event, sessionId) {
  event.stopPropagation();
  const menu = document.getElementById(`menu-${sessionId}`);
  if(!menu) return;
  
  const allMenus = document.querySelectorAll('.history-dropdown');
  allMenus.forEach(m => {
    if (m.id !== `menu-${sessionId}`) m.classList.remove('show');
  });
  menu.classList.toggle('show');
}

// Đóng menu khi click ra ngoài
document.addEventListener('click', (e) => {
  if(!e.target.closest('.history-menu-btn')) {
    document.querySelectorAll('.history-dropdown').forEach(m => m.classList.remove('show'));
  }
});

// Rename conversation
function renameConversation(sessionId) {
  const entries = historyCache.filter(e => (e.sessionId || ('legacy-'+e.id)) === sessionId);
  if (!entries.length) return;
  
  const currentTitle = entries.find(e => e.conversationTitle)?.conversationTitle || 
                      entries.find(e => e.input)?.input?.slice(0,60) || 
                      'Cuộc trò chuyện';
  
  const newTitle = prompt('Nhập tên mới cho cuộc trò chuyện:', currentTitle);
  if (newTitle && newTitle.trim()) {
    // Lưu title vào entry đầu tiên của session
    entries[0].conversationTitle = newTitle.trim();
    localStorage.setItem('jaremis_history', JSON.stringify(historyCache));
    renderHistoryList(historyCache);
  }
}

// Delete conversation
function deleteConversation(sessionId) {
  if (!confirm('Bạn có chắc muốn xóa cuộc trò chuyện này?')) return;
  
  // Xóa tất cả entries của session
  historyCache = historyCache.filter(e => (e.sessionId || ('legacy-'+e.id)) !== sessionId);
  localStorage.setItem('jaremis_history', JSON.stringify(historyCache));
  renderHistoryList(historyCache);
  
  // Nếu đang xem session này, clear chat
  if (currentSessionId === sessionId) {
    chatMessages.innerHTML = '';
    currentSessionId = null;
    localStorage.removeItem('jaremis_session');
  }
}

console.log('✅ JAREMIS: All fixes loaded successfully!');

// ==== MODE MENU FUNCTIONS ====
let currentMode = 'chat'; // 'chat', 'diagnose', 'professional'

function openModeMenu(e) {
  e?.preventDefault();
  e?.stopPropagation();
  const backdrop = document.getElementById('mode-menu-backdrop');
  if (backdrop) {
    backdrop.classList.add('show');
    updateModeMenuUI();
  }
}

function closeModeMenu() {
  const backdrop = document.getElementById('mode-menu-backdrop');
  if (backdrop) {
    backdrop.classList.remove('show');
  }
}

function selectMode(mode) {
  currentMode = mode;
  
  // Update diagnosticMode for backward compatibility
  if (mode === 'diagnose') {
    diagnosticMode = true;
  } else {
    diagnosticMode = false;
  }
  
  // Update UI
  updateModeButton();
  updateAccountRole();
  closeModeMenu();
  
  // Removed: Professional history button is now always visible
  
  console.log('Mode switched to:', mode);
}

function updateModeButton() {
  const modeBtn = document.getElementById('mode-btn');
  if (!modeBtn) return;
  
  if (currentMode === 'chat') {
    modeBtn.innerHTML = '<i class="fas fa-comments"></i>';
    modeBtn.title = 'Chế độ: Chat';
    modeBtn.classList.remove('active');
  } else if (currentMode === 'diagnose') {
    modeBtn.innerHTML = '<i class="fas fa-stethoscope"></i>';
    modeBtn.title = 'Chế độ: Diagnose';
    modeBtn.classList.add('active');
  } else if (currentMode === 'professional') {
    modeBtn.innerHTML = '<i class="fas fa-user-md"></i>';
    modeBtn.title = 'Chế độ: Professional';
    modeBtn.classList.add('active');
  }
}

function updateModeMenuUI() {
  const options = document.querySelectorAll('.mode-option');
  options.forEach(option => {
    const optionMode = option.dataset.mode;
    if (optionMode === currentMode) {
      option.classList.add('active');
    } else {
      option.classList.remove('active');
    }
  });
}

function updateAccountRole() {
  const accountRole = document.getElementById('account-role');
  if (!accountRole) return;
  
  const roleText = {
    'chat': 'Chế độ: Chat',
    'diagnose': 'Chế độ: Diagnose',
    'professional': 'Chế độ: Professional'
  };
  
  accountRole.textContent = roleText[currentMode] || 'Chế độ: Chat';
}

// ==== ACCOUNT MENU FUNCTIONS ====
function toggleAccountMenu() {
  const accountInfo = document.getElementById('account-info');
  const accountDropdown = document.getElementById('account-dropdown');
  
  if (accountInfo && accountDropdown) {
    accountInfo.classList.toggle('open');
    accountDropdown.classList.toggle('show');
  }
}

// Close account menu when clicking outside
document.addEventListener('click', (e) => {
  const accountSection = document.getElementById('account-section');
  if (accountSection && !accountSection.contains(e.target)) {
    const accountInfo = document.getElementById('account-info');
    const accountDropdown = document.getElementById('account-dropdown');
    if (accountInfo) accountInfo.classList.remove('open');
    if (accountDropdown) accountDropdown.classList.remove('show');
  }
});

function openProfileModal() {
  const backdrop = document.getElementById('profile-modal-backdrop');
  if (backdrop) {
    backdrop.classList.add('show');
    // Load current user data
    const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
    const nameInput = document.getElementById('profile-name');
    const usernameInput = document.getElementById('profile-username');
    const avatarPreview = document.getElementById('profile-avatar-preview');
    
    if (nameInput) nameInput.value = userData.displayName || userData.username || 'Guest User';
    if (usernameInput) usernameInput.value = userData.username || '';
    if (avatarPreview) {
      avatarPreview.src = userData.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${userData.username || 'default'}`;
    }
  }
}

function handleAvatarUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Kiểm tra loại file
  if (!file.type.startsWith('image/')) {
    alert('Vui lòng chọn file ảnh hợp lệ!');
    return;
  }
  
  // Kiểm tra kích thước file (tối đa 2MB)
  if (file.size > 2 * 1024 * 1024) {
    alert('Kích thước ảnh tối đa là 2MB!');
    return;
  }
  
  // Read file and convert to base64
  const reader = new FileReader();
  reader.onload = function(e) {
    const avatarPreview = document.getElementById('profile-avatar-preview');
    if (avatarPreview) {
      avatarPreview.src = e.target.result;
    }
    // Clear URL input when uploading file
    const avatarUrlInput = document.getElementById('profile-avatar-url');
    if (avatarUrlInput) avatarUrlInput.value = '';
  };
  reader.readAsDataURL(file);
}

function removeAvatar() {
  const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
  const defaultAvatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${userData.username || 'default'}`;
  
  const avatarPreview = document.getElementById('profile-avatar-preview');
  const avatarUrlInput = document.getElementById('profile-avatar-url');
  const avatarUpload = document.getElementById('avatar-upload');
  
  if (avatarPreview) avatarPreview.src = defaultAvatar;
  if (avatarUrlInput) avatarUrlInput.value = '';
  if (avatarUpload) avatarUpload.value = '';
}

function updateAvatarPreview() {
  const avatarUrlInput = document.getElementById('profile-avatar-url');
  const avatarPreview = document.getElementById('profile-avatar-preview');
  
  if (avatarUrlInput && avatarPreview && avatarUrlInput.value.trim()) {
    avatarPreview.src = avatarUrlInput.value.trim();
  }
}

function closeProfileModal() {
  const backdrop = document.getElementById('profile-modal-backdrop');
  if (backdrop) {
    backdrop.classList.remove('show');
  }
}

async function saveProfile() {
  const nameInput = document.getElementById('profile-name');
  const usernameInput = document.getElementById('profile-username');
  const avatarPreview = document.getElementById('profile-avatar-preview');
  
  if (nameInput && usernameInput) {
    const displayName = nameInput.value.trim();
    const newUsername = usernameInput.value.trim();
    
    // Validation
    if (!displayName) {
      flashNotice && flashNotice('Vui lòng nhập tên hiển thị!', 'error');
      return;
    }
    
    if (!newUsername) {
      flashNotice && flashNotice('Vui lòng nhập tên người dùng!', 'error');
      return;
    }
    
    // Validate username format (chỉ cho phép chữ cái, số, dấu gạch dưới, gạch ngang)
    if (!/^[a-zA-Z0-9_-]+$/.test(newUsername)) {
      flashNotice && flashNotice('Tên người dùng chỉ được chứa chữ cái, số, _ và -', 'error');
      return;
    }
    
    // Get current user data
    const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
    const oldUsername = userData.username;
    
    // If username changed, check if it's available
    if (newUsername !== oldUsername) {
      try {
        const response = await fetch(`/api/check-username?username=${encodeURIComponent(newUsername)}`);
        const data = await response.json();
        
        if (!data.available) {
          flashNotice && flashNotice('Tên người dùng đã được sử dụng! Vui lòng chọn tên khác.', 'error');
          return;
        }
      } catch (error) {
        console.error('Error checking username:', error);
        flashNotice && flashNotice('Lỗi khi kiểm tra tên người dùng', 'error');
        return;
      }
    }
    
    // Get avatar from preview (could be base64 or URL)
    const avatar = avatarPreview?.src || `https://api.dicebear.com/7.x/avataaars/svg?seed=${newUsername}`;
    
    // Save to localStorage
    userData.displayName = displayName;
    userData.username = newUsername;
    userData.avatar = avatar;
    localStorage.setItem('jaremis_user', JSON.stringify(userData));
    
    // Update UI
    updateAccountUI();
    closeProfileModal();
    
    flashNotice && flashNotice('✅ Đã lưu hồ sơ thành công!', 'success');
  }
}

function updateAccountUI() {
  const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
  const displayName = userData.displayName || userData.username || 'Guest User';
  const username = userData.username || 'guest';
  const avatarUrl = userData.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${username}`;
  
  const accountName = document.getElementById('account-name');
  const userAvatar = document.getElementById('user-avatar');
  
  if (accountName) accountName.textContent = displayName;
  if (userAvatar) userAvatar.src = avatarUrl;
}

function logout() {
  if (confirm('Bạn có chắc muốn đăng xuất?')) {
    localStorage.removeItem('jaremis_user');
    localStorage.removeItem('jaremis_token');
    updateAccountUI();
    currentMode = 'chat';
    updateModeButton();
    updateAccountRole();
  }
}

// ==== PROFESSIONAL MODE - PATIENT RECORDS ====
async function showProfessionalHistory() {
  // Show medical records modal
  showMedicalRecordsModal();
}

async function showMedicalRecordsModal() {
  const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
  const doctorId = userData.username;
  
  if (!doctorId) {
    alert('Vui lòng đăng nhập để xem hồ sơ bệnh nhân');
    return;
  }
  
  // Create modal backdrop
  let backdrop = document.getElementById('medical-records-backdrop');
  if (!backdrop) {
    backdrop = document.createElement('div');
    backdrop.id = 'medical-records-backdrop';
    backdrop.className = 'mode-menu-backdrop';
    backdrop.innerHTML = `
      <div class="mode-menu" style="max-width: 900px; max-height: 85vh;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">📋 Hồ sơ bệnh nhân</h3>
          <button onclick="closeMedicalRecordsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color);">×</button>
        </div>
        <div id="medical-records-content" style="overflow-y: auto; max-height: calc(85vh - 80px);">
          <div style="text-align: center; padding: 20px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
            <p>Đang tải hồ sơ...</p>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(backdrop);
    
    backdrop.addEventListener('click', (e) => {
      if (e.target.id === 'medical-records-backdrop') {
        closeMedicalRecordsModal();
      }
    });
  }
  
  backdrop.classList.add('show');
  
  // Fetch patient records
  try {
    const response = await fetch(`/api/patient-records?doctor=${encodeURIComponent(doctorId)}`);
    const data = await response.json();
    
    const content = document.getElementById('medical-records-content');
    
    if (!data.success || data.records.length === 0) {
      content.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-secondary-color);">
          <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 16px;"></i>
          <p>Chưa có hồ sơ bệnh nhân nào</p>
        </div>
      `;
    } else {
      content.innerHTML = `
        <div style="display: grid; gap: 12px;">
          ${data.records.map(record => `
            <div class="record-card" style="background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" 
                 onclick="viewPatientRecord('${record.patientId}')"
                 onmouseenter="this.style.borderColor='var(--accent-color)'; this.style.background='#2c313a'"
                 onmouseleave="this.style.borderColor='var(--border-color)'; this.style.background='var(--input-bg)'">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                  <div style="font-weight: 600; font-size: 16px; color: var(--text-color); margin-bottom: 4px;">
                    <i class="fas fa-user-injured"></i> ${escapeHtml(record.patientName || record.patientId)}
                  </div>
                  <div style="font-size: 12px; color: var(--text-secondary-color);">
                    Mã BN: ${record.patientId}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="background: var(--accent-color); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                    ${record.totalVisits} lần khám
                  </div>
                </div>
              </div>
              ${record.latestVisit ? `
                <div style="font-size: 13px; color: var(--text-secondary-color); margin-bottom: 8px;">
                  <i class="fas fa-clock"></i> Lần cuối: ${new Date(record.latestVisit.consultationDate).toLocaleDateString('vi-VN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})}
                </div>
                <div style="font-size: 13px; color: var(--text-color); background: var(--chat-bg); padding: 8px; border-radius: 4px; border-left: 3px solid var(--accent-color);">
                  ${escapeHtml(record.latestVisit.chiefComplaint || 'Không có thông tin')}
                </div>
              ` : ''}
              <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="event.stopPropagation(); viewMedicalReport('${record.patientId}')" 
                        style="flex: 1; min-width: 140px; padding: 8px; background: var(--success-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                  <i class="fas fa-file-medical"></i> Xem giấy khám
                </button>
                <button onclick="event.stopPropagation(); downloadMedicalReportPDF('${record.patientId}')" 
                        style="flex: 1; min-width: 120px; padding: 8px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                  <i class="fas fa-file-pdf"></i> Xuất PDF
                </button>
                <button onclick="event.stopPropagation(); downloadMedicalReportWord('${record.patientId}')" 
                        style="flex: 1; min-width: 120px; padding: 8px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                  <i class="fas fa-file-word"></i> Xuất Word
                </button>
                <button onclick="event.stopPropagation(); editPatientProfile('${record.patientId}')" 
                        style="flex: 1; min-width: 140px; padding: 8px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                  <i class="fas fa-edit"></i> Chỉnh sửa hồ sơ
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
  } catch (error) {
    console.error('Error fetching patient records:', error);
    document.getElementById('medical-records-content').innerHTML = `
      <div style="text-align: center; padding: 40px; color: var(--error-color);">
        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
        <p>Lỗi khi tải hồ sơ bệnh nhân</p>
        <p style="font-size: 14px;">${error.message}</p>
      </div>
    `;
  }
}

function closeMedicalRecordsModal() {
  const backdrop = document.getElementById('medical-records-backdrop');
  if (backdrop) {
    backdrop.classList.remove('show');
  }
}

async function viewPatientRecord(patientId) {
  const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
  const doctorId = userData.username;
  
  try {
    const response = await fetch(`/api/patient-record/${patientId}?doctor=${encodeURIComponent(doctorId)}`);
    const data = await response.json();
    
    if (!data.success) {
      alert('Lỗi: ' + data.error);
      return;
    }
    
    // Show detailed record modal
    showPatientRecordDetail(data.record);
  } catch (error) {
    console.error('Error fetching patient record:', error);
    alert('Lỗi khi tải hồ sơ chi tiết');
  }
}

function showPatientRecordDetail(record) {
  let detailBackdrop = document.getElementById('patient-detail-backdrop');
  if (!detailBackdrop) {
    detailBackdrop = document.createElement('div');
    detailBackdrop.id = 'patient-detail-backdrop';
    detailBackdrop.className = 'mode-menu-backdrop';
    document.body.appendChild(detailBackdrop);
    
    detailBackdrop.addEventListener('click', (e) => {
      if (e.target.id === 'patient-detail-backdrop') {
        detailBackdrop.classList.remove('show');
      }
    });
  }
  
  const sortedConsultations = [...record.consultations].sort((a, b) => 
    new Date(b.consultationDate) - new Date(a.consultationDate)
  );
  
  detailBackdrop.innerHTML = `
    <div class="mode-menu" style="max-width: 1000px; max-height: 90vh;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">📋 Chi tiết hồ sơ: ${escapeHtml(record.patientName || record.patientId)}</h3>
        <button onclick="document.getElementById('patient-detail-backdrop').classList.remove('show')" 
                style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color);">×</button>
      </div>
      <div style="overflow-y: auto; max-height: calc(90vh - 80px);">
        <div style="background: var(--input-bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <h4 style="margin: 0 0 12px 0;">Thông tin chung</h4>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
            <div><strong>Mã bệnh nhân:</strong> ${record.patientId}</div>
            <div><strong>Tổng số lần khám:</strong> ${record.totalVisits}</div>
            <div><strong>Ngày tạo hồ sơ:</strong> ${new Date(record.createdAt).toLocaleDateString('vi-VN')}</div>
            <div><strong>Cập nhật cuối:</strong> ${new Date(record.lastUpdatedAt).toLocaleDateString('vi-VN')}</div>
          </div>
        </div>
        
        <h4 style="margin: 20px 0 12px 0;">Lịch sử khám bệnh (${sortedConsultations.length} lần)</h4>
        ${sortedConsultations.map((visit, index) => {
          try {
            return `
              <div style="background: var(--input-bg); padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid var(--accent-color);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                  <strong style="color: var(--accent-color);">Lần ${sortedConsultations.length - index} - ${new Date(visit.consultationDate).toLocaleDateString('vi-VN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'})}</strong>
                  <span style="font-size: 12px; color: var(--text-secondary-color);">BS. ${escapeHtml(visit.doctor || 'N/A')}</span>
                </div>
                <div style="margin-bottom: 8px;">
                  <strong>Lý do khám:</strong>
                  <div style="margin-top: 4px; padding: 8px; background: var(--chat-bg); border-radius: 4px; font-size: 13px;">
                    ${escapeHtml(visit.chiefComplaint || visit.symptoms || 'N/A')}
                  </div>
                </div>
                ${visit.imageCount > 0 ? `
                  <div style="margin-bottom: 8px; padding: 8px; background: #e7f3ff; border-radius: 4px; color: #003666;">
                    <i class="fas fa-images"></i> <strong>${visit.imageCount} hình ảnh y khoa đính kèm</strong>
                  </div>
                ` : ''}
                ${(() => {
                  try {
                    let meds = visit.prescribedMedications;
                    if (typeof meds === 'string') {
                      meds = JSON.parse(meds);
                    }
                    if (meds && Array.isArray(meds) && meds.length > 0) {
                      return `
                        <div style="margin-top: 12px;">
                          <strong>💊 Đơn thuốc:</strong>
                          <ul style="margin: 8px 0; padding-left: 20px;">
                            ${meds.map(med => `
                              <li style="margin-bottom: 4px;">
                                ${escapeHtml(med.name || 'N/A')} - ${escapeHtml(med.dosage || 'N/A')} 
                                ${med.instructions ? `<br><span style="font-size: 12px; color: var(--text-secondary-color);">${escapeHtml(med.instructions)}</span>` : ''}
                              </li>
                            `).join('')}
                          </ul>
                        </div>
                      `;
                    }
                    return '';
                  } catch (e) {
                    console.warn('Error parsing prescribedMedications:', e);
                    return '';
                  }
                })()}
                <div style="margin-top: 12px; font-size: 12px; color: var(--text-secondary-color);">
                  Phân tích bởi: ${escapeHtml(visit.modelUsed || 'JAREMIS')}
                </div>
              </div>
            `;
          } catch (e) {
            console.error('Error rendering visit:', e);
            return `<div style="padding: 12px; background: rgba(255,0,0,0.1); border-radius: 4px; margin-bottom: 8px;">Lỗi hiển thị lần khám này</div>`;
          }
        }).join('')}
      </div>
    </div>
  `;
  
  detailBackdrop.classList.add('show');
}

function viewMedicalReport(patientId) {
  const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
  const doctorId = userData.username;
  
  // Open medical report in new window with export buttons
  const url = `/api/patient-record/${patientId}/medical-report?doctor=${encodeURIComponent(doctorId)}`;
  const reportWindow = window.open(url, '_blank', 'width=1000,height=900,scrollbars=yes');
  
  // Add export buttons when window loads
  if (reportWindow) {
    reportWindow.addEventListener('load', () => {
      addExportButtons(reportWindow, patientId, doctorId);
    });
  }
}

function addExportButtons(reportWindow, patientId, doctorId) {
  try {
    const doc = reportWindow.document;
    const body = doc.querySelector('.medical-certificate') || doc.body;
    
    // Create floating action buttons
    const buttonContainer = doc.createElement('div');
    buttonContainer.innerHTML = `
      <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; gap: 10px; flex-direction: column; print:hidden;">
        <button onclick="window.print()" 
                style="padding: 12px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-print"></i> In
        </button>
        <button onclick="exportToPDF()" 
                style="padding: 12px 20px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-file-pdf"></i> Xuất PDF
        </button>
        <button onclick="downloadAsWord('${patientId}', '${doctorId}')" 
                style="padding: 12px 20px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-file-word"></i> Xuất Word
        </button>
        <button onclick="editMedicalReport()" 
                style="padding: 12px 20px; background: #FF9800; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;">
          <i class="fas fa-edit"></i> Chỉnh sửa
        </button>
      </div>
    `;
    body.insertBefore(buttonContainer, body.firstChild);
    
    // Add html2pdf library if not already loaded
    if (!reportWindow.html2pdf) {
      const script = doc.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      doc.head.appendChild(script);
    }
    
    // Add PDF export function
    reportWindow.exportToPDF = function() {
      const element = doc.querySelector('.medical-certificate');
      const opt = {
        margin: [10, 10, 10, 10],
        filename: 'GiayKhamBenh_' + patientId + '_' + new Date().getTime() + '.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          useCORS: true,
          letterRendering: true,
          scrollY: 0,
          scrollX: 0
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait',
          compress: true
        },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };
      
      // Ẩn các nút trước khi xuất
      const buttons = doc.querySelector('[style*="position: fixed"]');
      if (buttons) buttons.style.display = 'none';
      
      html2pdf().set(opt).from(element).save().then(() => {
        if (buttons) buttons.style.display = 'flex';
      }).catch(err => {
        console.error('Error exporting PDF:', err);
        if (buttons) buttons.style.display = 'flex';
        alert('Lỗi khi xuất PDF. Vui lòng thử lại.');
      });
    };
    
    // Thêm hàm download vào window
    reportWindow.downloadAsWord = async function(patientId, doctorId) {
      try {
        const response = await fetch('/api/patient-record/' + patientId + '/export-word?doctor=' + encodeURIComponent(doctorId));
        if (!response.ok) throw new Error('Export failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'GiayKhamBenh_' + patientId + '_' + new Date().getTime() + '.doc';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (error) {
        alert('Lỗi khi xuất file Word: ' + error.message);
      }
    };
    
    // Thêm hàm chỉnh sửa
    reportWindow.editMedicalReport = function() {
      const editable = doc.querySelectorAll('.info-value, .subsection, .bullet-item, .editable-field');
      const editBtn = doc.querySelector('button[onclick="editMedicalReport()"]');
      
      if (editBtn.textContent.includes('Chỉnh sửa')) {
        // Bật chế độ chỉnh sửa
        editable.forEach(el => {
          el.contentEditable = true;
          el.style.backgroundColor = '#fffacd';
          el.style.padding = '4px';
          el.style.border = '1px dashed #999';
        });
        
        // Bật các trường có thể chỉnh sửa
        if (typeof reportWindow.enableEditMode === 'function') {
          reportWindow.enableEditMode();
        }
        
        editBtn.innerHTML = '<i class="fas fa-save"></i> Lưu';
        editBtn.style.background = '#4CAF50';
      } else {
        // Lưu thay đổi
        editable.forEach(el => {
          el.contentEditable = false;
          el.style.backgroundColor = '';
          el.style.padding = '';
          el.style.border = '';
        });
        
        // Tắt các trường có thể chỉnh sửa
        if (typeof reportWindow.disableEditMode === 'function') {
          reportWindow.disableEditMode();
        }
        
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Chỉnh sửa';
        editBtn.style.background = '#FF9800';
        alert('Đã lưu thay đổi! (Chỉ áp dụng cho phiên hiện tại)');
      }
    };
  } catch (error) {
    console.error('Error adding export buttons:', error);
  }
}

function downloadMedicalReportPDF(patientId) {
  const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
  const doctorId = userData.username;
  
  // Open print dialog
  const url = `/api/patient-record/${patientId}/medical-report?doctor=${encodeURIComponent(doctorId)}`;
  const printWindow = window.open(url, '_blank');
  
  if (printWindow) {
    printWindow.addEventListener('load', () => {
      setTimeout(() => {
        printWindow.print();
      }, 500);
    });
  }
}

async function downloadMedicalReportWord(patientId) {
  const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
  const doctorId = userData.username;
  
  try {
    const response = await fetch(`/api/patient-record/${patientId}/export-word?doctor=${encodeURIComponent(doctorId)}`);
    if (!response.ok) throw new Error('Export failed');
    
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `GiayKhamBenh_${patientId}_${new Date().getTime()}.doc`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  } catch (error) {
    alert('Lỗi khi xuất file Word: ' + error.message);
  }
}


async function editPatientProfile(patientId) {
  const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
  const doctorId = userData.username;
  
  try {
    const response = await fetch(`/api/patient-record/${patientId}?doctor=${encodeURIComponent(doctorId)}`);
    const data = await response.json();
    
    if (!data.success) {
      alert('Lỗi: ' + data.error);
      return;
    }
    
    const record = data.record;
    const latestVisit = record.consultations[record.consultations.length - 1];
    const patientInfo = latestVisit.patientInfo || {};
    
    // Show edit modal
    showPatientProfileEditModal(record, patientInfo);
  } catch (error) {
    console.error('Error:', error);
    alert('Lỗi khi tải thông tin bệnh nhân');
  }
}

function showPatientProfileEditModal(record, patientInfo) {
  let editBackdrop = document.getElementById('edit-profile-backdrop');
  if (!editBackdrop) {
    editBackdrop = document.createElement('div');
    editBackdrop.id = 'edit-profile-backdrop';
    editBackdrop.className = 'mode-menu-backdrop';
    document.body.appendChild(editBackdrop);
    
    editBackdrop.addEventListener('click', (e) => {
      if (e.target.id === 'edit-profile-backdrop') {
        editBackdrop.classList.remove('show');
      }
    });
  }
  
  editBackdrop.innerHTML = `
    <div class="mode-menu" style="max-width: 600px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">✏️ Chỉnh sửa hồ sơ bệnh nhân</h3>
        <button onclick="document.getElementById('edit-profile-backdrop').classList.remove('show')" 
                style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color);">×</button>
      </div>
      <form id="edit-patient-form" onsubmit="savePatientProfile(event, '${record.patientId}')">
        <div style="display: grid; gap: 16px;">
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 600;">Họ và tên:</label>
            <input type="text" name="name" value="${escapeHtml(patientInfo.name || '')}" 
                   style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Tuổi:</label>
              <input type="number" name="age" value="${patientInfo.age || ''}" 
                     style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Giới tính:</label>
              <select name="gender" style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
                <option value="">--Chọn--</option>
                <option value="Nam" ${patientInfo.gender === 'Nam' ? 'selected' : ''}>Nam</option>
                <option value="Nữ" ${patientInfo.gender === 'Nữ' ? 'selected' : ''}>Nữ</option>
                <option value="Khác" ${patientInfo.gender === 'Khác' ? 'selected' : ''}>Khác</option>
              </select>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Cân nặng (kg):</label>
              <input type="number" step="0.1" name="weight" value="${patientInfo.weight || ''}" 
                     style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px; font-weight: 600;">Chiều cao (cm):</label>
              <input type="number" step="0.1" name="height" value="${patientInfo.height || ''}" 
                     style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
            </div>
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 600;">Huyết áp:</label>
            <input type="text" name="bloodPressure" value="${patientInfo.bloodPressure || ''}" placeholder="Ví dụ: 120/80" 
                   style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color);">
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 600;">Tiền sử bệnh:</label>
            <textarea name="medicalHistory" rows="3" 
                      style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); resize: vertical;">${patientInfo.medicalHistory || ''}</textarea>
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; font-weight: 600;">Dị ứng:</label>
            <textarea name="allergies" rows="2" 
                      style="width: 100%; padding: 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); resize: vertical;">${patientInfo.allergies || ''}</textarea>
          </div>
        </div>
        <div style="margin-top: 24px; display: flex; gap: 12px;">
          <button type="submit" style="flex: 1; padding: 12px; background: var(--success-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            <i class="fas fa-save"></i> Lưu thay đổi
          </button>
          <button type="button" onclick="document.getElementById('edit-profile-backdrop').classList.remove('show')" 
                  style="flex: 1; padding: 12px; background: var(--border-color); color: var(--text-color); border: none; border-radius: 6px; cursor: pointer;">
            Hủy
          </button>
        </div>
      </form>
    </div>
  `;
  
  editBackdrop.classList.add('show');
}

async function savePatientProfile(event, patientId) {
  event.preventDefault();
  
  const form = event.target;
  const formData = new FormData(form);
  
  const patientInfo = {
    name: formData.get('name'),
    age: formData.get('age') ? parseInt(formData.get('age')) : null,
    gender: formData.get('gender'),
    weight: formData.get('weight') ? parseFloat(formData.get('weight')) : null,
    height: formData.get('height') ? parseFloat(formData.get('height')) : null,
    bloodPressure: formData.get('bloodPressure'),
    medicalHistory: formData.get('medicalHistory'),
    allergies: formData.get('allergies')
  };
  
  const userData = JSON.parse(localStorage.getItem('jaremis_user') || '{}');
  const doctorId = userData.username;
  
  try {
    const response = await fetch(`/api/patient-record/${patientId}/profile`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        doctor: doctorId,
        patientInfo
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('✅ Cập nhật hồ sơ thành công!');
      document.getElementById('edit-profile-backdrop').classList.remove('show');
      // Refresh records list
      showMedicalRecordsModal();
    } else {
      alert('❌ Lỗi: ' + data.error);
    }
  } catch (error) {
    console.error('Error saving profile:', error);
    alert('❌ Lỗi khi lưu hồ sơ');
  }
}

// Khởi tạo khi tải
document.addEventListener('DOMContentLoaded', () => {
  updateAccountUI();
  updateModeButton();
  updateAccountRole();
});

// Đóng menu chế độ khi click backdrop
document.getElementById('mode-menu-backdrop')?.addEventListener('click', (e) => {
  if (e.target.id === 'mode-menu-backdrop') {
    closeModeMenu();
  }
});

// Đóng modal hồ sơ khi click backdrop
document.getElementById('profile-modal-backdrop')?.addEventListener('click', (e) => {
  if (e.target.id === 'profile-modal-backdrop') {
    closeProfileModal();
  }
});

</script>

<!-- Mode Selection Menu -->
<div class="mode-menu-backdrop" id="mode-menu-backdrop">
  <div class="mode-menu">
    <h3>Chọn chế độ hoạt động</h3>
    <div class="mode-options">
      <div class="mode-option" data-mode="chat" onclick="selectMode('chat')">
        <div class="mode-icon">
          <i class="fas fa-comments"></i>
        </div>
        <div class="mode-info">
          <div class="mode-title">Chat</div>
          <div class="mode-desc">Trò chuyện thông thường, hỏi đáp chung</div>
        </div>
        <div class="mode-check">
          <i class="fas fa-check"></i>
        </div>
      </div>
      
      <div class="mode-option" data-mode="diagnose" onclick="selectMode('diagnose')">
        <div class="mode-icon">
          <i class="fas fa-stethoscope"></i>
        </div>
        <div class="mode-info">
          <div class="mode-title">Diagnose</div>
          <div class="mode-desc">Chẩn đoán y khoa cơ bản, phân tích triệu chứng</div>
        </div>
        <div class="mode-check">
          <i class="fas fa-check"></i>
        </div>
      </div>
      
      <div class="mode-option" data-mode="professional" onclick="selectMode('professional')">
        <div class="mode-icon">
          <i class="fas fa-user-md"></i>
        </div>
        <div class="mode-info">
          <div class="mode-title">Professional</div>
          <div class="mode-desc">Dành cho bác sĩ: phân tích ảnh y tế, gợi ý thuốc, quản lý hồ sơ bệnh nhân</div>
        </div>
        <div class="mode-check">
          <i class="fas fa-check"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Đóng modal backdrop khi click -->
<script>
// Đóng modal thông tin bệnh nhân khi click backdrop
document.getElementById('patient-info-modal-backdrop')?.addEventListener('click', (e) => {
  if (e.target.id === 'patient-info-modal-backdrop') {
    closePatientInfoModal();
  }
});
</script>

</body>
</html>