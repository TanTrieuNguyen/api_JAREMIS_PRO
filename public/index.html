<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JAREMIS - AI Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 260px;
            --bg-color: #0d1117;
            --sidebar-bg: #161b22;
            --chat-bg: #010409;
            --input-bg: #161b22;
            --bot-bubble-bg: #161b22;
            --user-bubble-bg: #003666;
            --text-color: #c9d1d9;
            --text-secondary-color: #8b949e;
            --border-color: #30363d;
            --accent-color: #2f81f7;
            --error-color: #f85149;
            --success-color: #238636;
            --who-bg: #212013;
            --mic-red: #ff4d4d;

            --auth-offset-top: 12px;
            --auth-offset-height: 48px; /* chiều cao ước lượng vùng auth (để chừa khoảng trống) */
            --mobile-header-height: 56px; /* chiều cao header mobile (nếu hiện) */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container { display: flex; width: 100%; height: 100%; }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 200px;
            max-width: 500px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 16px;
            transition: width 0.1s ease-out;
            flex-shrink: 0;
        }
        .resizer { width: 5px; cursor: col-resize; background-color: transparent; flex-shrink: 0; position: relative; z-index: 10; }
        .resizer:hover { background-color: var(--accent-color); }

        .sidebar-header {
          display:flex;
          flex-direction:column;
          align-items:stretch;
          gap:8px;
          margin-bottom:12px;
        }

        .new-chat-btn {
            display:flex; align-items:center; gap:8px; width:100%; padding:10px; background:transparent; color:var(--text-color);
            border:1px solid var(--border-color); border-radius:6px; font-size:14px; cursor:pointer;
        }
        .new-chat-btn:hover { background-color:#2c313a; }

        .history { flex-grow:1; overflow-y:auto; margin-top:10px; }
        .history h3 { font-size:12px; color:var(--text-secondary-color); margin-bottom:8px; text-transform:uppercase; display:flex; justify-content:space-between; align-items:center; }
        .history ul { list-style:none; padding:0; display:flex; flex-direction:column; gap:6px; }
        .history li { padding:8px; border-radius:6px; cursor:pointer; color:var(--text-color); background:transparent; border:1px solid transparent; font-size:13px; }
        .history li:hover { background:#111720; border-color:var(--border-color); }
        .sidebar-footer { font-size:12px; color:var(--text-secondary-color); text-align:center; margin-top:10px; }

        /* Chat area */
        .chat-area {
            position: relative; /* Đảm bảo lớp nền phủ đúng */
            flex-grow:1; display:flex; flex-direction:column; background-color:var(--chat-bg); border-left:1px solid var(--border-color); /* position:relative; */
        }
        .chat-messages {
          flex-grow:1;
          padding:24px;
          overflow-y:auto;
          display:flex;
          flex-direction:column;
          gap:20px;
          background: transparent;          /* đảm bảo không che nền */
          scrollbar-color: var(--accent-color) transparent; /* Firefox */
          scrollbar-width: thin;
        }

        /* Scrollbar WebKit (Chrome / Edge) */
        .chat-messages::-webkit-scrollbar {
          width: 10px;
        }
        .chat-messages::-webkit-scrollbar-track {
          background: transparent;          /* trong suốt để lộ nền & canvas tuyết */
        }
        .chat-messages::-webkit-scrollbar-thumb {
          background: linear-gradient(180deg, rgba(47,129,247,0.55), rgba(47,129,247,0.25));
          border-radius: 20px;
          border: 2px solid rgba(0,0,0,0);  /* tạo khoảng cách thị giác */
          min-height: 40px;
          transition: background .25s;
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(180deg, rgba(47,129,247,0.85), rgba(47,129,247,0.45));
        }
        .chat-messages::-webkit-scrollbar-corner {
          background: transparent;
        }
        /* (Tuỳ chọn) Ẩn hẳn khi không hover:
        .chat-messages::-webkit-scrollbar { width: 0; }
        */

        .chat-bubble { max-width:80%; padding:16px; border-radius:12px; line-height:1.6; word-wrap:break-word; }
        .bot-bubble { background-color:var(--bot-bubble-bg); align-self:flex-start; border:1px solid var(--border-color); }
        .user-bubble { background-color:var(--user-bubble-bg); align-self:flex-end; color:#fff; }

        .user-bubble-content p { margin-bottom:12px; }
        .user-images-preview { display:flex; gap:10px; flex-wrap:wrap; }
        .user-images-preview img { width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid var(--border-color); }

        .chat-input-area { padding:16px 24px; border-top:1px solid var(--border-color); display:flex; flex-direction:column; gap:8px; }
        .input-wrapper { position:relative; display:flex; align-items:center; background-color:var(--input-bg); border:1px solid var(--border-color); border-radius:8px; padding:8px; gap:8px; }

        #chat-input { flex-grow:1; background:transparent; border:none; color:var(--text-color); font-size:16px; padding:8px; resize:none; max-height:200px; overflow-y:auto; }
        #chat-input:focus { outline:none; }

        .input-actions { display:flex; align-items:center; gap:8px; }
        .action-btn {
            background:none; border:none; color:var(--text-secondary-color); font-size:20px; cursor:pointer; width:40px; height:40px; border-radius:6px;
            display:flex; align-items:center; justify-content:center;
        }
        .action-btn:hover { background-color:#2c313a; color:var(--text-color); }
        #send-btn { background-color:var(--accent-color); color:white; border-radius:6px; width:44px; height:40px; display:flex; align-items:center; justify-content:center; }
        #send-btn:disabled { background-color:#30363d; cursor:not-allowed; }

        #image-preview-container { display:flex; gap:10px; margin-top:10px; padding:0 8px; }
        .preview-item { position:relative; }
        .preview-item img { width:60px; height:60px; object-fit:cover; border-radius:6px; }
        .remove-btn { position:absolute; top:-5px; right:-5px; background:var(--error-color); color:white; border:none; width:20px; height:20px; border-radius:50%; cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center; }

        /* Analysis steps */
        .analysis-steps { display:flex; flex-direction:column; gap:12px; }
        .step-item { display:flex; align-items:center; gap:12px; font-size:14px; transition:color 0.3s ease; }
        .step-item .icon { width:20px; text-align:center; }
        .step-item.pending { color:var(--text-secondary-color); }
        .step-item.active { color:var(--text-color); font-weight:600; }
        .step-item.completed { color:var(--success-color); }
        .fa-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }

        /* Result */
        .error-message { color:var(--error-color); }
        .confidence-meter { background:#2c313a; border-radius:20px; height:24px; margin:16px 0; overflow:hidden; position:relative; }
        .confidence-bar { background:var(--success-color); height:100%; display:flex; align-items:center; padding-left:12px; color:white; font-weight:bold; font-size:12px; transition: width 0.5s ease; }

        .disease-list { margin:20px 0; display:flex; flex-direction:column; gap:15px; }
        .disease-item { border-left:3px solid var(--accent-color); padding-left:15px; }
        .probability-bar { height:8px; background:#30363d; border-radius:10px; overflow:hidden; margin-top:8px; }
        .probability-fill { height:100%; background:var(--accent-color); transition:width 0.5s ease; }

        .diagnosis-details h2, .diagnosis-details h3 { border-bottom:1px solid var(--border-color); padding-bottom:8px; margin:20px 0 10px 0; font-size:1.1em; }
        .references-section { margin-top:25px; padding:15px; background:rgba(47,129,247,0.1); border-radius:8px; }
        .reference-item { margin-top:10px; }
        .reference-item a { color:var(--accent-color); text-decoration:none; }
        .reference-item a:hover { text-decoration:underline; }
        .reference-source { font-size:0.8em; color:var(--text-secondary-color); margin-top:4px; }

        .warning { margin-top:20px; padding:12px; background:var(--who-bg); border-left:4px solid #f1e05a; color:#d4c873; font-size:14px; border-radius:4px; }
        .warning strong { color:#f1e05a; }

        /* Think button style */
        #think-btn { background:none; border:1px solid var(--border-color); border-radius:6px; padding:6px 8px; color:var(--text-secondary-color); cursor:pointer; width:auto; height:40px; display:flex; align-items:center; justify-content:center; }
        #think-btn.active { background: linear-gradient(90deg, rgba(47,129,247,0.12), rgba(47,129,247,0.06)); color:var(--text-color); border-color: rgba(47,129,247,0.6); }
        #model-status { font-size:12px; color:var(--text-secondary-color); margin-left:8px; align-self:center; }

        /* Mic button style */
        #mic-btn { background:none; border:1px solid var(--border-color); border-radius:6px; padding:6px 8px; color:var(--text-secondary-color); cursor:pointer; width:auto; height:40px; display:flex; align-items:center; justify-content:center; }
        #mic-btn.recording { background: rgba(255,77,77,0.12); color: var(--text-color); border-color: rgba(255,77,77,0.5); box-shadow: 0 0 8px rgba(255,77,77,0.12); }
        #mic-indicator {
            width:8px; height:8px; border-radius:50%; background:var(--mic-red); margin-left:6px; display:inline-block; opacity:0;
            box-shadow: 0 0 6px rgba(255,77,77,0.8);
            animation: pulse 1.2s infinite;
        }
        #mic-btn.recording #mic-indicator { opacity:1; }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        /* Auth UI (top-right) */
        .auth-controls {
            position: fixed !important;
            top: var(--auth-offset-top) !important;
            right: 18px !important;
            bottom: auto !important;
            display: flex;
            gap: 8px;
            align-items: center;
            z-index: 120; /* cao hơn header & bong bóng */
            flex-direction: row !important;
        }
        @media (max-width:600px) {
            .auth-controls { right: 10px; }
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .modal {
            background: #0b1116;
            border: 1px solid var(--border-color);
            padding: 18px;
            border-radius: 10px;
            width: 360px;
            max-width: 92%;
            color: var(--text-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .modal h3 { margin-bottom: 10px; font-size: 18px; }
        .tabs { display:flex; gap:8px; margin-bottom:12px; }
        .tab { padding:8px 12px; border-radius:6px; cursor:pointer; background:transparent; color:var(--text-secondary-color); border:1px solid transparent; }
        .tab.active { background: rgba(47,129,247,0.12); color:var(--text-color); border-color: rgba(47,129,247,0.2); }
        .form-row { margin-bottom:10px; display:flex; flex-direction:column; gap:6px; }
        .form-row input { background: #071018; border: 1px solid var(--border-color); color: var(--text-color); padding:8px 10px; border-radius:6px; }
        .form-actions { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; }
        .btn-primary { background: var(--accent-color); color: #fff; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
        .btn-ghost { background:transparent; color:var(--text-secondary-color); border:1px solid var(--border-color); padding:8px 10px; border-radius:6px; cursor:pointer; }

        .small-muted { font-size:12px; color:var(--text-secondary-color); margin-top:8px; }

        /* Base (desktop) – giữ hàng ngang cho tool buttons */
        .tool-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toggle-tools-btn {
            display: none; /* Chỉ hiện trên mobile */
        }

        /* Auth buttons styling */
        .auth-controls .auth-btn {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            line-height: 1.2;
            backdrop-filter: blur(4px);
            transition: background .18s, border-color .18s, color .18s;
        }
        .auth-controls .auth-btn:hover {
            background: rgba(47,129,247,0.16);
            border-color: var(--accent-color);
            color: #fff;
        }
        .auth-controls .auth-btn:active {
            background: rgba(47,129,247,0.28);
        }

        /* small responsive */
        @media (max-width: 900px) {
            .sidebar { display:none; }
            .resizer { display:none; }
            .auth-controls { right: 8px; top: 8px; }
        }

        /* Mobile-specific overrides */
        @media (max-width: 600px) {
            /* layout becomes column for small screens */
            .chat-container { flex-direction:column; }
            .mobile-header { display:flex; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid var(--border-color); background:var(--chat-bg); position:sticky; top:0; z-index:70; }
            .mobile-header .title { color:var(--text-color); font-weight:600; font-size:16px; flex:1; text-align:center; }
            .hamburger { background:transparent; border:1px solid var(--border-color); color:var(--text-secondary-color); width:44px; height:44px; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; }
            /* Sidebar becomes overlay (hidden by default) */
            .sidebar { display:flex; position:fixed; top:0; left:0; bottom:0; width:78%; max-width:360px; transform:translateX(-120%); transition: transform 0.22s ease; z-index:80; box-shadow:6px 0 30px rgba(0,0,0,0.6); }
            .sidebar.mobile-open { transform:translateX(0); }
            .sidebar-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:75; display:none; }
            .sidebar-backdrop.show { display:block; }
            /* hide resizer (not needed) */
            .resizer { display:none; }
            /* Chat area sizing */
            .chat-area { flex:1 1 auto; min-height: calc(100vh - 56px); }
            .chat-messages { padding: 12px; padding-bottom:160px; overflow-y:auto; }
            /* Fix input to bottom and respect safe-area */
            .chat-input-area { position:fixed; left:0; right:0; bottom:env(safe-area-inset-bottom, 0); padding:8px 10px; background:linear-gradient(180deg, rgba(1,4,9,0.98), rgba(1,4,9,1)); z-index:70; border-top:1px solid var(--border-color); }
            .input-wrapper { padding:6px; gap:6px; }
            #chat-input { font-size:15px; padding:8px; max-height:120px; }
            .input-actions .action-btn { width:40px; height:40px; font-size:16px; }
            #send-btn { width:44px; height:40px; border-radius:8px; }
            /* Adjust auth controls so they don't overlap mobile input */
            .auth-controls { position:fixed; right:10px; bottom:110px; top:auto; z-index:69; display:flex; flex-direction:column; gap:8px; }
            /* Slightly reduce bubble max-width for narrow screens */
            .chat-bubble { max-width:94%; }
        }

        /* Even smaller devices: compact spacing & font sizes */
        @media (max-width: 420px) {
            .mobile-header { padding:6px 8px; }
            .mobile-header .title { font-size:14px; }
            .new-chat-btn span { display:none; } /* icon only to save space */
            .sidebar { width:84%; max-width:300px; }
            .chat-messages { padding:10px; padding-bottom:150px; gap:12px; }
            .input-actions .action-btn { width:38px; height:38px; font-size:15px; }
            #chat-input { font-size:14px; }
        }

        @media (max-width: 360px) {
            .mobile-header .title { font-size:13px; }
            .hamburger { width:40px; height:40px; }
            .auth-controls { right:8px; bottom:120px; }
            .chat-input-area { padding:8px; }
            .chat-messages { padding-bottom:140px; }
        }

        /* Compact tools (mobile) */
        @media (max-width:600px) {
            .input-wrapper {
                position: relative;
            }
            .toggle-tools-btn {
                display:flex !important;
            }
            .tool-buttons {
                display:flex;
                align-items:center;
                gap:6px;
                transition:opacity .18s ease, transform .18s ease;
            }
            .tool-buttons.collapsed {
                opacity:0;
                pointer-events:none;
                transform:translateY(4px);
                position:absolute;
                left:8px;
                right:60px;
                bottom:100%;
                /* hidden */
            }
            .mobile-tools-active .tool-buttons {
                opacity:1;
                transform:translateY(0);
                position:absolute;
                left:8px;
                right:60px;
                bottom:100%;
                background:rgba(22,27,34,0.95);
                padding:6px 8px;
                border:1px solid var(--border-color);
                border-radius:10px;
                box-shadow:0 4px 18px rgba(0,0,0,0.55);
                z-index:90;
            }
            .tool-buttons .action-btn {
                width:38px;
                height:38px;
                font-size:16px;
            }
            .toggle-tools-btn {
                display:flex;
                background:none;
                border:1px solid var(--border-color);
                width:40px;
                height:40px;
                border-radius:8px;
                align-items:center;
                justify-content:center;
                color:var(--text-secondary-color);
                cursor:pointer;
            }
            .toggle-tools-btn.active {
                background:rgba(47,129,247,0.15);
                color:var(--text-color);
                border-color:var(--accent-color);
            }
            /* Khi bàn phím mở (class keyboard-open gắn vào body) -> ép thu gọn */
            body.keyboard-open .tool-buttons:not(.force-open) {
                opacity:0;
                pointer-events:none;
                transform:translateY(4px);
            }
        }

        /* Nút toggle lịch sử trên mobile */
        #history-toggle-btn {
            display:none;
            background:transparent;
            border:1px solid var(--border-color);
            color:var(--text-secondary-color);
            padding:6px 10px;
            border-radius:8px;
            font-size:13px;
            cursor:pointer;
        }
        #history-toggle-btn.active {
            background:rgba(47,129,247,0.15);
            color:var(--text-color);
            border-color:var(--accent-color);
        }
        @media (max-width:600px) {
          #history-toggle-btn { display:inline-flex; align-items:center; gap:6px; }
        }

        /* Dual pane (landscape + đủ rộng) */
        @media (max-width:900px) and (orientation:landscape) and (min-width:640px) {
          body.dual-pane .sidebar {
              position:relative;
              transform:translateX(0) !important;
              width:230px;
              box-shadow:none;
          }
          body.dual-pane .sidebar-backdrop { display:none !important; }
          body.dual-pane .chat-area { min-height:100vh; }
          body.dual-pane #mobile-header { padding-right:0; }
          body.dual-pane #history-toggle-btn { display:none; }
        }
        /* Hiệu ứng vuốt (gợi ý) – chỉ chiều ngang */
        .sidebar {
           touch-action: pan-y;
        }

        @media (max-width:600px) {
          .history-drawer-toggle {
              position:fixed;
              top:50%;
              left:4px;
              transform:translateY(-50%);
              z-index:90;
              width:34px;
              height:52px;
              background:rgba(22,27,34,0.88);
              border:1px solid var(--border-color);
              border-left:none;
              border-radius:0 10px 10px 0;
              display:flex;
              align-items:center;
              justify-content:center;
              color:var(--text-secondary-color);
              cursor:pointer;
              backdrop-filter:blur(4px);
              transition:background .18s, color .18s;
          }
          .history-drawer-toggle:hover { background:rgba(47,129,247,0.15); color:var(--text-color); }
          .history-drawer-toggle.open { left: calc(78% - 18px); border-left:1px solid var(--border-color); border-radius:10px 0 0 10px; }
        }

        /* Phóng to nút history ≡ */
.history-top-toggle .history-icon,
.history-drawer-toggle .history-icon {
    font-size: 26px; /* tăng gấp ~2 lần so với font-awesome mặc định 14–16px */
    line-height: 1;
    display:inline-block;
    transform: translateY(-1px);
    letter-spacing:2px;
    font-weight:600;
}
.history-top-toggle,
.history-drawer-toggle {
    width:46px !important;
    height:46px !important;
}

/* Compact white triple bars button */
.history-top-toggle,
.history-drawer-toggle {
    background: var(--chat-bg) !important; /* trùng nền chính */
    border: 1px solid var(--border-color);
    box-shadow: 0 0 0 0 transparent;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
}
.history-top-toggle:hover,
.history-drawer-toggle:hover {
    border-color: var(--accent-color);
    background: var(--chat-bg);
}
.history-top-toggle .bars,
.history-drawer-toggle .bars {
    display:flex;
    flex-direction:column;
    gap:5px;
    width:26px;
    height:22px;
    align-items:flex-start;
    justify-content:center;
}
.history-top-toggle .bar,
.history-drawer-toggle .bar {
    display:block;
    height:2px;              /* thon hơn */
    width:22px;
    background:#fff;          /* màu trắng */
    border-radius:2px;
    transition:width .25s ease, background .25s;
}
.history-top-toggle .bar:nth-child(2),
.history-drawer-toggle .bar:nth-child(2){
    width:18px;               /* giữa ngắn hơn nhẹ */
}
.history-top-toggle .bar:nth-child(3),
.history-drawer-toggle .bar:nth-child(3){
    width:14px;               /* dưới ngắn hơn nữa */
}
.history-top-toggle.open .bar,
.history-drawer-toggle.open .bar {
    background: var(--accent-color);
    width:22px;               /* khi mở đồng nhất chiều dài */
}
.history-top-toggle.open .bar:nth-child(2){
    width:22px;
}
.history-top-toggle.open .bar:nth-child(3){
    width:22px;
}
/* Ẩn style cũ của .history-icon nếu còn */
.history-icon { display:none !important; }

/* Override: loại viền trắng mờ nút history */
.history-top-toggle,
.history-drawer-toggle {
    border: 1px solid var(--chat-bg) !important; /* trùng nền -> coi như mất viền */
}

.history-top-toggle:hover,
.history-drawer-toggle:hover,
.history-top-toggle.open,
.history-drawer-toggle.open {
    border: 1px solid var(--border-color) !important; /* chỉ hiện viền khi hover / mở */
}

/* (Tuỳ chọn) nếu muốn bỏ hẳn viền luôn:
.history-top-toggle,
.history-drawer-toggle { border:0 !important; }
.history-top-toggle:hover,
.history-drawer-toggle:hover { border:0 !important; }
*/
/* Thêm ngay sau <body> */
.bg-animation {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 0; /* nằm dưới các chat bubble */
}
.particle {
    position: absolute;
    width: 4px; height: 4px;
    background: #8b5cf6;
    border-radius: 50%;
    animation: float 20s infinite linear;
    box-shadow: 0 0 10px #8b5cf6;
}
.particle:nth-child(1) { left: 20%; animation-delay: 0s; animation-duration: 15s; }
.particle:nth-child(2) { left: 40%; animation-delay: 5s; animation-duration: 20s; background: #7c3aed; box-shadow: 0 0 10px #7c3aed; }
.particle:nth-child(3) { left: 60%; animation-delay: 10s; animation-duration: 25s; background: #a78bfa; box-shadow: 0 0 10px #a78bfa; }
.particle:nth-child(4) { left: 80%; animation-delay: 15s; animation-duration: 18s; }
.particle:nth-child(5) { left: 10%; animation-delay: 8s; animation-duration: 22s; background: #7c3aed; box-shadow: 0 0 10px #7c3aed; }
@keyframes float {
    0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
}

/* Snowfall animation */
.particle.snowflake {
    border-radius: 50%;
    box-shadow: 0 0 8px #fff;
    position: absolute;
    animation: snow-fall linear infinite;
}
@keyframes snow-fall {
    0% { transform: translateY(-10vh); opacity: 0.8; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateY(110vh); opacity: 0.2; }
}
#snow-canvas { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:0; }
.chat-messages, .chat-bubble { position:relative; z-index:2; } /* đảm bảo tuyết không đè lên */
    </style>
    <style>
      @media (max-width:600px) {
        /* Popup tool panel */
        #tool-buttons {
          position:absolute;
          bottom:100%;           /* nằm trên input */
          right:0;
          left:auto;
          display:flex;
          flex-direction:column; /* xếp dọc */
          gap:10px;
          padding:10px 12px;
          background:rgba(13,17,23,0.95);
          border:1px solid var(--border-color);
          border-radius:14px;
          box-shadow:0 8px 28px -4px rgba(0,0,0,0.55);
          backdrop-filter:blur(6px);
          transform-origin: bottom right;
          transition: opacity .18s ease, transform .18s ease;
          z-index:120;
          width:66px; /* đủ cho icon vuông */
        }
        /* Nếu muốn dạng 2 cột (bỏ comment):
        #tool-buttons {
           width:134px;
           flex-wrap:wrap;
           flex-direction:row;
        }
        #tool-buttons .action-btn { flex:0 0 calc(50% - 6px); }
        */

        #tool-buttons .action-btn {
          width:52px;
          height:52px;
          font-size:20px;
          border:1px solid var(--border-color);
          border-radius:12px;
          background:#161b22;
          transition:background .18s, border-color .18s, color .18s;
        }
        #tool-buttons .action-btn:hover {
          background:#1f2731;
          border-color:var(--accent-color);
          color:var(--text-color);
        }

        #tool-buttons.collapsed {
          opacity:0;
          transform:translateY(10px) scale(.92);
          pointer-events:none;
        }
        #tool-buttons:not(.collapsed) {
          opacity:1;
          transform:translateY(0) scale(1);
        }

        /* Căn nút + sát bên phải để panel mở lên ngay trên */
        .input-actions {
          position:relative;
        }
        #toggle-tools-btn {
          position:relative;
          z-index:121; /* nằm trên panel */
        }
      }
    </style>
    <style>
/* === 3D Tilt Effect (buttons) === */
.tilt-3d{
  position:relative;
  background:linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
  box-shadow:0 4px 10px -2px rgba(0,0,0,0.45), 0 0 0 1px var(--border-color);
  transform-style:preserve-3d;
  will-change:transform;
  transition:transform .28s cubic-bezier(.25,.8,.25,1), box-shadow .35s;
  border-radius:8px;
}
.tilt-3d:hover{
  box-shadow:
    0 6px 18px -4px rgba(0,0,0,0.55),
    0 0 0 1px rgba(47,129,247,0.55),
    0 0 14px -2px rgba(47,129,247,0.55);
}
.tilt-3d::after{
  content:'';
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at var(--mx,50%) var(--my,50%),
      rgba(255,255,255,0.28),
      rgba(255,255,255,0.05) 38%,
      rgba(255,255,255,0) 70%);
  opacity:var(--glow-o,0);
  mix-blend-mode:screen;
  pointer-events:none;
  transition:opacity .25s;
  border-radius:inherit;
}
.tilt-3d:active{
  transition:transform .08s;
  transform:perspective(800px) rotateX(0deg) rotateY(0deg) translateZ(0) scale(.95);
}
</style>
</head>
<body>
    <div class="bg-animation">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    <div class="chat-container">
        <!-- (XÓA nút cũ ở đây nếu còn) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="startNewConversation()">
                    <i class="fas fa-plus"></i>
                    <span>Cuộc trò chuyện mới</span>
                </button>
                <button id="find-btn" class="new-chat-btn" onclick="openFindModal()" title="Tìm trong cuộc trò chuyện (Ctrl+Shift+F)">
                  <i class="fas fa-search"></i>
                  <span>Tìm kiếm</span>
                  <span style="margin-left:auto;font-size:11px;opacity:.6;">Ctrl+Shift+F</span>
                </button>
            </div>
            <nav class="history">
                <h3>
                    Lịch sử
                    <span id="history-actions" style="font-size:12px;"></span>
                </h3>
                <ul id="history-list"></ul>
            </nav>
            <div class="sidebar-footer">Made with ❤️ by TT1403 & Ant.</div>
        </aside>

        <div class="resizer" id="resizer"></div>
        <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
 
         <main class="chat-area" id="chat-area">
            <canvas id="snow-canvas"></canvas>
            <!-- Nút toggle lịch sử mới (mobile) -->
            <button id="history-drawer-toggle" class="history-top-toggle" aria-label="Mở lịch sử">
                <span class="bars" aria-hidden="true">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </span>
            </button>
            <!-- Mobile header (shown on small screens) -->
            <div class="mobile-header" id="mobile-header" style="display:none;">
                <button class="hamburger" id="mobile-menu-btn" aria-label="Mở menu"><i class="fas fa-bars"></i></button>
                <div class="title">JAREMIS</div>
                <button id="history-toggle-btn" aria-label="Xem lịch sử" onclick="toggleHistoryMode()">
                    <i class="fas fa-clock-rotate-left"></i><span style="margin-left:4px;">Lịch sử</span>
                </button>
            </div>
             <!-- Auth controls (top-right) -->
             <div class="auth-controls" id="auth-controls">
                 <!-- Will be populated by JS -->
             </div>
 
            <div class="chat-messages" id="chat-messages">
                <div style="height:12px;"></div> <!-- spacer tránh trùng nút auth -->
                <div class="chat-bubble bot-bubble">
                    <strong>Chào bạn 👋 Mình là JAREMIS.</strong>
                    <p style="margin-top:8px; color:var(--text-secondary-color);">
                        Hãy nhập các dấu hiệu, hỏi chuyện, hoặc bật chế độ <strong>Diagnose</strong> để yêu cầu chẩn đoán y khoa.
                    </p>
                </div>
            </div>

            <div class="chat-input-area">
                <div id="image-preview-container"></div>
                <div class="input-wrapper">
                    <textarea id="chat-input" placeholder="Nhập tin nhắn hoặc tải lên hình ảnh..." rows="1" oninput="autoResize(this)"></textarea>

                    <div class="input-actions">
                        <button id="toggle-tools-btn" class="toggle-tools-btn" title="Mở công cụ" onclick="toggleToolTray(event)">
                            <i class="fas fa-plus"></i>
                        </button>

                        <div id="tool-buttons" class="tool-buttons collapsed">
                            <button class="action-btn" onclick="document.getElementById('images').click()" title="Đính kèm ảnh">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button id="mode-btn" class="action-btn" title="Chế độ: Chat (mặc định)" onclick="toggleMode(event)">
                                <i class="fas fa-comments"></i>
                            </button>
                            <button id="mic-btn" class="action-btn" title="Ghi giọng nói (Vietnamese). Nhấn để bắt đầu/dừng" onclick="toggleMic(event)">
                                <i class="fas fa-microphone"></i>
                                <span id="mic-indicator"></span>
                            </button>
                            <button id="think-btn" class="action-btn" title="Bật Think (dùng Jaremis Pro 1.5)" onclick="toggleThink(event)">
                                <i class="fas fa-brain"></i>
                            </button>
                        </div>

                        <button id="send-btn" class="action-btn" onclick="submitData()" title="Gửi">
                            <i class="fas fa-paper-plane"></i>
                        </button>

                        <input type="file" id="images" multiple hidden onchange="handleImageUpload(event)">
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div id="model-status">Model: JAREMIS 1.5</div>
                    <div style="font-size:12px; color:var(--text-secondary-color);">Trạng thái: Rảnh</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Auth modal -->
    <div class="modal-backdrop" id="auth-backdrop">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
            <h3 id="auth-title">Đăng nhập / Đăng ký</h3>

            <div class="tabs">
                <div class="tab active" id="tab-login" onclick="showTab('login')">Đăng nhập</div>
                <div class="tab" id="tab-register" onclick="showTab('register')">Đăng ký</div>
            </div>

            <!-- Login form -->
            <div id="form-login">
                <div class="form-row">
                    <label>Username hoặc Email</label>
                    <input id="login-username" placeholder="Tên đăng nhập hoặc email">
                </div>
                <div class="form-row">
                    <label>Mật khẩu</label>
                    <input id="login-password" type="password" placeholder="Mật khẩu">
                </div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="submitLogin()">Đăng nhập</button>
                    <button class="btn-ghost" onclick="closeAuthModal()">Hủy</button>
                </div>
                <div class="small-muted">Bạn chưa có tài khoản? Chuyển sang tab "Đăng ký".</div>
            </div>

            <!-- Register form -->
            <div id="form-register" style="display:none">
                <div class="form-row">
                    <label>Tên đăng nhập</label>
                    <input id="reg-username" placeholder="Tên đăng nhập">
                </div>
                <div class="form-row">
                    <label>Email</label>
                    <input id="reg-email" placeholder="email@example.com" type="email">
                </div>
                <div class="form-row">
                    <label>Mật khẩu</label>
                    <input id="reg-password" type="password" placeholder="Mật khẩu (ít nhất 6 ký tự)">
                </div>

                <div class="form-actions">
                    <button class="btn-primary" onclick="submitRegister()">Đăng ký</button>
                    <button class="btn-ghost" onclick="closeAuthModal()">Hủy</button>
                </div>
                <div class="small-muted">Bằng cách đăng ký, bạn đồng ý thử nghiệm tính năng.</div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="find-backdrop" style="display:none;">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="find-title">
        <h3 id="find-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>Tìm kiếm</span>
          <button class="btn-ghost" style="padding:4px 10px;font-size:14px;" onclick="closeFindModal()" title="Đóng (Esc)">&times;</button>
        </h3>
        <div class="form-row" style="margin-bottom:10px;">
          <input id="find-query" placeholder="Nhập từ khóa... (Enter=Tiếp, Shift+Enter=Trước)" style="background:#071018;">
        </div>
        <div class="form-row" style="flex-direction:row;align-items:center;gap:14px;margin-bottom:12px;">
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;">
            <input type="checkbox" id="find-case"> Phân biệt hoa/thường
          </label>
          <div id="find-count" style="margin-left:auto;font-size:12px;color:var(--text-secondary-color);">0 / 0</div>
        </div>
        <div class="form-actions" style="justify-content:flex-start;gap:8px;">
          <button class="btn-ghost" onclick="findPrev()" title="Trước (Shift+Enter)">Trước</button>
          <button class="btn-primary" onclick="findNext()" title="Tiếp (Enter)">Tiếp</button>
          <button class="btn-ghost" onclick="clearFindHighlights()" title="Xóa highlight">Xóa</button>
          <button class="btn-ghost" onclick="closeFindModal()" title="Đóng (Esc)">Đóng</button>
        </div>
        <div class="small-muted" style="margin-top:10px;">
          Ctrl+F mở • Enter=Tiếp • Shift+Enter=Trước • Esc=Đóng
        </div>
      </div>
    </div>

    <script>
        // ------------------------------
        // UI elements & state
        // ------------------------------
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const imageInput = document.getElementById('images');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const chatMessages = document.getElementById('chat-messages');
        const thinkBtn = document.getElementById('think-btn');
        const modelStatusEl = document.getElementById('model-status');
        const micBtn = document.getElementById('mic-btn');
        const micIndicator = document.getElementById('mic-indicator');
        const modeBtn = document.getElementById('mode-btn');

        const historyListEl = document.getElementById('history-list');
        const historyActionsEl = document.getElementById('history-actions');

        const authBackdrop = document.getElementById('auth-backdrop');
        const authControls = document.getElementById('auth-controls');

        let useProModel = false;
        let diagnosticMode = false; // Chat mode default
        let recognition = null;
        let isRecording = false;
        let textBeforeRecording = '';
        let historyCache = [];

        let currentSessionId = null;

        // Khởi tạo session hiện tại
        document.addEventListener('DOMContentLoaded', () => {
          if (!localStorage.getItem('jaremis_session')) {
            localStorage.setItem('jaremis_session', 'sess-' + Date.now());
          }
          currentSessionId = localStorage.getItem('jaremis_session');
          // Thêm lời chào nếu trống
          if (!chatMessages.innerHTML.trim()) {
            chatMessages.innerHTML = `<div class="chat-bubble bot-bubble"><strong>Chào bạn 👋 Mình là JAREMIS.</strong><p style="margin-top:8px; color:var(--text-secondary-color);">Bắt đầu cuộc trò chuyện mới.</p></div>`;
          }
        });

        // Tạo cuộc trò chuyện mới (giống ChatGPT)
        function startNewConversation() {
          currentSessionId = 'sess-' + Date.now();
          localStorage.setItem('jaremis_session', currentSessionId);
          chatMessages.innerHTML = `
            <div class="chat-bubble bot-bubble">
              <strong>Cuộc trò chuyện mới đã bắt đầu.</strong>
              <p style="margin-top:8px; color:var(--text-secondary-color);">Hãy nhập câu hỏi đầu tiên của bạn.</p>
            </div>`;
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ------------------------------
        // Helper: Escape HTML
        // ------------------------------
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ------------------------------
        // Auto-resize textarea
        // ------------------------------
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // ------------------------------
        // Mode & Think toggles
        // ------------------------------
        function toggleMode(e) {
            e?.preventDefault();
            diagnosticMode = !diagnosticMode;
            if (diagnosticMode) {
                modeBtn.classList.add('active');
                modeBtn.title = 'Chế độ: Diagnose (chẩn đoán y khoa)';
                modeBtn.innerHTML = '<i class="fas fa-stethoscope"></i>';
            } else {
                modeBtn.classList.remove('active');
                modeBtn.title = 'Chế độ: Chat';
                modeBtn.innerHTML = '<i class="fas fa-comments"></i>';
            }
        }

        function toggleThink(e) {
            e?.preventDefault();
            useProModel = !useProModel;
            if (useProModel) {
                thinkBtn.classList.add('active');
                modelStatusEl.textContent = 'Model: JAREMIS PRO 1.5';
            } else {
                thinkBtn.classList.remove('active');
                modelStatusEl.textContent = 'Model: JAREMIS 1.5';
            }
        }

        // ------------------------------
        // Authentication & user state (client session stored in localStorage)
        // ------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            renderAuthControls();
            const u = getLocalUser();
            if (u) fetchAndRenderHistory(u.username);
        });

        function getLocalUser() {
            try {
                const raw = localStorage.getItem('jaremis_user');
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                return null;
            }
        }

        function renderAuthControls() {
            authControls.innerHTML = '';
            const user = getLocalUser();
            if (user) {
                const nameEl = document.createElement('div');
                nameEl.style.color = 'var(--text-color)';
                nameEl.style.fontSize = '13px';
                nameEl.textContent = user.username;

                const btnHistoryClear = document.createElement('button');
                btnHistoryClear.className = 'auth-btn';
                btnHistoryClear.textContent = 'Xóa lịch sử';
                btnHistoryClear.title = 'Xóa toàn bộ lịch sử chat';
                btnHistoryClear.onclick = async () => {
                    if (!confirm('Xóa toàn bộ lịch sử chat của bạn?')) return;
                    try {
                        const res = await fetch(`/api/history?username=${encodeURIComponent(user.username)}`, { method: 'DELETE' });
                        const json = await res.json();
                        if (!res.ok) {
                            alert(json.error || 'Không xóa được lịch sử');
                            return;
                        }
                        historyCache = [];
                        renderHistoryList([]);
                        flashNotice('Đã xóa lịch sử');
                    } catch (e) {
                        console.error(e);
                        flashNotice('Lỗi khi xóa lịch sử');
                    }
                };

                const logoutBtn = document.createElement('button');
                logoutBtn.className = 'auth-btn';
                logoutBtn.textContent = 'Đăng xuất';
                logoutBtn.onclick = () => {
                    localStorage.removeItem('jaremis_user');
                    renderAuthControls();
                    historyCache = [];
                    renderHistoryList([]);
                };

                authControls.appendChild(nameEl);
                authControls.appendChild(btnHistoryClear);
                authControls.appendChild(logoutBtn);
            } else {
                const loginBtn = document.createElement('button');
                loginBtn.className = 'auth-btn';
                loginBtn.textContent = 'Đăng nhập';
                loginBtn.onclick = openAuthModal;

                const registerBtn = document.createElement('button');
                registerBtn.className = 'auth-btn';
                registerBtn.textContent = 'Đăng ký';
                registerBtn.onclick = () => { openAuthModal(); showTab('register'); };

                authControls.appendChild(loginBtn);
                authControls.appendChild(registerBtn);
            }
        }

        function openAuthModal() {
            authBackdrop.style.display = 'flex';
            showTab('login');
        }
        function closeAuthModal() {
            authBackdrop.style.display = 'none';
        }
        function showTab(tab) {
            document.getElementById('tab-login').classList.toggle('active', tab === 'login');
            document.getElementById('tab-register').classList.toggle('active', tab === 'register');
            document.getElementById('form-login').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('form-register').style.display = tab === 'register' ? 'block' : 'none';
        }

        async function submitRegister() {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;

            if (!username || !email || !password) {
                flashNotice('Vui lòng nhập đầy đủ thông tin đăng ký');
                return;
            }
            if (password.length < 6) {
                flashNotice('Mật khẩu ít nhất 6 ký tự');
                return;
            }

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const json = await res.json();
                if (!res.ok) {
                    flashNotice(json.error || 'Đăng ký thất bại');
                    return;
                }
                localStorage.setItem('jaremis_user', JSON.stringify(json.user));
                flashNotice('Đăng ký thành công! Bạn đã đăng nhập tạm thời.', 2000);
                closeAuthModal();
                renderAuthControls();
                fetchAndRenderHistory(json.user.username);
            } catch (e) {
                console.error('Register error', e);
                flashNotice('Lỗi kết nối khi đăng ký');
            }
        }

        async function submitLogin() {
            const usernameOrEmail = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            if (!usernameOrEmail || !password) {
                flashNotice('Vui lòng nhập username/email và mật khẩu');
                return;
            }
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usernameOrEmail, password })
                });
                const json = await res.json();
                if (!res.ok) {
                    flashNotice(json.error || 'Đăng nhập thất bại');
                    return;
                }
                localStorage.setItem('jaremis_user', JSON.stringify(json.user));
                flashNotice('Đăng nhập thành công', 1200);
                closeAuthModal();
                renderAuthControls();
                fetchAndRenderHistory(json.user.username);
            } catch (e) {
                console.error('Login error', e);
                flashNotice('Lỗi kết nối khi đăng nhập');
            }
        }

        function flashNotice(msg, duration = 2000) {
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble bot-bubble';
            bubble.innerHTML = `<em style="color:var(--text-secondary-color)">${escapeHtml(msg)}</em>`;
            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            setTimeout(() => bubble.remove(), duration);
        }

        // ------------------------------
        // History: fetch, render, open
        // ------------------------------
        async function fetchAndRenderHistory(username) {
            if (!username) return;
            try {
                const res = await fetch(`/api/history?username=${encodeURIComponent(username)}`);
                const json = await res.json();
                if (!res.ok) {
                    console.warn('Không lấy được lịch sử', json);
                    renderHistoryList([]);
                    return;
                }
                historyCache = json.history || [];
                renderHistoryList(historyCache);
            } catch (e) {
                console.error('fetch history error', e);
            }
        }

        // Group & render history thành LIST CUỘC TRÒ CHUYỆN
        function renderHistoryList(list) {
          historyListEl.innerHTML = '';
          if (!list || list.length === 0) {
            historyListEl.innerHTML = `<li style="color:var(--text-secondary-color); font-size:13px;">Chưa có lịch sử</li>`;
            historyActionsEl.innerHTML = '';
            return;
          }
          // Gom theo sessionId
          const sessions = {};
          list.forEach(entry => {
            const sid = entry.sessionId || ('legacy-' + entry.id);
            if (!sessions[sid]) sessions[sid] = [];
            sessions[sid].push(entry);
          });
          // Sắp xếp session theo newest timestamp (lớn nhất)
          const sessionArray = Object.entries(sessions).map(([sid, entries]) => {
            const newestTs = Math.max(...entries.map(e => new Date(e.timestamp).getTime()));
            return { sid, entries, newestTs };
          }).sort((a,b) => b.newestTs - a.newestTs);

          sessionArray.forEach(sess => {
            // Lấy message user đầu tiên của session (cũ nhất type chat/diagnose có input)
            const chronological = [...sess.entries].sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));
            const first = chronological.find(e => e.input && e.input.trim()) || chronological[chronological.length-1];
            const title = (first.input || 'Cuộc trò chuyện').slice(0,60) + (first.input && first.input.length>60 ? '...' : '');
            const timeLabel = new Date(sess.newestTs).toLocaleString();
            const li = document.createElement('li');
            li.dataset.session = sess.sid;
            li.innerHTML = `<div style="display:flex; flex-direction:column; gap:4px;">
                <div style="font-size:13px; color:var(--text-color); font-weight:600;">${escapeHtml(title)}</div>
                <div style="font-size:11px; color:var(--text-secondary-color);">${escapeHtml(timeLabel)} • ${sess.entries.length} lượt</div>
              </div>`;
            li.onclick = () => openConversation(sess.sid);
            historyListEl.appendChild(li);
          });
          historyActionsEl.innerHTML = ''; // bỏ nút cũ
        }

        // Mở toàn bộ cuộc trò chuyện
        function openConversation(sessionId) {
          const convoEntries = historyCache.filter(e => (e.sessionId || ('legacy-'+e.id)) === sessionId)
            .sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));
          if (!convoEntries.length) return;
          chatMessages.innerHTML = '';
          convoEntries.forEach(entry => {
            // User bubble
            if (entry.input) {
              chatMessages.innerHTML += `<div class="chat-bubble user-bubble"><div class="user-bubble-content"><p>${escapeHtml(entry.input)}</p></div></div>`;
            }
            // Bot / kết quả
            if (entry.type === 'diagnose') {
              chatMessages.innerHTML += `<div class="chat-bubble bot-bubble">
                <div class="diagnosis-details">
                  <div style="font-size:12px; color:var(--text-secondary-color); margin-bottom:6px;">Diagnose • ${new Date(entry.timestamp).toLocaleString()}</div>
                  ${convertMarkdown(entry.diagnosis || '')}
                </div>
              </div>`;
            } else {
              chatMessages.innerHTML += `<div class="chat-bubble bot-bubble">
                <div class="diagnosis-details">
                  <div style="font-size:12px; color:var(--text-secondary-color); margin-bottom:6px;">Chat • ${new Date(entry.timestamp).toLocaleString()}</div>
                  ${convertMarkdown(entry.reply || '')}
                </div>
              </div>`;
            }
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
          currentSessionId = sessionId; // tiếp tục vào phiên này nếu người dùng muốn
          localStorage.setItem('jaremis_session', currentSessionId);
        }

        // ------------------------------
        // Mic / SpeechRecognition
        // ------------------------------
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN';
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            recognition.continuous = false;

            recognition.onstart = () => {
                isRecording = true;
                micBtn.classList.add('recording');
                micBtn.title = 'Đang ghi âm — nhấn để dừng';
                textBeforeRecording = chatInput.value || '';
                chatInput.focus();
            };

            recognition.onerror = (event) => {
                console.warn('Speech recognition error', event.error);
                stopRecognition();
                flashNotice('Lỗi ghi âm: ' + (event.error || 'Không xác định'));
            };

            recognition.onend = () => {
                stopRecognition(false);
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = 0; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                chatInput.value = (textBeforeRecording + ' ' + finalTranscript + interimTranscript).trim();
                autoResize(chatInput);
            };
        } else {
            micBtn.title = 'Trình duyệt của bạn không hỗ trợ ghi âm chuyển văn bản (Web Speech API). Dùng Chrome/Microsoft Edge mới nhất để có chức năng này.';
            micBtn.style.opacity = '0.6';
            micBtn.style.pointerEvents = 'none';
        }

        function toggleMic(e) {
            e?.preventDefault();
            if (!SpeechRecognition) return;
            if (!isRecording) startRecognition();
            else stopRecognition();
        }

        function startRecognition() {
            if (!recognition) return;
            try {
                textBeforeRecording = chatInput.value || '';
                recognition.start();
            } catch (err) {
                console.warn('Không thể bắt đầu ghi âm:', err);
                flashNotice('Không thể bắt đầu ghi âm: ' + (err.message || err));
            }
        }

        function stopRecognition(clearInterim = false) {
            if (!recognition) return;
            try { recognition.stop(); } catch (e) {}
            isRecording = false;
            micBtn.classList.remove('recording');
            micBtn.title = 'Ghi giọng nói (Vietnamese). Nhấn để bắt đầu/dừng';
            if (clearInterim) {
                chatInput.value = textBeforeRecording || '';
                autoResize(chatInput);
            }
        }

        // ------------------------------
        // Image preview
        // ------------------------------
        function handleImageUpload(event) {
            imagePreviewContainer.innerHTML = '';
            Array.from(event.target.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-btn" onclick="removeImage(${index})">&times;</button>
                    `;
                    imagePreviewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            const dt = new DataTransfer();
            const files = Array.from(imageInput.files);
            files.splice(index, 1);
            files.forEach(file => dt.items.add(file));
            imageInput.files = dt.files;
            handleImageUpload({ target: imageInput });
        }

        // ------------------------------
        // Animate analysis steps (UX)
        // ------------------------------
        async function animateAnalysisSteps(bubbleElement) {
            const steps = [
                'Đang khởi tạo và gửi dữ liệu...',
                'Tìm kiếm tài liệu tham khảo (PubMed, ClinicalTrials)...',
                'AI đang phân tích và chẩn đoán hình ảnh...',
                'Tổng hợp và định dạng kết quả chẩn đoán...'
            ];

            let html = '<div class="analysis-steps">';
            steps.forEach((step, index) => {
                html += `<div id="step-${index}" class="step-item pending">
                            <span class="icon"><i class="fas fa-hourglass-half"></i></span>
                            <span>${step}</span>
                         </div>`;
            });
            html += '</div>';
            bubbleElement.innerHTML = html;

            for (let i = 0; i < steps.length; i++) {
                const stepEl = bubbleElement.querySelector(`#step-${i}`);
                const iconEl = stepEl.querySelector('.icon');

                stepEl.classList.remove('pending');
                stepEl.classList.add('active');
                iconEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                await new Promise(resolve => setTimeout(resolve, 600 + Math.random() * 600));

                stepEl.classList.remove('active');
                stepEl.classList.add('completed');
                iconEl.innerHTML = '<i class="fas fa-check"></i>';
            }
        }

        // ------------------------------
        // Submit: chooses /api/chat or /api/diagnose
        // ------------------------------
        async function submitData() {
            const labResults = chatInput.value.trim();
            const images = imageInput.files;
            if (!labResults && images.length === 0) return;
            if (!currentSessionId) {
                currentSessionId = 'sess-' + Date.now();
                localStorage.setItem('jaremis_session', currentSessionId);
            }
            // 1. Display user bubble
            let userHtml = `<div class="chat-bubble user-bubble"><div class="user-bubble-content">`;
            if (labResults) userHtml += `<p>${escapeHtml(labResults)}</p>`;
            if (images.length > 0) {
                let imagePreviews = '<div class="user-images-preview">';
                for (let i = 0; i < images.length; i++) {
                    imagePreviews += `<img src="${URL.createObjectURL(images[i])}" alt="user image">`;
                }
                imagePreviews += '</div>';
                userHtml += imagePreviews;
            }
            const currentUser = getLocalUser();
            if (currentUser) {
                userHtml += `<div style="margin-top:8px; font-size:12px; color:var(--text-secondary-color)">Đã gửi bởi: ${escapeHtml(currentUser.username)}</div>`;
            }
            userHtml += `</div></div>`;
            chatMessages.innerHTML += userHtml;

            // 2. Clear input + previews
            chatInput.value = '';
            autoResize(chatInput);
            imagePreviewContainer.innerHTML = '';

            // 3. Create loading bubble
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble bot-bubble';
            chatMessages.appendChild(loadingBubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                if (diagnosticMode) {
                    // Diagnose flow
                    const formData = new FormData();
                    if (labResults) formData.append('labResults', labResults);
                    Array.from(images).forEach(img => formData.append('images', img));
                    formData.append('model', useProModel ? 'pro' : 'flash');
                    formData.append('sessionId', currentSessionId);
                    if (currentUser) formData.append('submittedBy', currentUser.username);

                    const analysisPromise = animateAnalysisSteps(loadingBubble);
                    const fetchPromise = fetch('/api/diagnose', { method: 'POST', body: formData });

                    const [_, response] = await Promise.all([analysisPromise, fetchPromise]);

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: 'Lỗi không xác định từ máy chủ' }));
                        throw new Error(error.error || 'Lỗi không xác định từ máy chủ');
                    }
                    const data = await response.json();
                    displayResults(data, loadingBubble);
                    if (currentUser) fetchAndRenderHistory(currentUser.username);
                } else {
                    // Chat flow
                    const body = { message: labResults, model: useProModel ? 'pro' : 'flash', sessionId: currentSessionId };
                    if (currentUser) body.submittedBy = currentUser.username;
                    if (images.length > 0) body.imagesCount = images.length;

                    const resp = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({ error: 'Lỗi từ server' }));
                        throw new Error(err.error || 'Lỗi khi gọi /api/chat');
                    }
                    const data = await resp.json();
                    // Render reply (simple)
                    const replyHtml = `<div class="diagnosis-details">${convertMarkdown(data.reply || data.replyText || '')}</div>`;
                    loadingBubble.innerHTML = replyHtml;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    if (currentUser) fetchAndRenderHistory(currentUser.username);
                }
            } catch (error) {
                showError(error.message, loadingBubble);
            } finally {
                sendBtn.disabled = false;
                imageInput.value = '';
            }
        }

        // ------------------------------
        // displayResults for diagnose flows
        // ------------------------------
        function displayResults(data, targetBubble) {
            // if it's a chat-style reply
            if (data.reply) {
                targetBubble.innerHTML = `<div class="diagnosis-details">${convertMarkdown(data.reply)}</div>`;
                return;
            }

            let html = '';

            if (data.confidence !== undefined) {
                html += `
                    <div class="confidence-meter">
                        <div class="confidence-bar" style="width:${Math.max(0, Math.min(100, data.confidence))}%">Độ tin cậy: ${data.confidence}%</div>
                    </div>
                `;
            }

            if (Array.isArray(data.diseases) && data.diseases.length) {
                html += '<h3><i class="fas fa-notes-medical"></i> Khả năng chẩn đoán</h3><div class="disease-list">';
                data.diseases.forEach(d => {
                    const pct = Math.min(d.probability || 0, 100);
                    html += `
                        <div class="disease-item">
                            <strong>${escapeHtml(d.name || '')}</strong>
                            <div class="probability-bar">
                                <div class="probability-fill" style="width:${pct}%"></div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (data.diagnosis) {
                html += `<div class="diagnosis-details">
                    ${convertMarkdown(data.diagnosis)}
                    ${displayReferences(data.references)}
                    <div class="warning">${data.warning || ''}</div>
                </div>`;
            } else if (data.icdDescriptions && data.icdDescriptions.length) {
                html += `<div class="diagnosis-details"><h3>Chẩn đoán phân biệt (ICD)</h3>`;
                data.icdDescriptions.forEach(item => {
                    html += `<div class="disease-item"><strong>${escapeHtml(item.label)}</strong><div>${escapeHtml(item.icdCode || '')} - ${escapeHtml(item.description || '')}</div></div>`;
                });
                html += `</div>`;
            }

            if (data.modelUsed) {
                html += `<div style="margin-top:10px; font-size:12px; color:var(--text-secondary-color)">Đã dùng model: ${escapeHtml(data.modelUsed)}</div>`;
            }

            targetBubble.innerHTML = html;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayReferences(references) {
            if (!references || !references.length) return '';
            return `
                <div class="references-section">
                    <h3><i class="fas fa-book-medical"></i> Tài liệu tham khảo</h3>
                    ${references.map(ref => `
                        <div class="reference-item">
                            <a href="${escapeHtml(ref.url || '#')}" target="_blank" rel="noopener noreferrer">${escapeHtml(ref.title || 'Tài liệu tham khảo')}</a>
                            ${ref.source ? `<div class="reference-source">Nguồn: ${escapeHtml(ref.source)}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showError(message, targetBubble) {
            targetBubble.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Lỗi:</strong> ${escapeHtml(message)}
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function convertMarkdown(text) {
            if (!text) return '';
            let out = text
                .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- (.*)/gm, '<li>$1</li>')
                .replace(/•\s*(.*)/g, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');
            return out;
        }

        // ------------------------------
        // Keyboard & Shortcuts (Ctrl-based)
        // ------------------------------
        (function(){
  const chatInputEl = document.getElementById('chat-input');
  const fileInputEl = document.getElementById('images');
  const modeBtn = document.getElementById('mode-btn');
  const thinkBtn = document.getElementById('think-btn');
  const micBtn = document.getElementById('mic-btn');
  const newChatBtn = document.querySelector('.new-chat-btn');

  function safe(fn){ return e => { try{ fn(e); } catch(err){ console.warn('Shortcut error', err); } }; }

  // Enter gửi / Shift+Enter xuống dòng
  if (chatInputEl){
    chatInputEl.addEventListener('keydown', safe(e=>{
      if (e.isComposing) return;
      if (e.key === 'Enter'){
        if (e.shiftKey) return;
        e.preventDefault();
        submitData();
      }
    }));
  }

  function getLocalUser(){
    try { return JSON.parse(localStorage.getItem('jaremis_user')||'null'); } catch(_){ return null; }
  }

  async function clearHistoryShortcut(){
    const u = getLocalUser();
    if (!u) { flashNotice('Chưa đăng nhập'); return; }
    if (!confirm('Xóa toàn bộ lịch sử?')) return;
    try {
      const res = await fetch('/api/history?username='+encodeURIComponent(u.username), { method:'DELETE' });
      if (!res.ok){ flashNotice('Lỗi xóa lịch sử'); return; }
      historyCache = [];
      renderHistoryList([]);
      flashNotice('Đã xóa lịch sử');
    } catch(err){ flashNotice('Lỗi mạng khi xóa'); }
  }

  function logoutShortcut(){
    const u = getLocalUser();
    if (!u){ flashNotice('Chưa đăng nhập'); return; }
    localStorage.removeItem('jaremis_user');
    historyCache = [];
    renderHistoryList([]);
    renderAuthControls && renderAuthControls();
    flashNotice('Đã đăng xuất',1500);
  }

  function openLoginShortcut(){
    const u = getLocalUser();
    if (u){ flashNotice('Đã đăng nhập'); return; }
    openAuthModal();
  }

  function showShortcutHelp(){
    const listHtml = SHORTCUTS
      .filter(s=>s.desc && s.combo !== 'Ctrl+/')
      .map(s=>`<li><code style="background:#111;padding:2px 6px;border-radius:4px;">${s.combo}</code> - ${escapeHtml(s.desc)}</li>`)
      .join('');
    flashNotice('Phím tắt:<br><ul style="padding-left:18px;margin:6px 0;">'+listHtml+'</ul>', 6000);
  }

  // Danh sách phím tắt (toàn bộ dùng Ctrl)
  const SHORTCUTS = [
    { combo:'Ctrl+D', action: ()=>toggleMode(), desc:'Bật/tắt Diagnose' },
    { combo:'Ctrl+T', action: ()=>toggleThink(), desc:'Bật/tắt Think / Pro' },
    { combo:'Ctrl+M', action: ()=>toggleMic(), desc:'Ghi âm' },
    { combo:'Ctrl+U', action: ()=>fileInputEl && fileInputEl.click(), desc:'Đính kèm ảnh' },
    { combo:'Ctrl+N', action: ()=>startNewConversation(), desc:'Cuộc trò chuyện mới' },
    { combo:'Ctrl+L', action: ()=>openLoginShortcut(), desc:'Mở hộp đăng nhập' },
    { combo:'Ctrl+X', action: ()=>clearHistoryShortcut(), desc:'Xóa lịch sử' },
    { combo:'Ctrl+Q', action: ()=>logoutShortcut(), desc:'Đăng xuất' },
    { combo:'Ctrl+G', action: ()=>chatInputEl && chatInputEl.focus(), desc:'Focus ô nhập' },
    { combo:'Ctrl+/', action: ()=>showShortcutHelp(), desc:'Hiện danh sách phím tắt' },
    { combo:'Ctrl+Shift+F', action:()=>openFindModal(), desc:'Tìm trong cuộc trò chuyện' }
  ];

  function parseCombo(str){
    const parts = str.toLowerCase().split('+').map(s=>s.trim());
    return {
      ctrl: parts.includes('ctrl'),
      alt: parts.includes('alt'),
      shift: parts.includes('shift'),
      key: parts.find(p=>!['ctrl','alt','shift'].includes(p))
    };
  }
  const parsedShortcuts = SHORTCUTS.map(s=>({...s, parsed: parseCombo(s.combo)}));

  function matchShortcut(e, p){
    if (p.ctrl !== e.ctrlKey) return false;
    if (p.alt  !== e.altKey) return false;
    if (p.shift!== e.shiftKey) return false;
    return e.key.toLowerCase() === p.key;
  }

  document.addEventListener('keydown', safe(e=>{
    parsedShortcuts.forEach(sc=>{
      if (matchShortcut(e, sc.parsed)){
        // Tránh xung đột copy/paste? (ở đây chặn tất cả vì dùng tổ hợp riêng)
        e.preventDefault();
        sc.action();
      }
    });
  }));

  // Cập nhật tooltip
  function augmentTitles(){
    if (modeBtn)  modeBtn.title  = (diagnosticMode ? 'Chế độ: Diagnose' : 'Chế độ: Chat') + ' (Ctrl+D)';
    if (thinkBtn) thinkBtn.title = 'Think / Pro (Ctrl+T)';
    if (micBtn)   micBtn.title   = 'Ghi âm (Ctrl+M)';
    if (newChatBtn) newChatBtn.title = 'Cuộc trò chuyện mới (Ctrl+N)';
    if (fileInputEl){
      // Nút paperclip là action-btn đầu tiên
      const attachBtn = document.querySelector('#tool-buttons .action-btn:first-child');
      if (attachBtn) attachBtn.title = 'Đính kèm ảnh (Ctrl+U)';
      fileInputEl.title = 'Đính kèm ảnh (Ctrl+U)';
    }
    const sendBtn = document.getElementById('send-btn');
    if (sendBtn) sendBtn.title = 'Gửi (Enter) – Xuống dòng: Shift+Enter';
  }
  document.addEventListener('DOMContentLoaded', augmentTitles);
})();
// ------------------------------
// End Keyboard & Shortcuts
// ------------------------------

        /* Sidebar resize logic */
        const sidebar = document.getElementById('sidebar');
        const resizer = document.getElementById('resizer');

        const mouseMoveHandler = function (e) {
            const dx = e.clientX - sidebar.getBoundingClientRect().right;
            const newWidth = sidebar.offsetWidth + dx;
            document.documentElement.style.setProperty('--sidebar-width', `${newWidth}px`);
        };

        const mouseUpHandler = function () {
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            document.body.style.cursor = 'default';
            document.body.style.userSelect = 'auto';
        };

        resizer.addEventListener('mousedown', function (e) {
            e.preventDefault();
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        const sidebarEl = document.getElementById('sidebar');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        const historyDrawerToggle = document.getElementById('history-drawer-toggle');

        function isMobileView() { return window.innerWidth <= 600; }

        function openSidebarMobile() {
          sidebarEl.classList.add('mobile-open');
          sidebarBackdrop.classList.add('show');
          syncHistoryArrow();
        }
        function closeSidebarMobile() {
          sidebarEl.classList.remove('mobile-open');
          sidebarBackdrop.classList.remove('show');
          syncHistoryArrow();
        }
        function syncHistoryArrow() {
          if (!isMobileView()) { historyDrawerToggle.style.display='none'; return; }
          historyDrawerToggle.style.display='flex';
          if (!historyDrawerToggle.querySelector('.bars')) {
             historyDrawerToggle.innerHTML =
               '<span class="bars" aria-hidden="true"><span class="bar"></span><span class="bar"></span><span class="bar"></span></span>';
          }
          if (sidebarEl.classList.contains('mobile-open')) {
             historyDrawerToggle.classList.add('open');
          } else {
             historyDrawerToggle.classList.remove('open');
          }
        }

        historyDrawerToggle.addEventListener('click', () => {
          if (sidebarEl.classList.contains('mobile-open')) closeSidebarMobile();
          else openSidebarMobile();
        });
        sidebarBackdrop.addEventListener('click', closeSidebarMobile);

        // Đồng bộ khi resize
        window.addEventListener('resize', syncHistoryArrow);
        document.addEventListener('DOMContentLoaded', syncHistoryArrow);
        // End of mobile additions

        function toggleToolTray(e){
          e?.preventDefault();
          const tray = document.getElementById('tool-buttons');
          const btn = document.getElementById('toggle-tools-btn');
          if (!tray || !btn) return;
          const opening = tray.classList.contains('collapsed');
          tray.classList.toggle('collapsed', !opening);
          btn.classList.toggle('active', opening);
          btn.setAttribute('aria-expanded', opening ? 'true' : 'false');

          if (opening) {
            const closeHandler = (ev)=>{
              if (!tray.contains(ev.target) && ev.target !== btn) {
                tray.classList.add('collapsed');
                btn.classList.remove('active');
                btn.setAttribute('aria-expanded','false');
                document.removeEventListener('click', closeHandler);
              }
            };
            setTimeout(()=>document.addEventListener('click', closeHandler),0);
          }
        }

        // Nếu muốn auto đóng sau khi gửi tin nhắn:
        const originalSubmitData = submitData;
        submitData = async function(){
          const tray = document.getElementById('tool-buttons');
          const btn = document.getElementById('toggle-tools-btn');
          if (tray && !tray.classList.contains('collapsed')) {
            tray.classList.add('collapsed');
            btn.classList.remove('active');
          }
          return originalSubmitData();
        };
     </script>
     <script>
/* === 3D Tilt Effect Script ===
   Áp dụng cho: đăng nhập / đăng xuất / xóa lịch sử (auth-btn),
   nút Diagnose (#mode-btn), Jaremis Pro (#think-btn),
   đính kèm file (paperclip – nút action-btn đầu tiên trong #tool-buttons),
   ghi âm (#mic-btn).
   Muốn thêm send: thêm '#send-btn' vào SELECTORS.
*/
(function(){
  const SELECTORS = [
    '.auth-controls .auth-btn',        // đăng nhập / đăng ký / đăng xuất / xóa lịch sử
    '#mode-btn',                       // Diagnose toggle
    '#think-btn',                      // Jaremis Pro
    '#mic-btn',                        // Mic
    '#tool-buttons .action-btn:first-child', // Paperclip
    '.new-chat-btn',                   // "Cuộc trò chuyện mới"
    '#send-btn',                       // Gửi
    '.btn-primary',                    // Nút Đăng nhập / Đăng ký
    '.btn-ghost'                       // Nút Hủy
  ];
  const MAX_TILT = 14;
  const PERSPECTIVE = 800;
  function applyTilt(el){
    if(!el || el.dataset.tiltApplied) return;
    el.dataset.tiltApplied = '1';
    el.classList.add('tilt-3d');
    function move(e){
      const rect = el.getBoundingClientRect();
      const x = (e.clientX - rect.left)/rect.width;
      const y = (e.clientY - rect.top)/rect.height;
      const rotX = (0.5 - y) * (MAX_TILT * 2);
      const rotY = (x - 0.5) * (MAX_TILT * 2);
      el.style.setProperty('--mx', (x*100).toFixed(2)+'%');
      el.style.setProperty('--my', (y*100).toFixed(2)+'%');
      el.style.transform = `perspective(${PERSPECTIVE}px) rotateX(${rotX}deg) rotateY(${rotY}deg) translateZ(6px)`;
      el.style.setProperty('--glow-o','1');
    }
    function leave(){
      el.style.transform = `perspective(${PERSPECTIVE}px) rotateX(0deg) rotateY(0deg) translateZ(0)`;
      el.style.setProperty('--glow-o','0');
    }
    el.addEventListener('mousemove', move);
    el.addEventListener('mouseenter', move);
    el.addEventListener('mouseleave', leave);
    el.addEventListener('touchmove', (e)=>{
      const t = e.touches[0];
      move(t);
    }, {passive:true});
    el.addEventListener('touchend', leave);
  }
  function scan(){
    SELECTORS.forEach(sel=>{
      document.querySelectorAll(sel).forEach(applyTilt);
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    scan();
    // Quan sát auth-controls vì nút được tạo động
    const auth = document.querySelector('.auth-controls');
    if(auth){
      new MutationObserver(scan).observe(auth,{childList:true,subtree:true});
    }
  });
})();
</script>
<script>
// ================= REALISTIC SNOW v2 (restored) =================
(function(){
  const canvas = document.getElementById('snow-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const CONFIG = {
    density: 0.11,
    globalSpeed: 1.0,
    windOscAmp: 0.55,
    windOscSpeed: 0.06,
    perParticleSway: 0.35,
    maxDrift: 0.35,
    fadeIn: true
  };
  const LAYERS = [
    { name:'far',  size:[0.6,1.4], speedY:[14,24], alpha:[0.15,0.35], blur:0,   countRatio:0.40 },
    { name:'mid',  size:[1.0,2.2], speedY:[22,38], alpha:[0.22,0.55], blur:0.5, countRatio:0.38 },
    { name:'near', size:[1.8,3.4], speedY:[34,58], alpha:[0.30,0.75], blur:0.9, countRatio:0.22 }
  ];
  let W=0,H=0, particles=[];
  let lastTime = performance.now();
  let windBase = 0;
  function rand(a,b){ return Math.random()*(b-a)+a; }
  function resize(){
    W = canvas.width  = canvas.offsetWidth  = canvas.parentElement.offsetWidth;
    H = canvas.height = canvas.offsetHeight = canvas.parentElement.offsetHeight;
    buildParticles();
  }
  window.addEventListener('resize', throttle(resize,250));
  resize();
  function totalCount(){ return Math.round((W*H/1000) * CONFIG.density); }
  function buildParticles(){
    particles.length = 0;
    const total = totalCount();
    LAYERS.forEach(layer=>{
      const need = Math.round(total * layer.countRatio);
      for(let i=0;i<need;i++){
        particles.push(makeParticle(layer, Math.random()*W, Math.random()*H));
      }
    });
  }
  function makeParticle(layer,x,y){
    const speedY = rand(layer.speedY[0], layer.speedY[1]) / 60 * CONFIG.globalSpeed;
    const r = rand(layer.size[0], layer.size[1]);
    return {
      layer,x,y,r,
      baseVy: speedY,
      alpha: rand(layer.alpha[0], layer.alpha[1]),
      swayOffset: Math.random()*Math.PI*2,
      swaySpeed: rand(0.4,1.1),
      driftSeed: Math.random()*1000,
      life:0,
      blur:layer.blur
    };
  }
  function update(dt){
    windBase += CONFIG.windOscSpeed * dt;
    const globalWind = Math.sin(windBase) * CONFIG.windOscAmp;
    for(let p of particles){
      p.life += dt;
      const sway = Math.sin(p.swayOffset + p.life * p.swaySpeed) * CONFIG.perParticleSway;
      const drift = (Math.sin((p.driftSeed + p.life*30)*0.015)+Math.sin((p.driftSeed + p.life*55)*0.011))*0.5*CONFIG.maxDrift;
      p.x += (globalWind + sway + drift) * (0.6 + (p.r*0.12));
      p.y += p.baseVy * dt * 60;
      if(p.x > W+8) p.x = -8;
      else if(p.x < -8) p.x = W+8;
      if(p.y > H+10){
        p.x = Math.random()*W;
        p.y = rand(-40,-10);
        p.life = 0;
        p.baseVy = rand(p.layer.speedY[0], p.layer.speedY[1]) / 60 * CONFIG.globalSpeed;
        p.r = rand(p.layer.size[0], p.layer.size[1]);
        p.alpha = rand(p.layer.alpha[0], p.layer.alpha[1]);
      }
    }
  }
  function draw(){
    ctx.clearRect(0,0,W,H);
    for(let layer of LAYERS){
      ctx.save();
      for(let p of particles){
        if(p.layer !== layer) continue;
        const a = CONFIG.fadeIn ? Math.min(p.alpha, p.alpha*(p.life*0.6)) : p.alpha;
        ctx.globalAlpha = a;
        if(p.blur>0){
          ctx.shadowBlur = p.blur*8;
          ctx.shadowColor = 'rgba(255,255,255,'+a+')';
        } else ctx.shadowBlur = 0;
        ctx.beginPath();
        ctx.fillStyle = '#fff';
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
    }
  }
  function loop(now){
    const dt = Math.min(0.07, (now - lastTime)/1000);
    lastTime = now;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
  function throttle(fn, ms){
    let t=0;
    return function(...args){
      if(performance.now()-t>ms){ t=performance.now(); fn.apply(this,args); }
    };
  }
})();
</script>
<script>
// ==== FIND MODAL (Word-like) ====
let findMatches = [];
let currentFindIndex = -1;
let lastFindQuery = '';
let findObserver = null;

function openFindModal(){
  const b = document.getElementById('find-backdrop');
  if(!b) return;
  b.style.display='flex';
  const inp = document.getElementById('find-query');
  setTimeout(()=>inp.focus(),30);
  if(lastFindQuery){ inp.value = lastFindQuery; performFind(lastFindQuery); }
}
function closeFindModal(){
  const b = document.getElementById('find-backdrop');
  if(b) b.style.display='none';
  clearFindHighlights();
}
document.addEventListener('keydown', e=>{
  if(e.key==='Escape'){
    const b=document.getElementById('find-backdrop');
    if(b && b.style.display!=='none'){ closeFindModal(); }
  }
});

function performFind(q){
  lastFindQuery = q;
  clearFindHighlights(true);
  if(!q){
    updateFindCount();
    return;
  }
  const caseSensitive = document.getElementById('find-case')?.checked;
  let re;
  try { re = new RegExp(escapeRegExp(q), caseSensitive?'g':'gi'); } catch(_){ return; }
  const container = document.getElementById('chat-messages');
  if(!container) return;

  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {
    acceptNode: n=>{
      if(!n.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
      if(n.parentElement && n.parentElement.classList.contains('find-highlight')) return NodeFilter.FILTER_REJECT;
      return NodeFilter.FILTER_ACCEPT;
    }
  });
  const nodes=[];
  while(walker.nextNode()) nodes.push(walker.currentNode);

  nodes.forEach(node=>{
    const txt = node.nodeValue;
    let m,last=0,frag=document.createDocumentFragment(),found=false;
    re.lastIndex=0;
    while((m = re.exec(txt))!==null){
      found=true;
      const pre = txt.slice(last,m.index);
      if(pre) frag.appendChild(document.createTextNode(pre));
      const span = document.createElement('span');
      span.className='find-highlight';
      span.textContent=m[0];
      frag.appendChild(span);
      findMatches.push(span);
      last = m.index + m[0].length;
      if(m[0].length===0) re.lastIndex++;
    }
    if(found){
      const rest = txt.slice(last);
      if(rest) frag.appendChild(document.createTextNode(rest));
      node.parentNode.replaceChild(frag,node);
    }
  });

  currentFindIndex = findMatches.length?0:-1;
  activateCurrentMatch();
  updateFindCount();

  if(findObserver) findObserver.disconnect();
  if(q){
    findObserver = new MutationObserver(()=>{
      const qq = lastFindQuery;
      if(qq) performFind(qq);
    });
    findObserver.observe(container,{childList:true,subtree:true});
  }
}

function findNext(){
  if(!findMatches.length){
    performFind(document.getElementById('find-query').value.trim());
    return;
  }
  currentFindIndex = (currentFindIndex+1) % findMatches.length;
  activateCurrentMatch();
  updateFindCount();
}
function findPrev(){
  if(!findMatches.length){
    performFind(document.getElementById('find-query').value.trim());
    return;
  }
  currentFindIndex = (currentFindIndex-1 + findMatches.length) % findMatches.length;
  activateCurrentMatch();
  updateFindCount();
}

function activateCurrentMatch(){
  findMatches.forEach(s=>s.classList.remove('active'));
  if(currentFindIndex>=0 && findMatches[currentFindIndex]){
    const el = findMatches[currentFindIndex];
    el.classList.add('active');
    const container = document.getElementById('chat-messages');
    const rect = el.getBoundingClientRect();
    const cRect = container.getBoundingClientRect();
    const scrollTo = rect.top - cRect.top + container.scrollTop - (container.clientHeight/2) + rect.height/2;
    container.scrollTo({ top: scrollTo, behavior:'smooth' });
  }
}

function updateFindCount(){
  const el = document.getElementById('find-count');
  if(!el) return;
  if(!findMatches.length) el.textContent='0 / 0';
  else el.textContent=(currentFindIndex+1)+' / '+findMatches.length;
}

function clearFindHighlights(keepObs){
  if(findObserver && !keepObs){ findObserver.disconnect(); findObserver=null; }
  if(!findMatches.length) return;
  findMatches.forEach(span=>{
    if(span.parentNode){
      span.parentNode.replaceChild(document.createTextNode(span.textContent), span);
    }
  });
  findMatches=[];
  currentFindIndex=-1;
  updateFindCount();
}

function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

document.addEventListener('DOMContentLoaded', ()=>{
  const q=document.getElementById('find-query');
  if(q){
    q.addEventListener('input', e=>performFind(e.target.value.trim()));
    q.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        if(e.shiftKey) findPrev(); else findNext();
      }
    });
  }
  const c=document.getElementById('find-case');
  if(c){ c.addEventListener('change', ()=>performFind(q.value.trim())); }
});
</script>
</body>
</html>
